
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://osg-htc.org/networking/personas/quick-deploy/install-perfsonar-testpoint/">
      
      
        <link rel="prev" href="../landing/">
      
      
        <link rel="next" href="../install-perfsonar-toolkit/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Install Testpoint (Container) - OSG Networking Area</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-69012-29"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-69012-29",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-69012-29",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#installing-a-perfsonar-testpoint-for-wlcgosg" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="OSG Networking Area" class="md-header__button md-logo" aria-label="OSG Networking Area" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OSG Networking Area
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Install Testpoint (Container)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/osg-htc/networking/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../landing/" class="md-tabs__link">
          
  
  
  Get Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../perfsonar-in-osg/" class="md-tabs__link">
          
  
  
  perfSONAR Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../perfsonar/tools_scripts/fasterdata-tuning/" class="md-tabs__link">
          
  
  
  Host Tuning

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshoot/triage-checklist/" class="md-tabs__link">
          
  
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../perfsonar/psetf/" class="md-tabs__link">
          
  
  
  Network Services & Data

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../perfsonar/tools_scripts/" class="md-tabs__link">
          
  
  
  Tools & Scripts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../features/fail2ban/" class="md-tabs__link">
          
  
  
  Advanced

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="OSG Networking Area" class="md-nav__button md-logo" aria-label="OSG Networking Area" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OSG Networking Area
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/osg-htc/networking/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Get Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Get Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy perfSONAR
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshoot Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../research/landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Understand the System
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    perfSONAR Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    perfSONAR Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar-in-osg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why perfSONAR in OSG/WLCG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/deployment-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Installation Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Installation Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy perfSONAR
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Install Testpoint (Container)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Testpoint (Container)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites-and-planning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites and Planning
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#existing-perfsonar-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Existing perfSONAR configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-install-and-harden-el9" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1 – Install and Harden EL9
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-choose-your-deployment-path" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2 – Choose Your Deployment Path
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2 – Choose Your Deployment Path">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-a-orchestrated-guided-install-recommended-for-new-deployments" class="md-nav__link">
    <span class="md-ellipsis">
      
        Path A: Orchestrated Guided Install (Recommended for New Deployments)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#path-b-manual-step-by-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        Path B: Manual Step-by-Step
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Path B: Manual Step-by-Step">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-21-install-base-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2.1 – Install Base Packages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-22-bootstrap-helper-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2.2 – Bootstrap Helper Scripts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-configure-policy-based-routing-pbr" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3 – Configure Policy-Based Routing (PBR)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3 – Configure Policy-Based Routing (PBR)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safety-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Safety Enhancements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-config-file-automatically-or-preview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generate config file automatically (or preview)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-changes-in-place-default" class="md-nav__link">
    <span class="md-ellipsis">
      
        Apply changes (in-place default)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Apply changes (in-place default)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#in-place-apply-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        In-place apply (recommended)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#full-rebuild-destructive-removes-all-nm-connections-first" class="md-nav__link">
    <span class="md-ellipsis">
      
        Full rebuild (destructive – removes all NM connections first)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-forward-and-reverse-entries-required" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS: forward and reverse entries (required)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-configure-nftables-selinux-and-fail2ban" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4 – Configure nftables, SELinux, and Fail2Ban
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 4 – Configure nftables, SELinux, and Fail2Ban">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installconfigure-the-desired-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install/configure the desired options
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confirm-nftables-state-and-security-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Confirm nftables state and security services
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-deploy-the-containerized-perfsonar-testpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5 – Deploy the Containerized perfSONAR Testpoint
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 5 – Deploy the Containerized perfSONAR Testpoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-a-testpoint-only-simplest" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option A — Testpoint only (simplest)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Option A — Testpoint only (simplest)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-seed-required-host-directories-required-before-first-compose-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        1) Seed required host directories (REQUIRED before first compose up)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-deploy-the-container" class="md-nav__link">
    <span class="md-ellipsis">
      
        2) Deploy the container
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-ensure-containers-restart-automatically-on-reboot-systemd-unit-for-testpoint-required" class="md-nav__link">
    <span class="md-ellipsis">
      
        3) Ensure containers restart automatically on reboot (systemd unit for testpoint - REQUIRED)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-b-testpoint-lets-encrypt-shared-apache-and-certs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option B — Testpoint + Let's Encrypt (shared Apache and certs)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Option B — Testpoint + Let&#39;s Encrypt (shared Apache and certs)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-seed-required-host-directories-required-before-first-compose-up_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1) Seed required host directories (REQUIRED before first compose up)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-deploy-the-testpoint-with-automatic-ssl-patching-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        2) Deploy the testpoint with automatic SSL patching (recommended)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-containers-restart-automatically-on-reboot-systemd-units-for-testpoint-certbot-required" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ensure containers restart automatically on reboot (systemd units for testpoint &amp; certbot - REQUIRED)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-obtain-your-first-lets-encrypt-certificate-one-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        3) Obtain your first Let's Encrypt certificate (one-time)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-restart-the-certbot-sidecar-for-automatic-renewals" class="md-nav__link">
    <span class="md-ellipsis">
      
        4) Restart the certbot sidecar for automatic renewals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-configure-and-enroll-in-psconfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 6 – Configure and Enroll in pSConfig
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-register-and-configure-with-wlcgosg" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 7 – Register and Configure with WLCG/OSG
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-post-install-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 8 – Post-Install Validation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ongoing-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ongoing Maintenance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#container-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Container Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#networking-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Networking Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certificate-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Certificate Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perfsonar-service-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        perfSONAR Service Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-update-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auto-Update Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#general-debugging-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        General Debugging Tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../install-perfsonar-toolkit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Toolkit (RPM)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automated-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automated Setup
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Legacy Installation (Archive)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Host Tuning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Host Tuning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/fasterdata-tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fasterdata Host Tuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/multiple-nic-guidance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multiple NIC Guidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/packet-pacing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Packet Pacing (fq vs tbf)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Troubleshooting
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/triage-checklist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Triage Checklist
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../network-troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Troubleshooting Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../network-troubleshooting/osg-debugging-document/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OSG Debugging Document
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Playbooks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Playbooks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/container-startup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Container Startup Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/tests-not-running/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tests Not Running
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/performance-issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/firewall-issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firewall & Network Access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Network Services & Data
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Network Services & Data
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/psetf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Infrastructure Monitoring (PSETF)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../osg-network-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Datastore
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../osg-network-analytics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Analytics Platform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tools & Scripts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tools & Scripts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/fasterdata-tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fasterdata Host Tuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/README-lsregistration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LS Registration Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/perfSONAR-update-lsregistration.sh" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LS Registration Updater
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/docker-compose.yml" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compose Bundles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Link-Check Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Security Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Security Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/fail2ban/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fail2ban
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/selinux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SELinux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/nftables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    nftables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../research/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Release Notes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Release Notes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.4.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.4.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.3.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.3.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.1.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.1.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.0.1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.0.1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.0.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.0.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../web-site-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Site Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../../perfsonar-in-osg/" class="md-path__link">
          
  <span class="md-ellipsis">
    perfSONAR Guides
  </span>

        </a>
      </li>
    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../landing/" class="md-path__link">
          
  <span class="md-ellipsis">
    Installation Guides
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="installing-a-perfsonar-testpoint-for-wlcgosg">Installing a perfSONAR Testpoint for WLCG/OSG<a class="headerlink" href="#installing-a-perfsonar-testpoint-for-wlcgosg" title="Permanent link">&para;</a></h1>
<!-- markdownlint-disable MD040 -->

<p>This guide walks WLCG/OSG site administrators through end-to-end installation, configuration, and validation of a
perfSONAR testpoint on Enterprise Linux 9 (EL9). It uses automated tooling from this repository to streamline the
process while accommodating site-specific requirements.</p>
<hr />
<h2 id="prerequisites-and-planning">Prerequisites and Planning<a class="headerlink" href="#prerequisites-and-planning" title="Permanent link">&para;</a></h2>
<p>Before you begin, it may be helpful to gather the following information:</p>
<ul>
<li>
<p><strong>Hardware details:</strong> hostname, BMC/iLO/iDRAC credentials (if used), interface names, available storage locations.</p>
</li>
<li>
<p><strong>Network data:</strong> IPv4/IPv6 assignments for each NIC, default gateway, internal/external VLAN
  information.</p>
</li>
<li>
<p><strong>Operational contacts:</strong> site admin email, OSG facility/site name, latitude/longitude.</p>
</li>
</ul>
<h2 id="existing-perfsonar-configuration">Existing perfSONAR configuration<a class="headerlink" href="#existing-perfsonar-configuration" title="Permanent link">&para;</a></h2>
<p>If replacing an existing instance, you may want to back up <code>/etc/perfsonar/</code> files, especially
<code>lsregistrationdaemon.conf</code>, and any container volumes. We have a script named<code>perfSONAR-update-lsregistration.sh</code> to
extract/save/restore registration config that you may want to use.</p>
<details class="info">
<summary>Quick capture of existing lsregistration config (if you have a prior installation)</summary>
<p>Download a temp copy: <br />
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/perfSONAR-update-lsregistration.sh<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span>/tmp/update-lsreg.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/update-lsreg.sh
</code></pre></div></p>
<p><strong>For container-based installations (testpoint):</strong>
<div class="highlight"><pre><span></span><code>/tmp/update-lsreg.sh<span class="w"> </span>extract<span class="w"> </span>--output<span class="w"> </span>/root/restore-lsreg.sh
</code></pre></div></p>
<p><strong>For RPM-based/local installations (toolkit or older hosts):</strong>
<div class="highlight"><pre><span></span><code>/tmp/update-lsreg.sh<span class="w"> </span>extract<span class="w"> </span>--output<span class="w"> </span>/root/restore-lsreg.sh<span class="w"> </span>--local
</code></pre></div></p>
<p>Note: Repository clone instructions are in Step 2.
<strong>Note:</strong> All shell commands assume an interactive root shell.</p>
</details>
<hr />
<h2 id="step-1-install-and-harden-el9">Step 1 – Install and Harden EL9<a class="headerlink" href="#step-1-install-and-harden-el9" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>Provision EL9:</strong> Install AlmaLinux, Rocky Linux, or RHEL 9 with the <em>Minimal</em> profile.</p>
</li>
<li>
<p><strong>Set the hostname and time sync:</strong> Pick the NIC that will own the default route for the hostname.</p>
<div class="highlight"><pre><span></span><code>hostnamectl<span class="w"> </span>set-hostname<span class="w"> </span>&lt;testpoint-hostname&gt;
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>chronyd
timedatectl<span class="w"> </span>set-timezone<span class="w"> </span>&lt;Region/City&gt;
</code></pre></div>
</li>
<li>
<p><strong>Disable unused services:</strong></p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>disable<span class="w"> </span>--now<span class="w"> </span>firewalld<span class="w"> </span>NetworkManager-wait-online

Keep<span class="w"> </span><span class="sb">`</span>NetworkManager<span class="sb">`</span><span class="w"> </span>running.<span class="w"> </span>The<span class="w"> </span><span class="nb">command</span><span class="w"> </span>above<span class="w"> </span>disables<span class="w"> </span>only<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span>NetworkManager-wait-online<span class="sb">`</span><span class="w"> </span>unit<span class="w"> </span>to<span class="w"> </span>prevent
long<span class="w"> </span>boot<span class="w"> </span>delays<span class="w"> </span><span class="k">while</span><span class="w"> </span>containers<span class="w"> </span>and<span class="w"> </span>policy-based<span class="w"> </span>routing<span class="w"> </span>come<span class="w"> </span>up.<span class="w"> </span>If<span class="w"> </span>your<span class="w"> </span>site<span class="w"> </span>depends<span class="w"> </span>on
<span class="sb">`</span>network-online.target<span class="sb">`</span><span class="w"> </span><span class="o">(</span><span class="k">for</span><span class="w"> </span>example,<span class="w"> </span>iSCSI/NFS<span class="w"> </span>root<span class="w"> </span>or<span class="w"> </span>bonded<span class="w"> </span>links<span class="w"> </span>that<span class="w"> </span>must<span class="w"> </span>be<span class="w"> </span>up<span class="w"> </span>before<span class="w"> </span>services<span class="w"> </span>start<span class="o">)</span>,<span class="w"> </span>leave
<span class="sb">`</span>NetworkManager-wait-online<span class="sb">`</span><span class="w"> </span>enabled.
dnf<span class="w"> </span>remove<span class="w"> </span>-y<span class="w"> </span>rsyslog
</code></pre></div>
<details class="info">
<summary>Why disable unused services?</summary>
<p>We recommend disabling unused services during initial provisioning to reduce complexity and avoid unexpected
interference with network and container setup. Services such as <code>firewalld</code>, <code>NetworkManager-wait-online</code>, and <code>rsyslog</code>
can alter networking state, hold boot or network events, or conflict with the automated nftables/NetworkManager changes
performed by the helper scripts. Disabling non-essential services makes the install deterministic, reduces the host
attack surface, and avoids delays or race conditions while configuring policy-based routing, nftables rules, and      <br />
container networking.</p>
</details>
</li>
<li>
<p><strong>Update the system:</strong></p>
<p><code>bash
dnf -y update</code></p>
</li>
<li>
<p><strong>Record NIC names:</strong> Document interface mappings for later PBR configuration.</p>
<div class="highlight"><pre><span></span><code>nmcli<span class="w"> </span>device<span class="w"> </span>status
ip<span class="w"> </span>-br<span class="w"> </span>addr
</code></pre></div>
</li>
</ol>
<hr />
<h2 id="step-2-choose-your-deployment-path">Step 2 – Choose Your Deployment Path<a class="headerlink" href="#step-2-choose-your-deployment-path" title="Permanent link">&para;</a></h2>
<p>After completing Step 1 (minimal OS hardening), you can proceed in one of two ways:</p>
<h3 id="path-a-orchestrated-guided-install-recommended-for-new-deployments">Path A: Orchestrated Guided Install (Recommended for New Deployments)<a class="headerlink" href="#path-a-orchestrated-guided-install-recommended-for-new-deployments" title="Permanent link">&para;</a></h3>
<p>The orchestrator automates package installation, bootstrap, PBR configuration, security hardening, container deployment,
certificate issuance, and pSConfig enrollment with interactive pauses (or non-interactive batch mode).</p>
<p><strong>Download and run the orchestrator:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/perfSONAR-orchestrator.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/perfSONAR-orchestrator.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/perfSONAR-orchestrator.sh
</code></pre></div>
<p><strong>Interactive mode</strong> (pause at each step, confirm/skip/quit):</p>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh
</code></pre></div>
<p><strong>Non-interactive mode</strong> (auto-confirm all steps):</p>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh<span class="w"> </span>--non-interactive<span class="w"> </span>--option<span class="w"> </span>A
</code></pre></div>
<p><strong>With Let's Encrypt (Option B):</strong></p>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh<span class="w"> </span>--option<span class="w"> </span>B<span class="w"> </span>--fqdn<span class="w"> </span>&lt;FQDN&gt;<span class="w"> </span>--email<span class="w"> </span>&lt;EMAIL&gt;
</code></pre></div>
<p><strong>Flags:</strong></p>
<ul>
<li><code>--option {A|B}</code> — <strong>Deployment mode:</strong> A = testpoint only (default); B = testpoint with Let's Encrypt certificate automation</li>
<li><code>--fqdn NAME</code> — primary FQDN for certificates (required for <code>--option B</code>)</li>
<li><code>--email ADDRESS</code> — email for Let's Encrypt notifications (required for <code>--option B</code>)</li>
<li><code>--non-interactive</code> — skip pauses, auto-confirm</li>
<li><code>--yes</code> — auto-confirm internal script prompts</li>
<li><code>--dry-run</code> — preview steps without executing</li>
<li><code>--auto-update</code> — install and enable a daily systemd timer that pulls new container images and restarts services <strong>only when the image digest has changed</strong> (runs <code>install-systemd-units.sh --auto-update</code>, placing <code>perfSONAR-auto-update.sh</code> in <code>/usr/local/bin/</code>)  <blockquote>
<p><strong>Note:</strong> Uses image digest comparison, not Docker-specific output strings, so it works correctly with Podman.</p>
</blockquote>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Paths vs. Orchestrator Options</p>
<p><strong>Paths = how you install the testpoint</strong>
- <strong>Path A (Automated Install Path)</strong>: Use the orchestrator script (guided/automated).
- <strong>Path B (Manual Install Path)</strong>: Follow the manual, step-by-step commands.</p>
<p><strong>Orchestrator Options = what the orchestrator deploys</strong> (only used when you choose Path A)
- <strong>Option A</strong>: Testpoint only (no automatic certificate management)
- <strong>Option B</strong>: Testpoint with Let's Encrypt automation (requires <code>--fqdn</code> and <code>--email</code>)</p>
<p>Remember: choose Path A or Path B first. If you pick Path A, then choose Option A or B for certificate handling.</p>
</div>
<!-- markdownlint-disable-next-line MD051 -->
<p><strong>If you choose this path, skip to <a href="#step-7-register-and-configure-with-wlcgosg">Step 7</a></strong> (the orchestrator completes Steps 2–6 for you).</p>
<hr />
<h3 id="path-b-manual-step-by-step">Path B: Manual Step-by-Step<a class="headerlink" href="#path-b-manual-step-by-step" title="Permanent link">&para;</a></h3>
<p>For users who prefer granular control or need to customize each stage, continue with manual package installation,
bootstrap, and configuration.</p>
<h4 id="step-21-install-base-packages">Step 2.1 – Install Base Packages<a class="headerlink" href="#step-21-install-base-packages" title="Permanent link">&para;</a></h4>
<p>On minimal hosts several required tools (e.g. <code>dig</code>, <code>nft</code>, <code>podman-compose</code>) are missing. Install all recommended
prerequisites in one command:</p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>podman<span class="w"> </span>podman-docker<span class="w"> </span>podman-compose<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>jq<span class="w"> </span>curl<span class="w"> </span>tar<span class="w"> </span>gzip<span class="w"> </span>rsync<span class="w"> </span>bind-utils<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>nftables<span class="w"> </span>fail2ban<span class="w"> </span>policycoreutils-python-utils<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python3<span class="w"> </span>iproute<span class="w"> </span>iputils<span class="w"> </span>procps-ng<span class="w"> </span>sed<span class="w"> </span>grep<span class="w"> </span>gawk
</code></pre></div>
<p>This ensures all subsequent steps (PBR generation, DNS checks, firewall hardening, container deployment) have their dependencies available.</p>
<h4 id="step-22-bootstrap-helper-scripts">Step 2.2 – Bootstrap Helper Scripts<a class="headerlink" href="#step-22-bootstrap-helper-scripts" title="Permanent link">&para;</a></h4>
<p>Use the bootstrap script to install helper scripts under <code>/opt/perfsonar-tp/tools_scripts</code>:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install_tools_scripts.sh

chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install_tools_scripts.sh

/tmp/install_tools_scripts.sh<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<p><strong>Verify bootstrap completed successfully:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check that all helper scripts were downloaded</span>
ls<span class="w"> </span>-1<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/*.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
<span class="c1"># Should show 11 shell scripts</span>

<span class="c1"># Verify key scripts are present and executable</span>
ls<span class="w"> </span>-l<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/<span class="o">{</span>perfSONAR-pbr-nm.sh,perfSONAR-install-nftables.sh,perfSONAR-orchestrator.sh<span class="o">}</span>
</code></pre></div>
<hr />
<h2 id="step-3-configure-policy-based-routing-pbr">Step 3 – Configure Policy-Based Routing (PBR)<a class="headerlink" href="#step-3-configure-policy-based-routing-pbr" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
<p>The orchestrator automates PBR configuration. If you ran it in Step 2, skip to <a href="#step-4-configure-nftables-selinux-and-fail2ban">Step 4</a>.</p>
</div>
<p>The script <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh</code> automates NetworkManager profiles and routing rule
setup. It fills out and consumes the network configuration in <code>/etc/perfSONAR-multi-nic-config.conf</code>.</p>
<details class="info">
<summary>Modes of operation</summary>
<p>By default the script now performs an <strong>in-place apply</strong> that adjusts routes, rules, and NetworkManager connection
properties <strong>without deleting existing connections or flushing all system routes</strong>. This minimizes disruption and
usually avoids the need for a reboot.</p>
<p>An optional destructive mode <code>--rebuild-all</code> performs the original full workflow: backup existing profiles, flush all
routes and rules, remove every NetworkManager connection, then recreate connections from scratch. Use this only for
initial deployments or when you must completely reset inconsistent legacy state.</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Flag</th>
<th>Disruption</th>
<th>When to use</th>
</tr>
</thead>
<tbody>
<tr>
<td>In-place (default)</td>
<td>(none) or <code>--apply-inplace</code></td>
<td>Low (interfaces stay up; rules adjusted)</td>
<td>Routine updates, gateway changes, add routes</td>
</tr>
<tr>
<td>Full rebuild</td>
<td><code>--rebuild-all</code></td>
<td>High (connections removed; brief connectivity drop)</td>
<td>First-time setup, severe misconfiguration</td>
</tr>
</tbody>
</table>
</details>
<h3 id="safety-enhancements">Safety Enhancements<a class="headerlink" href="#safety-enhancements" title="Permanent link">&para;</a></h3>
<ul>
<li>Detects active SSH session interface and avoids extra disruption to that NIC in in-place mode.</li>
<li>Prompts are still skipped with <code>--yes</code>.</li>
<li>Dry-run preview supported via <code>--dry-run</code> (combine with <code>--debug</code> for verbose output).</li>
<li>Reboot is <strong>no longer generally required</strong>; only consider one if NetworkManager fails to apply the new rules cleanly.</li>
</ul>
<h3 id="generate-config-file-automatically-or-preview">Generate config file automatically (or preview)<a class="headerlink" href="#generate-config-file-automatically-or-preview" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Gateways required for addresses</p>
<p>Any NIC with an IPv4 address must also have an IPv4 gateway, and any NIC with an IPv6 address must have an IPv6 gateway.
If the generator cannot detect a gateway, it adds a WARNING block to the generated file listing affected NICs. Edit
<code>NIC_IPV4_GWS</code>/<code>NIC_IPV6_GWS</code> accordingly before applying changes.</p>
</div>
<details class="note">
<summary>Gateway prompts</summary>
<p>During generation, the script attempts to detect gateways per-NIC. If a NIC has an IP address but no gateway could be
determined, it will prompt you interactively to enter an IPv4 and/or IPv6 gateway (or <code>-</code> to skip). Prompts are skipped
in non-interactive sessions or when you use <code>--yes</code>. Note, NICs without gateways are assumed to NOT be used for perfSONAR.</p>
</details>
<p>Preview generation (<strong>no changes</strong>):</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh<span class="w"> </span>--generate-config-debug<span class="w">    </span>
</code></pre></div>
<p>Generate and <strong>write</strong> the config file:</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh<span class="w"> </span>--generate-config-auto<span class="w"> </span>
</code></pre></div>
<p>The script writes the config file to <code>/etc/perfSONAR-multi-nic-config.conf</code>. Edit to adjust site-specific values (e.g.,
confirm <code>DEFAULT_ROUTE_NIC</code>, add <code>NIC_IPV4_ADDROUTE</code> entries) and verify the entries. Include every NIC/subnet that should
retain SSH access; the nftables helper derives allow-lists from this file.</p>
<p>Example: adding a management network alongside the data VLAN</p>
<div class="highlight"><pre><span></span><code><span class="nv">NIC_NAMES</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;bond0.2900&quot;</span>
<span class="w">    </span><span class="s2">&quot;bond0&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV4_ADDRS</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;192.41.236.32&quot;</span>
<span class="w">    </span><span class="s2">&quot;10.10.128.32&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV4_PREFIXES</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;/23&quot;</span>
<span class="w">    </span><span class="s2">&quot;/20&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV4_GWS</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;192.41.236.1&quot;</span>
<span class="w">    </span><span class="s2">&quot;10.10.128.1&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV4_ADDROUTE</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;-&quot;</span>
<span class="w">    </span><span class="s2">&quot;10.10.0.0/22&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV6_ADDRS</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;2001:48a8:68f7:8001:192:41:236:32&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV6_PREFIXES</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;/64&quot;</span>
<span class="o">)</span>

<span class="nv">NIC_IPV6_GWS</span><span class="o">=(</span>
<span class="w">    </span><span class="s2">&quot;2001:48a8:68f7:8001::1&quot;</span>
<span class="o">)</span>

<span class="nv">DEFAULT_ROUTE_NIC</span><span class="o">=</span><span class="s2">&quot;bond0.2900&quot;</span>
</code></pre></div>
<p>Use plain ASCII quotes and keep array lengths aligned across sections.</p>
<h3 id="apply-changes-in-place-default">Apply changes (in-place default)<a class="headerlink" href="#apply-changes-in-place-default" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Connect via console for network changes</p>
<p>When applying network changes across an ssh connection, your session may be interrupted.   Please try to run the
perfSONAR-pbr-nm.sh script when connected either directly to the console or by using 'nohup' in front of the script
invocation.</p>
</div>
<h4 id="in-place-apply-recommended">In-place apply (recommended)<a class="headerlink" href="#in-place-apply-recommended" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh<span class="w"> </span>--yes
</code></pre></div>
<details class="info">
<summary>If SSH connection drops during network reconfiguration:</summary>
<ol>
<li>Access via BMC/iLO/iDRAC console or physical console</li>
<li>Review <code>/var/log/perfSONAR-multi-nic-config.log</code> for errors</li>
<li>Check network state with <code>nmcli connection show</code> and <code>ip addr</code></li>
<li>Restore from backup if needed: backups are in <code>/var/backups/nm-connections-&lt;timestamp&gt;/</code></li>
<li>Reapply config after corrections: <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes</code></li>
</ol>
</details>
<h4 id="full-rebuild-destructive-removes-all-nm-connections-first">Full rebuild (destructive – removes all NM connections first)<a class="headerlink" href="#full-rebuild-destructive-removes-all-nm-connections-first" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh<span class="w"> </span>--rebuild-all<span class="w"> </span>--yes
</code></pre></div>
<p>The policy based routing script logs to <code>/var/log/perfSONAR-multi-nic-config.log</code>. After an in-place apply, a reboot is typically
unnecessary. If connectivity or rules appear inconsistent (<code>ip rule show</code> / <code>ip route</code> mismatch), consider a manual
NetworkManager restart:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>restart<span class="w"> </span>NetworkManager
</code></pre></div>
<h3 id="dns-forward-and-reverse-entries-required">DNS: forward and reverse entries (required)<a class="headerlink" href="#dns-forward-and-reverse-entries-required" title="Permanent link">&para;</a></h3>
<p>All IP addresses that will be used for perfSONAR testing MUST have DNS entries: a forward (A/AAAA) record and a matching
reverse (PTR) record. This is required so remote test tools and site operators can reliably reach and identify your
host, and because some measurement infrastructure and registration systems perform forward/reverse consistency checks.</p>
<ul>
<li>For single-stack IPv4-only hosts: ensure A and PTR are present and consistent.</li>
<li>For single-stack IPv6-only hosts: ensure AAAA and PTR are present and consistent.</li>
<li>For dual-stack hosts: both IPv4 and IPv6 addresses used for testing must have matching forward and reverse records (A+PTR and AAAA+PTR).</li>
</ul>
<details class="info">
<summary>Run the DNS checker</summary>
<p>To validate forward/reverse DNS for addresses in <code>/etc/perfSONAR-multi-nic-config.conf</code> you can run a script:
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/check-perfsonar-dns.sh
</code></pre></div>
<strong>Notes and automation tips:</strong></p>
<ul>
<li>The script above uses <code>dig</code> (bind-utils package) which is commonly available; you can adapt it
  to use <code>host</code> if preferred.</li>
<li>Run the check as part of your provisioning CI or as a pre-flight check before enabling measurement registration.</li>
<li>For large sites or many addresses, parallelize the checks (xargs -P) or use a small Python
  script that leverages <code>dns.resolver</code> for async checks.</li>
<li>If your PTR returns a hostname with a trailing dot, the script strips it before the forward check.</li>
</ul>
<p>If any addresses fail these checks, correct the DNS zone (forward and/or reverse) and allow DNS propagation before
proceeding with registration and testing.</p>
</details>
<p><strong>Verify the routing policy:</strong></p>
<div class="highlight"><pre><span></span><code>nmcli<span class="w"> </span>connection<span class="w"> </span>show
ip<span class="w"> </span>rule<span class="w"> </span>show
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span>&lt;table-id&gt;
</code></pre></div>
<p>Confirm that non-default interfaces have their own routing tables and that the default interface owns the system default
route.</p>
<hr />
<h2 id="step-4-configure-nftables-selinux-and-fail2ban">Step 4 – Configure nftables, SELinux, and Fail2Ban<a class="headerlink" href="#step-4-configure-nftables-selinux-and-fail2ban" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
<p>The orchestrator automates security hardening. If you ran it in Step 2, skip to <a href="#step-5-deploy-the-containerized-perfsonar-testpoint">Step 5</a>.</p>
</div>
<p>Use <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-install-nftables.sh</code> to configure a hardened nftables profile with
optional SELinux and Fail2Ban support. No staging or copy step is required.</p>
<p>Prerequisites (not installed by the script and should have been installed when check-deps.sh was run above):</p>
<ul>
<li>
<p><code>nftables</code> must already be installed and available (<code>nft</code> binary) for firewall configuration.</p>
</li>
<li>
<p><code>fail2ban</code> must be installed if you want the optional jail configuration.</p>
</li>
<li>
<p>SELinux tools (e.g., <code>getenforce</code>, <code>policycoreutils</code>) must be present to attempt SELinux configuration.</p>
</li>
</ul>
<p>If any prerequisite is missing, the script skips that component and continues.</p>
<h3 id="installconfigure-the-desired-options">Install/configure the desired options<a class="headerlink" href="#installconfigure-the-desired-options" title="Permanent link">&para;</a></h3>
<p>You can use the install script to install the options you want (selinux, fail2ban)</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/perfSONAR-install-nftables.sh<span class="w"> </span>--selinux<span class="w"> </span>--fail2ban<span class="w"> </span>--yes
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="o">-</span><span class="w"> </span><span class="nv">Use</span><span class="w"> </span>`<span class="o">--</span><span class="nv">yes</span>`<span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">skip</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">interactive</span><span class="w"> </span><span class="nv">confirmation</span><span class="w"> </span><span class="nv">prompt</span><span class="w"> </span><span class="ss">(</span><span class="nv">omit</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">prefer</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">review</span><span class="w"> </span><span class="nv">the</span>
<span class="w">  </span><span class="nv">summary</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">answer</span><span class="w"> </span><span class="nv">manually</span><span class="ss">)</span>.

<span class="o">-</span><span class="w"> </span><span class="nv">Add</span><span class="w"> </span>`<span class="o">--</span><span class="nv">dry</span><span class="o">-</span><span class="nv">run</span>`<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">rehearsal</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">only</span><span class="w"> </span><span class="nv">prints</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">planned</span><span class="w"> </span><span class="nv">actions</span>.
</code></pre></div>

<p>The script writes nftables rules for perfSONAR services, derives SSH allow-lists from <code>/etc/perfSONAR-multi-nic-
config.conf</code>, optionally adjusts SELinux, and enables Fail2ban jails—only if those components are already installed.</p>
<details class="info">
<summary>SSH allow-lists and validation</summary>
<ul>
<li><strong>Auto-detects current SSH clients:</strong> The script captures the IP address of your current SSH connection (via <code>$SSH_CONNECTION</code>) and active SSH connections (via <code>ss</code>) to ensure your SSH access is not interrupted when the firewall is applied.</li>
<li><strong>Derives allow-lists from config:</strong> In addition to auto-detection, derives SSH allow-lists from <code>/etc/perfSONAR-multi-nic-config.conf</code> (CIDR prefixes and addresses).</li>
<li><strong>Prevents lockout:</strong> By combining auto-detected clients with configured subnets, the script prevents accidental SSH lockout during deployment on multi-NIC systems.</li>
<li><strong>Validates nftables rules</strong> before writing.</li>
<li><strong>Outputs:</strong> rules to <code>/etc/nftables.d/perfsonar.nft</code>, log to <code>/var/log/perfSONAR-install-nftables.log</code>, backups to <code>/var/backups/</code>.</li>
<li><strong>Check logs:</strong> Review <code>/var/log/perfSONAR-install-nftables.log</code> to see the derived SSH allow-lists and confirm your current session was included.</li>
</ul>
</details>
<details class="tip">
<summary>Preview nftables rules before applying</summary>
<p>You can preview the fully rendered nftables rules (no changes are made):</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/perfSONAR-install-nftables.sh<span class="w"> </span>--print-rules
</code></pre></div>
</details>
<details class="tip">
<summary>Manually add extra management hosts/subnets</summary>
<p>If you need to allow additional SSH sources not represented by your NIC-derived prefixes, edit
<code>/etc/nftables.d/perfsonar.nft</code> and add entries to the appropriate sets. Example:</p>
<div class="highlight"><pre><span></span><code>set ssh_access_ip4_subnets {
    type ipv4_addr
    flags interval
    elements = { 192.0.2.0/24, 198.51.100.0/25 }
}

set ssh_access_ip4_hosts {
    type ipv4_addr
    elements = { 203.0.113.10, 203.0.113.11 }
}

set ssh_access_ip6_subnets {
    type ipv6_addr
    flags interval
    elements = { 2001:db8:1::/64 }
}

set ssh_access_ip6_hosts {
    type ipv6_addr
    elements = { 2001:db8::10 }
}
</code></pre></div>
<p>Then validate and reload (root shell):</p>
<div class="highlight"><pre><span></span><code>nft<span class="w"> </span>-c<span class="w"> </span>-f<span class="w"> </span>/etc/nftables.d/perfsonar.nft
systemctl<span class="w"> </span>reload<span class="w"> </span>nftables<span class="w"> </span><span class="o">||</span><span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nftables
</code></pre></div>
</details>
<h3 id="confirm-nftables-state-and-security-services">Confirm nftables state and security services<a class="headerlink" href="#confirm-nftables-state-and-security-services" title="Permanent link">&para;</a></h3>
<details class="info">
<summary>Verification commands</summary>
<div class="highlight"><pre><span></span><code>nft<span class="w"> </span>list<span class="w"> </span>ruleset
sestatus
systemctl<span class="w"> </span>status<span class="w"> </span>fail2ban
</code></pre></div>
</details>
<p>You may want to document any site-specific exceptions (e.g., additional allowed management hosts) in your change log.</p>
<hr />
<h2 id="step-5-deploy-the-containerized-perfsonar-testpoint">Step 5 – Deploy the Containerized perfSONAR Testpoint<a class="headerlink" href="#step-5-deploy-the-containerized-perfsonar-testpoint" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
<p>The orchestrator automates container deployment and certificate issuance. If you ran it in Step 2, skip to <a href="#step-6-configure-and-enroll-in-psconfig">Step 6</a>.</p>
</div>
<p>Run the official testpoint image using Podman (or Docker). Choose one of the two deployment modes:</p>
<ul>
<li>
<p><strong>Option A:</strong> Testpoint only (simplest) — bind-mounts <code>/opt/perfsonar-tp/psconfig</code>, <code>/var/www/html</code>, and <code>/etc/apache2</code> for Apache and pSConfig.</p>
</li>
<li>
<p><strong>Option B:</strong> Testpoint + Let’s Encrypt — two containers that share Apache files and certs via host bind mounts.</p>
</li>
</ul>
<p>Use <code>podman-compose</code> (or <code>docker-compose</code>) in the examples below.</p>
<h3 id="option-a-testpoint-only-simplest">Option A — Testpoint only (simplest)<a class="headerlink" href="#option-a-testpoint-only-simplest" title="Permanent link">&para;</a></h3>
<h4 id="1-seed-required-host-directories-required-before-first-compose-up">1) Seed required host directories (REQUIRED before first compose up)<a class="headerlink" href="#1-seed-required-host-directories-required-before-first-compose-up" title="Permanent link">&para;</a></h4>
<p><strong>Why seed?</strong> The perfsonar-testpoint container requires baseline configuration files from the image to be present on
the host filesystem. Without seeding, the bind-mounted directories would be empty, causing Apache and perfSONAR services
to fail.</p>
<p><strong>What's seeded:</strong></p>
<ul>
<li>
<p><code>/opt/perfsonar-tp/psconfig</code> — perfSONAR pSConfig files (baseline remotes and archives)</p>
</li>
<li>
<p><code>/opt/perfsonar-tp/conf/node_exporter.defaults</code> — node_exporter options override; disables the
  <code>cpufreq</code> collector that panics on hosts with offline CPUs (procfs v0.10.0 bug)</p>
</li>
<li>
<p><code>/var/www/html</code> — Apache webroot with index.html (required for healthcheck)</p>
</li>
<li>
<p><code>/etc/apache2</code> — Apache config including <code>sites-available/default-ssl.conf</code></p>
</li>
</ul>
<p>Run the bundled seeding helper script (automatically installed in Step 2):</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/seed_testpoint_host_dirs.sh
</code></pre></div>
<details class="info">
<summary>Seed script details</summary>
<ul>
<li>Pulls the latest perfSONAR testpoint image</li>
<li>Creates temporary containers to extract baseline files</li>
<li>Copies content to host directories</li>
<li>Installs <code>node_exporter.defaults</code> into <code>/opt/perfsonar-tp/conf/</code></li>
<li>Verifies seeding was successful</li>
<li>Skips seeding if directories already have content (idempotent)</li>
</ul>
</details>
<p>Verify seeding succeeded:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Should show config files</span>
ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/psconfig

<span class="c1"># Should show node_exporter.defaults</span>
ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/conf/node_exporter.defaults

<span class="c1"># Should show index.html and perfsonar/ directory</span>
ls<span class="w"> </span>-la<span class="w"> </span>/var/www/html

<span class="c1"># Should show sites-available/, sites-enabled/, etc.</span>
ls<span class="w"> </span>-la<span class="w"> </span>/etc/apache2
</code></pre></div>
<details class="tip">
<summary>SELinux labeling handled automatically</summary>
<p>If SELinux is enforcing, the <code>:Z</code> and <code>:z</code> options in the compose files will cause Podman to relabel the host paths when
containers start. No manual <code>chcon</code> commands are required.</p>
</details>
<details class="tip">
<summary>node_exporter D-Bus access on EL9/SELinux</summary>
<p>The compose file bind-mounts <code>/run/dbus:/run/dbus:ro</code> so that node_exporter can use
<code>--collector.systemd</code> to expose perfSONAR service states as Prometheus metrics.
On EL9 hosts with SELinux in <strong>Enforcing</strong> mode the <code>system_dbusd_var_run_t</code> label may
block access. Enable with:</p>
<div class="highlight"><pre><span></span><code>setsebool<span class="w"> </span>-P<span class="w"> </span>container_use_dbusd<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p>If the boolean is not available on your policy version, add <code>security_opt: label=disable</code>
to the testpoint service in <code>docker-compose.yml</code> (less preferred — disables all SELinux
confinement for the container).</p>
</details>
<h4 id="2-deploy-the-container">2) Deploy the container<a class="headerlink" href="#2-deploy-the-container" title="Permanent link">&para;</a></h4>
<p>Download a ready-made compose file (or copy it manually): Browse: <a href="https://github.com/osghtc/networking/blob/master/docs/perfsonar/tools_scripts/docker-compose.testpoint.yml">repo
view</a></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/docker-compose.testpoint.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<p>Edit the <code>docker-compose.yml</code> as desired.</p>
<p>Bring it up:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span><span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp<span class="p">;</span><span class="w"> </span>podman-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="o">)</span>
</code></pre></div>
<p>Verify the container is running and healthy:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>ps
</code></pre></div>
<p>The container should show <code>healthy</code> status. The healthcheck monitors Apache HTTPS availability.</p>
<p>Manage pSConfig files under <code>/opt/perfsonar-tp/psconfig</code> on the host; they are consumed by the container at <code>/etc/perfsonar/psconfig</code>.</p>
<h4 id="3-ensure-containers-restart-automatically-on-reboot-systemd-unit-for-testpoint-required">3) Ensure containers restart automatically on reboot (systemd unit for testpoint - REQUIRED)<a class="headerlink" href="#3-ensure-containers-restart-automatically-on-reboot-systemd-unit-for-testpoint-required" title="Permanent link">&para;</a></h4>
<div class="admonition warning">
<p class="admonition-title">podman-compose limitation with systemd containers</p>
<p>The perfSONAR testpoint image runs <strong>systemd internally</strong> and requires the <code>--systemd=always</code> flag to function
correctly. <strong>podman-compose does not support this flag</strong>, which causes containers to crash-loop after reboot with exit
code 255.</p>
<p>You <strong>must</strong> use the systemd unit approach below instead of relying on compose alone.</p>
<p>Install the provided systemd units to manage containers with proper systemd support:</p>
</div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install testpoint-only systemd unit</span>
/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp

<span class="c1"># Enable and start now</span>
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service

<span class="c1"># Verify service and containers</span>
systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>--no-pager
podman<span class="w"> </span>ps
</code></pre></div>
<details class="info">
<summary>Notes on podman/systemd</summary>
<ul>
<li>The service uses <code>podman run --systemd=always</code> to enable proper systemd operation inside the container</li>
<li>The compose file is kept for reference but not used by the systemd units</li>
<li>If you need to update container configuration, edit the systemd unit file directly: <code>/etc/systemd/system/perfsonar-testpoint.service</code></li>
<li>After editing the unit file, reload and restart: <code>systemctl daemon-reload &amp;&amp; systemctl restart perfsonar-testpoint.service</code></li>
</ul>
</details>
<!-- markdownlint-disable-next-line MD051 -->
<p>Jump to <a href="#step-6-configure-and-enroll-in-psconfig">Step 6</a> below.</p>
<hr />
<h3 id="option-b-testpoint-lets-encrypt-shared-apache-and-certs">Option B — Testpoint + Let's Encrypt (shared Apache and certs)<a class="headerlink" href="#option-b-testpoint-lets-encrypt-shared-apache-and-certs" title="Permanent link">&para;</a></h3>
<p>This mode runs two containers (<code>perfsonar-testpoint</code> and <code>certbot</code>) and bind-mounts the following host paths so Apache
content and certificates persist on the host and are shared between containers:</p>
<ul>
<li>
<p><code>/opt/perfsonar-tp/psconfig</code> → <code>/etc/perfsonar/psconfig</code> — perfSONAR configuration</p>
</li>
<li>
<p><code>/var/www/html</code> → <code>/var/www/html</code> — Apache webroot (shared for HTTP-01 challenges)</p>
</li>
<li>
<p><code>/etc/apache2</code> → <code>/etc/apache2</code> — Apache configuration (for SSL certificate patching)</p>
</li>
<li>
<p><code>/etc/letsencrypt</code> → <code>/etc/letsencrypt</code> — Let's Encrypt certificates and state</p>
</li>
</ul>
<!-- markdownlint-disable-next-line MD024 -->
<h4 id="1-seed-required-host-directories-required-before-first-compose-up_1">1) Seed required host directories (REQUIRED before first compose up)<a class="headerlink" href="#1-seed-required-host-directories-required-before-first-compose-up_1" title="Permanent link">&para;</a></h4>
<p><strong>Why seed?</strong> The perfsonar-testpoint container requires baseline configuration files from the image to be present on
the host filesystem. Without seeding, the bind-mounted directories would be empty, causing Apache and perfSONAR services
to fail.</p>
<p><strong>What's seeded:</strong></p>
<ul>
<li>
<p><code>/opt/perfsonar-tp/psconfig</code> — perfSONAR pSConfig files (baseline remotes and archives)</p>
</li>
<li>
<p><code>/opt/perfsonar-tp/conf/node_exporter.defaults</code> — node_exporter options override; disables the
  <code>cpufreq</code> collector that panics on hosts with offline CPUs (procfs v0.10.0 bug)</p>
</li>
<li>
<p><code>/var/www/html</code> — Apache webroot with index.html (required for healthcheck)</p>
</li>
<li>
<p><code>/etc/apache2</code> — Apache config including <code>sites-available/default-ssl.conf</code> (patched by entrypoint wrapper)</p>
</li>
</ul>
<p><strong>What's NOT seeded:</strong></p>
<ul>
<li>
<p><code>/etc/letsencrypt</code> — Certbot creates this automatically; no pre-seeding needed</p>
</li>
<li>
<p><code>/run/dbus</code> — Host D-Bus socket mount; exists at runtime, no seeding needed</p>
</li>
</ul>
<p>Run the bundled seeding helper script (automatically installed in Step 2):</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/seed_testpoint_host_dirs.sh
</code></pre></div>
<details class="info">
<summary>Seed script details</summary>
<ul>
<li>Pulls the latest perfSONAR testpoint image</li>
<li>Creates temporary containers to extract baseline files</li>
<li>Copies content to host directories</li>
<li>Installs <code>node_exporter.defaults</code> into <code>/opt/perfsonar-tp/conf/</code></li>
<li>Verifies seeding was successful</li>
<li>Skips seeding if directories already have content (idempotent)</li>
</ul>
</details>
<p>Verify seeding succeeded:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Should show config files</span>
ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/psconfig

<span class="c1"># Should show node_exporter.defaults</span>
ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/conf/node_exporter.defaults

<span class="c1"># Should show index.html and perfsonar/ directory</span>
ls<span class="w"> </span>-la<span class="w"> </span>/var/www/html

<span class="c1"># Should show sites-available/, sites-enabled/, etc.</span>
ls<span class="w"> </span>-la<span class="w"> </span>/etc/apache2
</code></pre></div>
<details class="tip">
<summary>SELinux labeling handled automatically</summary>
<p>If SELinux is enforcing, the <code>:Z</code> and <code>:z</code> options in the compose files will cause Podman to relabel the host paths when
containers start. No manual <code>chcon</code> commands are required.</p>
<p><strong>SELinux Volume Labels:</strong></p>
<ul>
<li><code>:Z</code> (uppercase) - Exclusive access. Podman creates a unique SELinux label for this volume that only this specific container can access. Use for volumes that should not be shared between containers.</li>
<li><code>:z</code> (lowercase) - Shared access. Podman uses a shared SELinux label that multiple containers can access. Use for volumes that need to be accessed by multiple containers.
In our compose files:</li>
<li><code>/etc/letsencrypt:/etc/letsencrypt:Z</code> - Exclusive to testpoint container</li>
<li><code>/var/www/html:/var/www/html:z</code> - Shared between testpoint and certbot containers</li>
<li><code>/etc/apache2:/etc/apache2:Z</code> - Exclusive to testpoint container</li>
</ul>
</details>
<h4 id="2-deploy-the-testpoint-with-automatic-ssl-patching-recommended">2) Deploy the testpoint with automatic SSL patching (recommended)<a class="headerlink" href="#2-deploy-the-testpoint-with-automatic-ssl-patching-recommended" title="Permanent link">&para;</a></h4>
<p><strong>Prerequisites:</strong> Ensure <code>/opt/perfsonar-tp/tools_scripts</code> exists from Step 2 (bootstrap):</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh
</code></pre></div>
<p>If the file is missing, run the Step 2 bootstrap first:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>bash<span class="w"> </span>-s<span class="w"> </span>--<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<p>Deploy using the compose file with automatic Apache SSL certificate patching. This approach uses an entrypoint wrapper
that auto-discovers Let's Encrypt certificates on container startup and automatically patches the Apache configuration.</p>
<p>Download the auto-patching compose file:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/docker-compose.testpoint-le-auto.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<details class="note">
<summary>The SERVER_FQDN use is optional</summary>
<p><strong>Note:</strong> The <code>SERVER_FQDN</code> environment variable is <strong>optional</strong>. The entrypoint wrapper will auto-discover certificates in <code>/etc/letsencrypt/live</code> 
and use the first one found. Only set <code>SERVER_FQDN</code> if you have multiple certificates and need to specify which one to use.</p>
<p>If you want to explicitly set the FQDN (optional):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Optional: only needed if you have multiple certificates</span>
sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/# - SERVER_FQDN=.*/- SERVER_FQDN=&lt;YOUR_FQDN&gt;/&#39;</span><span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
</details>
<p>Start the containers:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp
podman-compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>
<p>At this point, the testpoint is running with self-signed certificates. The certbot container is also running but won't
renew anything until you obtain the initial certificates.</p>
<h4 id="ensure-containers-restart-automatically-on-reboot-systemd-units-for-testpoint-certbot-required">Ensure containers restart automatically on reboot (systemd units for testpoint &amp; certbot - REQUIRED)<a class="headerlink" href="#ensure-containers-restart-automatically-on-reboot-systemd-units-for-testpoint-certbot-required" title="Permanent link">&para;</a></h4>
<div class="admonition warning">
<p class="admonition-title">podman-compose limitation with systemd containers</p>
<p>The perfSONAR testpoint image runs <strong>systemd internally</strong> and requires the <code>--systemd=always</code> flag to function
correctly. <strong>podman-compose does not support this flag</strong>, which causes containers to crash-loop after reboot with exit
code 255.</p>
<p>You <strong>must</strong> use the systemd unit approach below instead of relying on compose alone.</p>
<p>Install and enable the systemd units so containers start on boot with proper systemd support:</p>
</div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install both testpoint and certbot systemd units</span>
/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span>--with-certbot

<span class="c1"># Enable and start services</span>
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># Verify services</span>
systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>perfsonar-certbot.service<span class="w"> </span>--no-pager
podman<span class="w"> </span>ps
</code></pre></div>
<h4 id="3-obtain-your-first-lets-encrypt-certificate-one-time">3) Obtain your first Let's Encrypt certificate (one-time)<a class="headerlink" href="#3-obtain-your-first-lets-encrypt-certificate-one-time" title="Permanent link">&para;</a></h4>
<p>Use Certbot in standalone mode to obtain the initial certificates. The perfsonar-testpoint image is patched to NOT
listen on port 80, so port 80 is available for Certbot's HTTP-01 challenge.</p>
<p><strong>Important:</strong> Stop the certbot sidecar temporarily to free port 80:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>stop<span class="w"> </span>certbot
</code></pre></div>
<p>Now run Certbot standalone with host networking to bind port 80:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/etc/letsencrypt:/etc/letsencrypt:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/var/www/html:/var/www/html:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>docker.io/certbot/certbot:latest<span class="w"> </span>certonly<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--standalone<span class="w"> </span>--agree-tos<span class="w"> </span>--non-interactive<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span>&lt;SERVER_FQDN&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;ALT_FQDN&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-m<span class="w"> </span>&lt;LETSENCRYPT_EMAIL&gt;
</code></pre></div>
<details class="info">
<summary>Certbot command explained</summary>
<p><strong>Podman options:</strong></p>
<ul>
<li><code>--rm</code> - Remove container after it exits</li>
<li><code>--net=host</code> - Use host network (allows binding port 80)</li>
<li><code>-v /etc/letsencrypt:/etc/letsencrypt:Z</code> - Mount certificate storage with exclusive SELinux label</li>
<li><code>-v /var/www/html:/var/www/html:Z</code> - Mount webroot for HTTP-01 challenge</li>
</ul>
<p><strong>Certbot options:</strong></p>
<ul>
<li><code>certonly</code> - Obtain certificate only, don't install it</li>
<li><code>--standalone</code> - Run standalone HTTP server on port 80 for ACME HTTP-01 challenge</li>
<li><code>--agree-tos</code> - Agree to Let's Encrypt Terms of Service</li>
<li><code>--non-interactive</code> - Don't prompt for input (required for automation)</li>
<li><code>-d &lt;FQDN&gt;</code> - Domain name(s) for the certificate (repeat for each domain/SAN)</li>
<li><code>-m &lt;EMAIL&gt;</code> - Email for renewal notifications and account recovery</li>
</ul>
</details>
<p>Replace:</p>
<ul>
<li><code>&lt;SERVER_FQDN&gt;</code> with your primary hostname (e.g., <code>psum05.aglt2.org</code>)</li>
<li><code>&lt;ALT_FQDN&gt;</code> with additional FQDNs if needed (one <code>-d</code> flag per FQDN)</li>
<li><code>&lt;LETSENCRYPT_EMAIL&gt;</code> with your email for certificate notifications</li>
</ul>
<p>After successful issuance, restart the perfsonar-testpoint container to trigger the automatic patching:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>restart<span class="w"> </span>perfsonar-testpoint
</code></pre></div>
<p>Check the logs to verify the SSL config was patched:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;Patching Apache&quot;</span>
</code></pre></div>
<p>You should see output confirming the certificate paths were updated.</p>
<h4 id="4-restart-the-certbot-sidecar-for-automatic-renewals">4) Restart the certbot sidecar for automatic renewals<a class="headerlink" href="#4-restart-the-certbot-sidecar-for-automatic-renewals" title="Permanent link">&para;</a></h4>
<p>Now that certificates are in place, restart the certbot sidecar to enable automatic renewals:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>start<span class="w"> </span>certbot
</code></pre></div>
<p>The certbot container runs a renewal loop that checks for expiring certificates every 12 hours.</p>
<p><strong>Automatic Container Restart:</strong> After each successful certificate renewal, certbot automatically runs
a deploy hook script (<code>certbot-deploy-hook.sh</code>) that gracefully restarts the <code>perfsonar-testpoint</code>
container. This ensures the new certificates are loaded without manual intervention. The deploy hook
uses the mounted Podman socket (<code>/run/podman/podman.sock</code>) to communicate with the host's container
runtime via the Podman REST API (using Python, since the <code>podman</code> CLI is not present in the certbot
image). On EL9 hosts with SELinux enforcing, the certbot service requires <code>security_opt: label=disable</code>
to access the socket.</p>
<p><strong>Note:</strong> The certbot container in this setup uses <strong>host networking mode</strong> (via <code>network_mode: host</code> in the compose
file) so it can bind directly to port 80 for HTTP-01 challenges during renewals. This works because the perfsonar-
testpoint Apache is patched to NOT listen on port 80. Both containers share the host network namespace without conflict.</p>
<p>Test renewal with a dry-run:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>certbot<span class="w"> </span>certbot<span class="w"> </span>renew<span class="w"> </span>--dry-run
</code></pre></div>
<p>If successful, certificates will auto-renew before expiry, and the testpoint will be automatically restarted to load the
new certificates. You can verify this behavior by checking the certbot logs after a renewal:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>logs<span class="w"> </span>certbot<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;deploy hook&quot;</span>
</code></pre></div>
<hr />
<details class="info">
<summary>Alternative: Manual SSL Patching (without automatic entrypoint wrapper)</summary>
<p>If you prefer not to use the automatic patching entrypoint wrapper, you can use the standard compose file and manually
patch the Apache SSL configuration after obtaining certificates.</p>
<ol>
<li>Use <code>docker-compose.testpoint-le.yml</code> instead of <code>docker-compose.testpoint-le-auto.yml</code></li>
<li>After obtaining Let's Encrypt certificates, run:
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/patch_apache_ssl_for_letsencrypt.sh<span class="w"> </span>&lt;SERVER_FQDN&gt;
</code></pre></div></li>
<li>Reload Apache in the running container:
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>apachectl<span class="w"> </span>-k<span class="w"> </span>graceful
</code></pre></div></li>
</ol>
</details>
<p>This approach requires manual intervention after initial certificate issuance and any time the container is recreated.
The automatic approach (using the entrypoint wrapper) eliminates this manual step.</p>
<details class="warning">
<summary>Troubleshooting: Container fails with 'executable file not found' error</summary>
<p><strong>Error:</strong> <code>Error: unable to start container: crun: executable file /opt/perfsonar-tp/tools_scripts/testpoint-
entrypoint-wrapper.sh not found</code></p>
<p><strong>Cause:</strong> The <code>/opt/perfsonar-tp/tools_scripts</code> directory doesn't exist or the entrypoint wrapper wasn't downloaded.</p>
<p><strong>Fix:</strong> Run the Step 2 bootstrap script to fetch all helper scripts:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>bash<span class="w"> </span>-s<span class="w"> </span>--<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<p>Then verify the entrypoint wrapper exists:</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh
</code></pre></div>
<p>If you've already started the container and it failed, remove it before retrying:</p>
<div class="highlight"><pre><span></span><code>podman-compose<span class="w"> </span>down
podman-compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>
</details>
<hr />
<h2 id="step-6-configure-and-enroll-in-psconfig">Step 6 – Configure and Enroll in pSConfig<a class="headerlink" href="#step-6-configure-and-enroll-in-psconfig" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
<p>The orchestrator automates pSConfig enrollment. If you ran it in Step 2, skip to <a href="#step-7-register-and-configure-with-wlcgosg">Step 7</a>.</p>
</div>
<p>We need to enroll your testpoint with the OSG/WLCG pSConfig service so tests are auto-configured. Use the "auto URL" for each FQDN you expose for
perfSONAR (one or two depending on whether you split latency/throughput by hostname).</p>
<p>Basic enroll (interactive root on the host; runs inside the container) if you have only one entry to make (automation alternative below):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Add auto URLs (configures archives too) and show configured remotes</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>--configure-archives<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;https://psconfig.opensciencegrid.org/pub/auto/ps-lat-example.my.edu&quot;</span>

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>list
</code></pre></div>
<p>If there are any stale/old/incorrect entries, you can remove them:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>delete<span class="w"> </span><span class="s2">&quot;&lt;old-url&gt;&quot;</span>
</code></pre></div>
<p>Automation tip: derive FQDNs from your configured IPs (PTR lookup) and enroll automatically. Review the list before
applying.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Dry run only (show planned URLs):</span>
/opt/perfsonar-tp/tools_scripts/perfSONAR-auto-enroll-psconfig.sh<span class="w"> </span>-n

<span class="c1"># Typical usage (podman):</span>
/opt/perfsonar-tp/tools_scripts/perfSONAR-auto-enroll-psconfig.sh<span class="w"> </span>-v

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>list
</code></pre></div>
<details class="note">
<summary>The auto enroll psconfig script details</summary>
<ul>
<li>Parses IP lists from <code>/etc/perfSONAR-multi-nic-config.conf</code>  (<code>NIC_IPV4_ADDRS</code> / <code>NIC_IPV6_ADDRS</code>).</li>
<li>Performs reverse DNS lookups (getent/dig) to derive FQDNs.</li>
<li>Deduplicates while preserving discovery order.</li>
<li>Adds each <code>https://psconfig.opensciencegrid.org/pub/auto/&lt;FQDN&gt;</code> with <code>--configure-archives</code>.</li>
<li>Lists configured remotes and returns non-zero if any enrollment fails.</li>
</ul>
<p>Integrate into provisioning CI by running with <code>-n</code> (dry-run) for approval and then <code>-y</code> once approved.</p>
</details>
<hr />
<h2 id="step-7-register-and-configure-with-wlcgosg">Step 7 – Register and Configure with WLCG/OSG<a class="headerlink" href="#step-7-register-and-configure-with-wlcgosg" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>OSG/WLCG registration workflow:</strong></p>
<details class="info">
<summary>Registration steps and portals</summary>
<ul>
<li>Register the host in <a href="https://topology.opensciencegrid.org/host">OSG topology</a>.</li>
<li>Create or update a <a href="https://ggus.eu/">GGUS</a> ticket announcing the new measurement point.</li>
<li>In <a href="https://goc.egi.eu/portal/">GOCDB</a>, add the service endpoint
        <code>org.opensciencegrid.crc.perfsonar-testpoint</code> bound to this host.</li>
</ul>
</details>
</li>
<li>
<p><strong>Document memberships:</strong></p>
<p>Update your site wiki or change log with assigned mesh names, feed  URLs, and support contacts.</p>
</li>
<li>
<p><strong>Update Lookup Service registration inside the container:</strong></p>
<p>Use the helper script to edit <code>/etc/perfsonar/lsregistrationdaemon.conf</code> inside the running <code>perfsonar-testpoint</code>
container and restart the daemon only if needed. Install and run examples below, pick which type you want (root shell):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Preview changes only (uses the copy from /opt/perfsonar-tp/tools_scripts)</span>
/opt/perfsonar-tp/tools_scripts/perfSONAR-update-lsregistration.sh<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dry-run<span class="w"> </span>--site-name<span class="w"> </span><span class="s2">&quot;Acme Co.&quot;</span><span class="w"> </span>--project<span class="w"> </span>WLCG<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--admin-email<span class="w"> </span>admin@example.org<span class="w"> </span>--admin-name<span class="w"> </span><span class="s2">&quot;pS Admin&quot;</span>

<span class="c1"># Restore previously saved settings from the Prerequisites extract (if you saved a restore script earlier)</span>
bash<span class="w"> </span>/root/restore-lsreg.sh

<span class="c1"># Apply new settings and restart the daemon inside the container</span>
/opt/perfsonar-tp/tools_scripts/perfSONAR-update-lsregistration.sh<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--site-name<span class="w"> </span><span class="s2">&quot;Acme Co.&quot;</span><span class="w"> </span>--domain<span class="w"> </span>example.org<span class="w"> </span>--project<span class="w"> </span>WLCG<span class="w"> </span>--project<span class="w"> </span>OSG<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--city<span class="w"> </span>Berkeley<span class="w"> </span>--region<span class="w"> </span>CA<span class="w"> </span>--country<span class="w"> </span>US<span class="w"> </span>--zip<span class="w"> </span><span class="m">94720</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--latitude<span class="w"> </span><span class="m">37</span>.5<span class="w"> </span>--longitude<span class="w"> </span>-121.7469<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--admin-name<span class="w"> </span><span class="s2">&quot;pS Admin&quot;</span><span class="w"> </span>--admin-email<span class="w"> </span>admin@example.org
</code></pre></div>
</li>
<li>
<p><strong>Automatic image updates and safe restarts</strong></p>
<p>Keep containers current and only restart them when their image actually changes.</p>
<p>Run the bundled <code>install-systemd-units.sh</code> with the <code>--auto-update</code> flag (it was already downloaded to <code>tools_scripts</code> in Step 2):</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--auto-update
</code></pre></div>
<p>This installs <code>/usr/local/bin/perfsonar-auto-update.sh</code> (from <code>tools_scripts/</code>) and creates a
systemd service + timer that runs daily at 03:00 (plus a random delay up to 1 hour).</p>
<details class="info">
<summary>What <code>--auto-update</code> installs</summary>
<ul>
<li><strong><code>/usr/local/bin/perfsonar-auto-update.sh</code></strong> — copies <code>perfSONAR-auto-update.sh</code> from
  <code>tools_scripts/</code>.  The script records the local image digest <em>before</em> the pull and
  compares it to the digest <em>after</em>. Only if they differ does it restart
  <code>perfsonar-testpoint.service</code>.  This approach uses Podman image inspection (<code>podman
  image inspect … --format '{{.Id}}'</code>) and is <strong>not</strong> dependent on Docker-specific output
  strings like <code>"Downloaded newer image"</code>, which Podman never emits.</li>
<li><strong><code>/etc/systemd/system/perfsonar-auto-update.service</code></strong> — oneshot service to run the
  script.</li>
<li><strong><code>/etc/systemd/system/perfsonar-auto-update.timer</code></strong> — daily trigger with a 1-hour
  randomised delay and <code>Persistent=true</code> (catches up if the host was off).</li>
<li>Enables and starts the timer immediately.</li>
</ul>
</details>
<p>Verify the timer is active:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>list-timers<span class="w"> </span>perfsonar-auto-update.timer
</code></pre></div>
<p>Test manually:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>perfsonar-auto-update.service
journalctl<span class="w"> </span>-u<span class="w"> </span>perfsonar-auto-update.service<span class="w"> </span>-n<span class="w"> </span><span class="m">50</span>
</code></pre></div>
<p>Monitor the update log:</p>
<div class="highlight"><pre><span></span><code>tail<span class="w"> </span>-f<span class="w"> </span>/var/log/perfsonar-auto-update.log
</code></pre></div>
</li>
</ol>
<p>This approach ensures containers are updated only when new images are available, minimizing unnecessary restarts while
keeping your deployment current.</p>
<hr />
<h2 id="step-8-post-install-validation">Step 8 – Post-Install Validation<a class="headerlink" href="#step-8-post-install-validation" title="Permanent link">&para;</a></h2>
<p>Perform these checks before handing the host over to operations:</p>
<ol>
<li>
<p><strong>System services:</strong></p>
<details class="info">
<summary>Verify Podman runtime and containers</summary>
<div class="highlight"><pre><span></span><code><span class="c1"># Check Podman service is available</span>
systemctl<span class="w"> </span>status<span class="w"> </span>podman

<span class="c1"># Verify containers are managed by compose</span>
<span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>podman-compose<span class="w"> </span>ps

<span class="c1"># Alternative: check containers directly</span>
podman<span class="w"> </span>ps<span class="w"> </span>--filter<span class="w"> </span><span class="nv">name</span><span class="o">=</span>perfsonar
</code></pre></div>
</details>
<p>Ensure Podman is active and containers are running.</p>
</li>
<li>
<p><strong>Container health:</strong></p>
<details class="info">
<summary>Check container status and logs</summary>
<div class="highlight"><pre><span></span><code><span class="c1"># Check all containers are running and healthy</span>
podman<span class="w"> </span>ps<span class="w"> </span>--format<span class="w"> </span><span class="s1">&#39;table {{.Names}}\t{{.Status}}\t{{.Ports}}&#39;</span>

<span class="c1"># Check perfsonar-testpoint logs for errors</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>--tail<span class="w"> </span><span class="m">50</span>

<span class="c1"># If using Let&#39;s Encrypt, check certbot logs</span>
podman<span class="w"> </span>logs<span class="w"> </span>certbot<span class="w"> </span>--tail<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Certbot container not present (testpoint-only mode)&quot;</span>

<span class="c1"># Verify services inside container are running</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>apache2<span class="w"> </span>psconfig-pscheduler-agent<span class="w"> </span>--no-pager
</code></pre></div>
</details>
</li>
<li>
<p><strong>Network path validation:</strong></p>
<details class="info">
<summary>Test network connectivity and routing</summary>
<p>Test throughput to a remote testpoint (run from inside the container):
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>pscheduler<span class="w"> </span>task<span class="w"> </span>throughput<span class="w"> </span>--dest<span class="w"> </span>&lt;remote-testpoint&gt;
</code></pre></div></p>
<p>Check routing from the host:
<div class="highlight"><pre><span></span><code>tracepath<span class="w"> </span>-n<span class="w"> </span>&lt;remote-testpoint&gt;
ip<span class="w"> </span>route<span class="w"> </span>get<span class="w"> </span>&lt;remote-testpoint-ip&gt;
</code></pre></div></p>
<p>Confirm traffic uses the intended policy-based routes (check <code>ip route get &lt;dest&gt;</code>).</p>
</details>
</li>
<li>
<p><strong>Security posture:</strong></p>
<details class="info">
<summary>Check firewall, fail2ban, and SELinux</summary>
<div class="highlight"><pre><span></span><code><span class="c1"># Check nftables firewall rules</span>
nft<span class="w"> </span>list<span class="w"> </span>ruleset<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>perfsonar

<span class="c1"># Check fail2ban status (if installed in Step 4)</span>
<span class="k">if</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>fail2ban-client<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>fail2ban-client<span class="w"> </span>status
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;fail2ban not installed (optional)&quot;</span>
<span class="k">fi</span>

<span class="c1"># Check for recent SELinux denials</span>
<span class="k">if</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>ausearch<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>ausearch<span class="w"> </span>--message<span class="w"> </span>AVC<span class="w"> </span>--just-one
<span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>/var/log/audit/audit.log<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;avc.*denied&quot;</span><span class="w"> </span>/var/log/audit/audit.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-5
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;SELinux audit tools not available&quot;</span>
<span class="k">fi</span>
</code></pre></div>
</details>
<p>Investigate any SELinux denials or repeated Fail2Ban bans.</p>
</li>
<li>
<p><strong>LetsEncrypt certificate check:</strong></p>
<details class="info">
<summary>Verify certificate validity</summary>
<div class="highlight"><pre><span></span><code><span class="c1"># Check certificate via HTTPS connection</span>
<span class="nb">echo</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>&lt;SERVER_FQDN&gt;:443<span class="w"> </span>-servername<span class="w"> </span>&lt;SERVER_FQDN&gt;<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-dates<span class="w"> </span>-issuer

<span class="c1"># Alternative: Check certificate files directly</span>
sudo<span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/letsencrypt/live/&lt;SERVER_FQDN&gt;/cert.pem<span class="w"> </span>-noout<span class="w"> </span>-dates<span class="w"> </span>-issuer
</code></pre></div>
</details>
<p>Ensure the issuer is Let's Encrypt and the validity period is acceptable. This check only applies if you configured Let's Encrypt in Step 3.</p>
</li>
<li>
<p><strong>Reporting:</strong></p>
<details class="info">
<summary>Run perfSONAR diagnostic reports</summary>
<p>Run the perfSONAR troubleshoot command from inside the container and send outputs to operations:
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>pscheduler<span class="w"> </span>troubleshoot
</code></pre></div></p>
</details>
</li>
</ol>
<hr />
<h2 id="ongoing-maintenance">Ongoing Maintenance<a class="headerlink" href="#ongoing-maintenance" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>Quarterly or as-needed:</strong> Re-validate routing policy and nftables rules after network changes or security audits.</p>
</li>
<li>
<p><strong>Monthly or during maintenance windows:</strong> Apply OS updates (<code>dnf update</code>) and reboot during scheduled downtime.</p>
</li>
<li>
<p>Monitor psconfig feeds for changes in mesh participation and test configuration.</p>
</li>
<li>
<p>Track certificate expiry with <code>certbot renew --dry-run</code> if you rely on Let's Encrypt (automatic renewal is configured but monitoring is recommended).</p>
</li>
<li>
<p>Review container logs periodically for errors: <code>podman logs perfsonar-testpoint</code> and <code>podman logs certbot</code>.</p>
</li>
<li>
<p>Verify auto-update timer is active: <code>systemctl list-timers perfsonar-auto-update.timer</code>.</p>
</li>
</ul>
<hr />
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="container-issues">Container Issues<a class="headerlink" href="#container-issues" title="Permanent link">&para;</a></h3>
<details class="failure">
<summary>Container won't start or exits immediately</summary>
<p><strong>Symptoms:</strong> <code>podman ps</code> shows no running containers, or container exits shortly after starting.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check container logs</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint

<span class="c1"># Check for systemd initialization errors</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;failed\|error&quot;</span>

<span class="c1"># Verify compose file syntax</span>
<span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp
podman-compose<span class="w"> </span>config
</code></pre></div>
<p><strong>Common causes:</strong></p>
<ul>
<li>Missing entrypoint wrapper: Ensure <code>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh</code> exists</li>
<li>SELinux denials: Check <code>ausearch -m avc -ts recent</code> and consider temporarily setting to permissive mode for testing</li>
<li>Incorrect bind-mount paths: Verify all host directories exist and have correct permissions</li>
<li>Cgroup issues: Ensure <code>cgroupns: private</code> is set and no manual cgroup bind-mounts exist</li>
</ul>
</details>
<details class="failure">
<summary>Container won't start or exits immediately</summary>
<p><strong>Symptoms:</strong> <code>podman ps</code> shows no running containers, or container exits shortly after starting.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check container logs</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint

<span class="c1"># Check for systemd initialization errors</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;failed\|error&quot;</span>

<span class="c1"># Verify compose file syntax</span>
<span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp
podman-compose<span class="w"> </span>config
</code></pre></div>
<p><strong>Common causes:</strong></p>
<ul>
<li>Missing entrypoint wrapper: Ensure <code>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh</code> exists</li>
<li>SELinux denials: Check <code>ausearch -m avc -ts recent</code> and consider temporarily setting to permissive mode for testing</li>
<li>Incorrect bind-mount paths: Verify all host directories exist and have correct permissions</li>
<li>Cgroup issues: Ensure <code>cgroupns: private</code> is set and no manual cgroup bind-mounts exist</li>
</ul>
</details>
<details class="failure">
<summary>Container crashes after reboot with exit code 255</summary>
<p><strong>Symptoms:</strong> Containers run fine when started manually but crash-loop after host reboot. Logs show repeated restarts
with exit code 255.</p>
<p><strong>Cause:</strong> The perfSONAR testpoint image runs systemd internally but podman-compose doesn't support the
<code>--systemd=always</code> flag required for proper systemd operation in containers.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check container status</span>
podman<span class="w"> </span>ps<span class="w"> </span>-a

<span class="c1"># Check systemd service status</span>
systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service

<span class="c1"># View recent container logs</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>--tail<span class="w"> </span><span class="m">100</span>

<span class="c1"># Check if using compose-based service (BAD)</span>
grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;ExecStart&quot;</span><span class="w"> </span>/etc/systemd/system/perfsonar-testpoint.service
</code></pre></div>
<p><strong>Solution:</strong></p>
<p>Replace the compose-based systemd service with proper systemd units that use <code>podman run --systemd=always</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Stop and disable old service</span>
systemctl<span class="w"> </span>stop<span class="w"> </span>perfsonar-testpoint.service
systemctl<span class="w"> </span>disable<span class="w"> </span>perfsonar-testpoint.service

<span class="c1"># Install new systemd units</span>
curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># For testpoint only:</span>
/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp

<span class="c1"># For testpoint + certbot:</span>
/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span>--with-certbot

<span class="c1"># Enable and start</span>
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service

<span class="c1"># If using certbot:</span>
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># Verify containers are running</span>
podman<span class="w"> </span>ps
curl<span class="w"> </span>-kI<span class="w"> </span>https://127.0.0.1/
</code></pre></div>
<p><strong>Verification:</strong></p>
<p>After installing the new units, the testpoint should:
- Start successfully on boot
- Run systemd properly inside the container
- Maintain state across reboots
- Show "Up" status in <code>podman ps</code> (not "Exited" or crash-looping)</p>
</details>
<details class="failure">
<summary>Certbot service fails with 'Unable to open config file' error</summary>
<p><strong>Symptoms:</strong> <code>perfsonar-certbot.service</code> fails immediately after starting with exit code 2. Logs show: <code>certbot: error:
Unable to open config file: trap exit TERM; while...</code></p>
<p><strong>Cause:</strong> The certbot container image has a built-in entrypoint that expects certbot commands directly. When using a
shell loop for renewal, the entrypoint tries to parse the shell command as a certbot config file, causing this error.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check certbot service status</span>
systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># View detailed logs</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>perfsonar-certbot.service<span class="w"> </span>-n<span class="w"> </span><span class="m">50</span>

<span class="c1"># Check for the error in logs</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>perfsonar-certbot.service<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Unable to open config file&quot;</span>

<span class="c1"># Verify service file configuration</span>
grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;ExecStart&quot;</span><span class="w"> </span>/etc/systemd/system/perfsonar-certbot.service
</code></pre></div>
<p><strong>Solution:</strong></p>
<p>The certbot service needs two flags:
- <code>--systemd=always</code> for proper systemd integration and reboot persistence
- <code>--entrypoint=/bin/sh</code> to override the built-in entrypoint</p>
<p>Re-run the installation script to get the fixed version:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Stop current service</span>
systemctl<span class="w"> </span>stop<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># Download and install updated systemd units</span>
curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install with certbot support</span>
/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span>--with-certbot

<span class="c1"># Start the fixed service</span>
systemctl<span class="w"> </span>daemon-reload
systemctl<span class="w"> </span>start<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># Verify it&#39;s running</span>
systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-certbot.service
podman<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>certbot
</code></pre></div>
<p><strong>Expected result:</strong> The certbot container should be running (not exiting) and the service should be in "active (running)" state.</p>
</details>
<details class="failure">
<summary>SELinux denials blocking container operations</summary>
<p><strong>Symptoms:</strong> Container starts but services fail, permission denied errors in logs.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check for recent SELinux denials</span>
ausearch<span class="w"> </span>-m<span class="w"> </span>avc<span class="w"> </span>-ts<span class="w"> </span>recent

<span class="c1"># Temporarily set to permissive for testing</span>
setenforce<span class="w"> </span><span class="m">0</span>

<span class="c1"># Test if issue resolves, then check audit log</span>
ausearch<span class="w"> </span>-m<span class="w"> </span>avc<span class="w"> </span>-ts<span class="w"> </span>recent<span class="w"> </span>&gt;<span class="w"> </span>/tmp/selinux-denials.txt
</code></pre></div>
<p><strong>Solutions:</strong></p>
<ul>
<li>Verify volume labels are correct (<code>:Z</code> for exclusive, <code>:z</code> for shared)</li>
<li>Recreate containers to reapply SELinux labels: <code>podman-compose down &amp;&amp; podman-compose up -d</code></li>
<li>If persistent issues, consider creating custom SELinux policy or running in permissive mode</li>
</ul>
</details>
<h3 id="networking-issues">Networking Issues<a class="headerlink" href="#networking-issues" title="Permanent link">&para;</a></h3>
<details class="failure">
<summary>Policy-based routing not working correctly</summary>
<p><strong>Symptoms:</strong> Traffic not using expected interfaces, routing to wrong gateway.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check routing rules</span>
ip<span class="w"> </span>rule<span class="w"> </span>show

<span class="c1"># Check routing tables</span>
ip<span class="w"> </span>route<span class="w"> </span>show<span class="w"> </span>table<span class="w"> </span>all


<span class="c1"># Test specific route lookup</span>
ip<span class="w"> </span>route<span class="w"> </span>get<span class="w"> </span>&lt;destination-ip&gt;

<span class="c1"># Check NetworkManager connections</span>
nmcli<span class="w"> </span>connection<span class="w"> </span>show

<span class="c1"># Review PBR script log</span>
tail<span class="w"> </span>-100<span class="w"> </span>/var/log/perfSONAR-multi-nic-config.log
</code></pre></div>
<p><strong>Solutions:</strong></p>
<ul>
<li>Verify <code>/etc/perfSONAR-multi-nic-config.conf</code> has correct IPs and gateways</li>
<li>Reapply configuration: <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes</code></li>
<li>Reboot if rules are not being applied correctly</li>
<li>Check for conflicting NetworkManager or systemd-networkd rules</li>
</ul>
</details>
<details class="failure">
<summary>DNS resolution failing for test endpoints</summary>
<p><strong>Symptoms:</strong> perfSONAR tests fail with "unknown host" or DNS errors.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Test DNS resolution from container</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>dig<span class="w"> </span>&lt;remote-testpoint&gt;

<span class="c1"># Check container&#39;s resolv.conf</span>

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>cat<span class="w"> </span>/etc/resolv.conf

<span class="c1"># Verify forward and reverse DNS</span>
/opt/perfsonar-tp/tools_scripts/check-perfsonar-dns.sh
</code></pre></div>
<p><strong>Solutions:</strong></p>
<ul>
<li>Ensure DNS servers are correctly configured on host</li>
<li>Fix missing PTR records in DNS zones</li>
<li>Verify forward A/AAAA records match reverse PTR records</li>
</ul>
</details>
<h3 id="certificate-issues">Certificate Issues<a class="headerlink" href="#certificate-issues" title="Permanent link">&para;</a></h3>
<details class="failure">
<summary>Let's Encrypt certificate issuance fails</summary>
<p><strong>Symptoms:</strong> Certbot fails with "Failed to authenticate" or "Connection refused" errors.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check if port 80 is open</span>
nft<span class="w"> </span>list<span class="w"> </span>ruleset<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;80&quot;</span>

<span class="c1"># Verify Apache is NOT listening on port 80 in container</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>netstat<span class="w"> </span>-tlnp<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>:80

<span class="c1"># Test port 80 accessibility from external host</span>
curl<span class="w"> </span>-v<span class="w"> </span>http://&lt;your-fqdn&gt;/

<span class="c1"># Run certbot in verbose mode</span>

podman<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/etc/letsencrypt:/etc/letsencrypt:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/var/www/html:/var/www/html:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>docker.io/certbot/certbot:latest<span class="w"> </span>certonly<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--standalone<span class="w"> </span>-d<span class="w"> </span>&lt;SERVER_FQDN&gt;<span class="w"> </span>-m<span class="w"> </span>&lt;EMAIL&gt;<span class="w"> </span>--dry-run<span class="w"> </span>-vvv
</code></pre></div>
<p><strong>Common causes:</strong></p>
<ul>
<li>Port 80 blocked by firewall: Add with <code>perfSONAR-install-nftables.sh --ports=80,443</code></li>
<li>Apache listening on port 80: Verify testpoint-entrypoint-wrapper.sh patched Apache correctly</li>
<li>DNS not propagated: Wait for DNS changes to propagate globally</li>
<li>Rate limiting: Let's Encrypt has rate limits; wait if you've hit them</li>
</ul>
</details>
<details class="failure">
<summary>Certificate not loaded after renewal</summary>
<p><strong>Symptoms:</strong> Old certificate still in use after automatic renewal.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check certificate files</span>
ls<span class="w"> </span>-la<span class="w"> </span>/etc/letsencrypt/live/&lt;fqdn&gt;/

<span class="c1"># Verify deploy hook is configured</span>
podman<span class="w"> </span>logs<span class="w"> </span>certbot<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;deploy hook&quot;</span>

<span class="c1"># Check if container restarted</span>
podman<span class="w"> </span>ps<span class="w"> </span>--format<span class="w"> </span><span class="s1">&#39;table {{.Names}}\t{{.Status}}&#39;</span>

<span class="c1"># Manually restart testpoint</span>
podman<span class="w"> </span>restart<span class="w"> </span>perfsonar-testpoint
</code></pre></div>
<p><strong>Solutions:</strong></p>
<ul>
<li>Verify deploy hook script exists and is executable: <code>/opt/perfsonar-tp/tools_scripts/certbot-deploy-hook.sh</code></li>
<li>Ensure deploy hook is mounted in container at: <code>/etc/letsencrypt/renewal-hooks/deploy/certbot-deploy-hook.sh</code></li>
<li>Verify Podman socket is mounted in certbot container: <code>podman exec certbot ls /run/podman/podman.sock</code></li>
<li>Verify <code>security_opt: label=disable</code> is set on the certbot service in <code>docker-compose.yml</code> (required on EL9/SELinux hosts)</li>
<li>Check deploy hook logs: <code>journalctl -u perfsonar-certbot.service | grep deploy</code></li>
<li>Manually restart testpoint after renewals if deploy hook fails: <code>podman restart perfsonar-testpoint</code></li>
</ul>
<p><strong>Note:</strong> Certbot automatically executes scripts in <code>/etc/letsencrypt/renewal-hooks/deploy/</code> when certificates are
renewed. The deploy hook uses the Podman REST API via Python (not the <code>podman</code> CLI, which is absent from the Alpine-based certbot image).</p>
</details>
<h3 id="perfsonar-service-issues">perfSONAR Service Issues<a class="headerlink" href="#perfsonar-service-issues" title="Permanent link">&para;</a></h3>
<details class="failure">
<summary>perfSONAR services not running</summary>
<p><strong>Symptoms:</strong> Web interface not accessible, tests not running.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check service status inside container</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>apache2
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>pscheduler-ticker
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>owamp-server

<span class="c1"># Check for errors in service logs</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>journalctl<span class="w"> </span>-u<span class="w"> </span>apache2<span class="w"> </span>-n<span class="w"> </span><span class="m">50</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>journalctl<span class="w"> </span>-u<span class="w"> </span>pscheduler-ticker<span class="w"> </span>-n<span class="w"> </span><span class="m">50</span>
</code></pre></div>
<p><strong>Solutions:</strong></p>
<ul>
<li>Restart services inside container: <code>podman exec perfsonar-testpoint systemctl restart apache2</code></li>
<li>Check Apache SSL configuration was patched correctly</li>
<li>Verify certificates are in place: <code>ls -la /etc/letsencrypt/live/</code></li>
<li>Restart container: <code>podman restart perfsonar-testpoint</code></li>
</ul>
</details>
<details class="failure">
<summary>node_exporter metrics returning 502 / Service Unavailable</summary>
<p><strong>Symptoms:</strong> <code>https://&lt;host&gt;/node_exporter/metrics</code> returns 502 Proxy Error or Service
Unavailable. Apache is running but the backend on port 9100 is not responding.</p>
<p><strong>Root cause — cpufreq panic (procfs v0.10.0):</strong>
The <code>cpufreq</code> collector in <code>prometheus/procfs v0.10.0</code> panics with
<code>slice bounds out of range</code> on the first HTTP scrape when any CPU is offline.
node_exporter exits with code 2 immediately after each scrape attempt,
so port 9100 briefly accepts connections and then returns an empty reply.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check if node_exporter is crash-looping (Active will flip to activating rapidly)</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>node_exporter<span class="w"> </span>--no-pager<span class="w"> </span>-l

<span class="c1"># Reproduce the crash manually</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>/usr/bin/node_exporter<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--web.listen-address<span class="o">=</span><span class="m">127</span>.0.0.1:9102<span class="w"> </span>--collector.cpufreq<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">&amp;</span>
sleep<span class="w"> </span><span class="m">2</span>
curl<span class="w"> </span>-s<span class="w"> </span>http://127.0.0.1:9102/metrics<span class="w">   </span><span class="c1"># triggers panic</span>
<span class="c1"># Look for: panic: runtime error: slice bounds out of range</span>

<span class="c1"># Verify the workaround file is in place</span>
cat<span class="w"> </span>/opt/perfsonar-tp/conf/node_exporter.defaults<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>no-collector.cpufreq
</code></pre></div>
<p><strong>Solution:</strong></p>
<p>Run the seed script (which installs <code>node_exporter.defaults</code>) then restart:</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/seed_testpoint_host_dirs.sh
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>node_exporter
<span class="c1"># Verify</span>
curl<span class="w"> </span>-s<span class="w"> </span>http://127.0.0.1:9100/metrics<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-5
</code></pre></div>
<p>Or apply manually:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Add --no-collector.cpufreq to the options inside the container</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s1">&#39;s|NODE_EXPORTER_OPTS=&quot;|NODE_EXPORTER_OPTS=&quot;--no-collector.cpufreq |&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>/etc/default/node_exporter
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>node_exporter
</code></pre></div>
<p>Save the fix persistently by ensuring
<code>/opt/perfsonar-tp/conf/node_exporter.defaults</code> is mounted in <code>docker-compose.yml</code>
(already present in the compose files from this repo).</p>
<p><strong>Root cause — D-Bus / SELinux (--collector.systemd):</strong>
node_exporter uses <code>--collector.systemd</code> which connects to D-Bus. The compose file
mounts <code>/run/dbus:/run/dbus:ro</code>, but on EL9 with SELinux <strong>Enforcing</strong> the socket
label <code>system_dbusd_var_run_t</code> blocks the container process.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check for permission denied on the D-Bus socket</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>perfsonar-testpoint<span class="w"> </span>ls<span class="w"> </span>/run/dbus/system_bus_socket

<span class="c1"># Fix: enable the SELinux boolean</span>
setsebool<span class="w"> </span>-P<span class="w"> </span>container_use_dbusd<span class="w"> </span><span class="m">1</span>
</code></pre></div>
</details>
<h3 id="auto-update-issues">Auto-Update Issues<a class="headerlink" href="#auto-update-issues" title="Permanent link">&para;</a></h3>
<details class="failure">
<summary>Auto-update not working</summary>
<p><strong>Symptoms:</strong> Containers not updating despite new images available.</p>
<p><strong>Diagnostic steps:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check timer status</span>
systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-auto-update.timer
systemctl<span class="w"> </span>list-timers<span class="w"> </span>perfsonar-auto-update.timer

<span class="c1"># Check service logs</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>perfsonar-auto-update.service<span class="w"> </span>-n<span class="w"> </span><span class="m">100</span>

<span class="c1"># Check update log</span>
tail<span class="w"> </span>-50<span class="w"> </span>/var/log/perfsonar-auto-update.log

<span class="c1"># Manually test update</span>
systemctl<span class="w"> </span>start<span class="w"> </span>perfsonar-auto-update.service
</code></pre></div>
<p><strong>Solutions:</strong></p>
<ul>
<li>Enable timer if not active: <code>systemctl enable --now perfsonar-auto-update.timer</code></li>
<li>Verify script exists and is executable: <code>ls -la /usr/local/bin/perfsonar-auto-update.sh</code></li>
<li>If script is missing, reinstall from <code>tools_scripts/</code>:</li>
</ul>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--auto-update
</code></pre></div>
<ul>
<li>Manually check whether a newer image exists by comparing digests:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Digest of currently running container</span>
podman<span class="w"> </span>inspect<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>--format<span class="w"> </span><span class="s2">&quot;{{.Image}}&quot;</span>
<span class="c1"># Digest of what&#39;s in the registry</span>
podman<span class="w"> </span>pull<span class="w"> </span>hub.opensciencegrid.org/osg-htc/perfsonar-testpoint:production
podman<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>hub.opensciencegrid.org/osg-htc/perfsonar-testpoint:production<span class="w"> </span>--format<span class="w"> </span><span class="s2">&quot;{{.Id}}&quot;</span>
</code></pre></div>
<ul>
<li>If digests differ but the service didn't restart, run the update manually, then check the log:</li>
</ul>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>perfsonar-auto-update.service
journalctl<span class="w"> </span>-u<span class="w"> </span>perfsonar-auto-update.service<span class="w"> </span>-n<span class="w"> </span><span class="m">100</span>
tail<span class="w"> </span>-50<span class="w"> </span>/var/log/perfsonar-auto-update.log
</code></pre></div>
</details>
<h3 id="general-debugging-tips">General Debugging Tips<a class="headerlink" href="#general-debugging-tips" title="Permanent link">&para;</a></h3>
<details class="tip">
<summary>Useful debugging commands</summary>
<p><strong>Container management:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># View all containers (running and stopped)</span>
podman<span class="w"> </span>ps<span class="w"> </span>-a

<span class="c1"># View container resource usage</span>
podman<span class="w"> </span>stats

<span class="c1"># Enter container for interactive debugging</span>
podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>/bin/bash

<span class="c1"># View compose configuration</span>
<span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>podman-compose<span class="w"> </span>config
</code></pre></div>
<p><strong>Networking:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check which process is listening on a port</span>
ss<span class="w"> </span>-tlnp<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>&lt;port&gt;

<span class="c1"># Test connectivity to remote testpoint</span>
ping<span class="w"> </span>&lt;remote-ip&gt;
traceroute<span class="w"> </span>&lt;remote-ip&gt;

<span class="c1"># Check nftables rules</span>
nft<span class="w"> </span>list<span class="w"> </span>ruleset
</code></pre></div>
</details>
<details class="note">
<summary>What to include when reporting issues via email</summary>
<p>To help us diagnose install problems quickly, please include:</p>
<ul>
<li>Host details: OS version (e.g., <code>cat /etc/os-release</code>), kernel (<code>uname -r</code>), and whether this is testpoint or toolkit.</li>
<li>Script/log context: which script/step failed and the exact command you ran.</li>
<li>Timestamps: approximate time of failure and timezone.</li>
<li>Outputs/logs: relevant console output and excerpts from <code>journalctl -u podman -n 200</code>, <code>tail -200 /var/log/perfSONAR-install-nftables.log</code>, and any script-specific log mentioned in the error.</li>
<li>Network state: <code>ip -br addr</code>, <code>ip rule show</code>, <code>nmcli connection show</code>, and whether port 80/443 should be open externally.</li>
<li>Certificates (if LE): whether port 80 was reachable from the Internet and the contents of <code>/var/log/letsencrypt/letsencrypt.log</code> around the failure.</li>
<li>Contact info: your name, site, and a callback email.</li>
</ul>
<p>Send reports to your usual perfSONAR support contact or project mailing list with the subject prefix <code>[perfSONAR install issue]</code>.</p>
<p><strong>Logs:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># System journal for container runtime</span>
journalctl<span class="w"> </span>-u<span class="w"> </span>podman<span class="w"> </span>-n<span class="w"> </span><span class="m">100</span>

<span class="c1"># All logs from a container</span>
podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>--tail<span class="o">=</span><span class="m">100</span>

<span class="c1"># Follow logs in real-time</span>
podman<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>perfsonar-testpoint
</code></pre></div>
</details>
<hr />









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "toc.follow", "toc.integrate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>