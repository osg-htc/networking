
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://osg-htc.org/networking/personas/quick-deploy/install-perfsonar-testpoint/">
      
      
        <link rel="prev" href="../../../perfsonar/deployment-models/">
      
      
        <link rel="next" href="../automated-setup/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Quick Deploy (Testpoint) - OSG Networking Area</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-69012-29"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-69012-29",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-69012-29",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#installing-a-perfsonar-testpoint-for-wlcgosg" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="OSG Networking Area" class="md-header__button md-logo" aria-label="OSG Networking Area" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OSG Networking Area
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Quick Deploy (Testpoint)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/osg-htc/networking/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../landing/" class="md-tabs__link">
          
  
  
  Get Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../perfsonar-in-osg/" class="md-tabs__link">
          
  
  
  perfSONAR Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../host-network-tuning/" class="md-tabs__link">
          
  
  
  Host Tuning

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../troubleshoot/triage-checklist/" class="md-tabs__link">
          
  
  
  Troubleshooting

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../perfsonar/psetf/" class="md-tabs__link">
          
  
  
  Network Services & Data

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../perfsonar/tools_scripts/" class="md-tabs__link">
          
  
  
  Tools & Scripts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../features/fail2ban/" class="md-tabs__link">
          
  
  
  Advanced

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="OSG Networking Area" class="md-nav__button md-logo" aria-label="OSG Networking Area" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OSG Networking Area
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/osg-htc/networking/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Get Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Get Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy perfSONAR
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshoot Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../research/landing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Understand the System
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--active"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    perfSONAR Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    perfSONAR Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar-in-osg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why perfSONAR in OSG/WLCG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/deployment-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Quick Deploy (Testpoint)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Deploy (Testpoint)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites-and-planning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites and Planning
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#existing-perfsonar-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Existing perfSONAR configuration
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automated-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automated Setup
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Legacy Installation (Archive)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Host Tuning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Host Tuning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../host-network-tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fasterdata Host Tuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/multiple-nic-guidance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multiple NIC Guidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Troubleshooting
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/triage-checklist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Triage Checklist
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../network-troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Troubleshooting Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../network-troubleshooting/osg-debugging-document/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OSG Debugging Document
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Playbooks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Playbooks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/container-startup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Container Startup Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/tests-not-running/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tests Not Running
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/performance-issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance Issues
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/playbooks/firewall-issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firewall & Network Access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Network Services & Data
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Network Services & Data
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/psetf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Infrastructure Monitoring (PSETF)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../osg-network-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Datastore
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../osg-network-analytics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Analytics Platform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tools & Scripts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tools & Scripts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/fasterdata-tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fasterdata Tuning Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/README-lsregistration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LS Registration Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/perfSONAR-update-lsregistration.sh" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LS Registration Updater
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../perfsonar/tools_scripts/docker-compose.yml" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compose Bundles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Link-Check Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Security Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Security Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/fail2ban/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fail2ban
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/selinux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SELinux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/nftables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    nftables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../research/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Release Notes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Release Notes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.4.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.4.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.3.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.3.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.1.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.1.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.0.1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.0.1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release-notes/quick-deploy-1.0.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    v1.0.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../web-site-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Site Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../../perfsonar-in-osg/" class="md-path__link">
          
  <span class="md-ellipsis">
    perfSONAR Guides
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="installing-a-perfsonar-testpoint-for-wlcgosg">Installing a perfSONAR Testpoint for WLCG/OSG<a class="headerlink" href="#installing-a-perfsonar-testpoint-for-wlcgosg" title="Permanent link">&para;</a></h1>
<!-- markdownlint-disable MD040 -->

<p>This guide walks WLCG/OSG site administrators through end-to-end installation, configuration, and validation of a
perfSONAR testpoint on Enterprise Linux 9 (EL9). It uses automated tooling from this repository to streamline the
process while accommodating site-specific requirements.</p>
<hr />
<h2 id="prerequisites-and-planning">Prerequisites and Planning<a class="headerlink" href="#prerequisites-and-planning" title="Permanent link">&para;</a></h2>
<p>Before you begin, it may be helpful to gather the following information:</p>
<ul>
<li>
<p><strong>Hardware details:</strong> hostname, BMC/iLO/iDRAC credentials (if used), interface names, available storage locations.</p>
</li>
<li>
<p><strong>Network data:</strong> IPv4/IPv6 assignments for each NIC, default gateway, internal/external VLAN
  information.</p>
</li>
<li>
<p><strong>Operational contacts:</strong> site admin email, OSG facility/site name, latitude/longitude.</p>
</li>
</ul>
<h2 id="existing-perfsonar-configuration">Existing perfSONAR configuration<a class="headerlink" href="#existing-perfsonar-configuration" title="Permanent link">&para;</a></h2>
<p>If replacing an existing instance, you may want to back up <code>/etc/perfsonar/</code> files, especially
<code>lsregistrationdaemon.conf</code>, and any container volumes. We have a script named<code>perfSONAR-update-lsregistration.sh</code> to
extract/save/restore registration config that you may want to use.</p>
<details class="info">
<summary>Quick capture of existing lsregistration config (if you have a src)</summary>
<p>Download temporarily:</p>
<p><div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/perfSONAR-update-lsregistration.sh<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span>/tmp/update-lsreg.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/update-lsreg.sh
</code></pre></div>
``` text</p>
</details>
<!-- markdownlint-enable MD040 -->

<div class="codehilite"><pre><span></span><code><span class="n">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">downloaded</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">script</span><span class="p">:</span>

<span class="err">```</span>

<span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">update</span><span class="o">-</span><span class="n">lsreg</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="o">--</span><span class="n">output</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">restore</span><span class="o">-</span><span class="n">lsreg</span><span class="o">.</span><span class="n">sh</span>
<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Note: Repository clone instructions are in Step 2.

&gt; **Note:** All shell commands assume an interactive root shell.

---

## Step 1 – Install and Harden EL9

1. **Provision EL9:** Install AlmaLinux, Rocky Linux, or RHEL 9 with the *Minimal* profile.

1. **Set the hostname and time sync:** Pick the NIC that will own the default route for the hostname.
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```bash
hostnamectl set-hostname &lt;testpoint-hostname&gt;
systemctl enable --now chronyd
timedatectl set-timezone &lt;Region/City&gt;

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. **Disable unused services:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
<span class="nv">systemctl</span><span class="w"> </span><span class="nv">disable</span><span class="w"> </span><span class="o">--</span><span class="nv">now</span><span class="w"> </span><span class="nv">firewalld</span><span class="w"> </span><span class="nv">NetworkManager</span><span class="o">-</span><span class="k">wait</span><span class="o">-</span><span class="nv">online</span>
<span class="nv">dnf</span><span class="w"> </span><span class="nv">remove</span><span class="w"> </span><span class="o">-</span><span class="nv">y</span><span class="w"> </span><span class="nv">rsyslog</span>
```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    ??? info &quot;Why disable unused services?&quot;

We recommend disabling unused services during initial provisioning to reduce complexity and avoid unexpected
interference with network and container setup. Services such as `firewalld`, `NetworkManager-wait-online`, and `rsyslog`
can alter networking state, hold boot or network events, or conflict with the automated nftables/NetworkManager changes
performed by the helper scripts. Disabling non-essential services makes the install deterministic, reduces the host
attack surface, and avoids delays or race conditions while configuring policy-based routing, nftables rules, and

container networking.

1. **Update the system:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```bash
dnf -y update


```
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. **Record NIC names:** Document interface mappings for later PBR configuration.
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="nx">bash</span>
<span class="nx">nmcli</span><span class="w"> </span><span class="nx">device</span><span class="w"> </span><span class="nx">status</span>
<span class="nx">ip</span><span class="w"> </span><span class="o">-</span><span class="nx">br</span><span class="w"> </span><span class="kd">addr</span>
<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>---

## Step 2 – Choose Your Deployment Path

After completing Step 1 (minimal OS hardening), you can proceed in one of two ways:

### Path A: Orchestrated Guided Install (Recommended for New Deployments)

The orchestrator automates package installation, bootstrap, PBR configuration, security hardening, container deployment,
certificate issuance, and pSConfig enrollment with interactive pauses (or non-interactive batch mode).

**Download and run the orchestrator:**
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>

<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/perfSONAR-orchestrator.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/perfSONAR-orchestrator.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/perfSONAR-orchestrator.sh

/tmp/perfSONAR-orchestrator.sh
</code></pre></div>
<div class="highlight"><pre><span></span><code>**Interactive mode** (pause at each step, confirm/skip/quit):
</code></pre></div>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh
</code></pre></div>
<div class="highlight"><pre><span></span><code>**Non-interactive mode** (auto-confirm all steps):
</code></pre></div>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh<span class="w"> </span>--non-interactive<span class="w"> </span>--option<span class="w"> </span>A
</code></pre></div>
<div class="highlight"><pre><span></span><code>**With Let&#39;s Encrypt (Option B):**
</code></pre></div>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh<span class="w"> </span>--option<span class="w"> </span>B<span class="w"> </span>--fqdn<span class="w"> </span>&lt;FQDN&gt;<span class="w"> </span>--email<span class="w"> </span>&lt;EMAIL&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code>**Flags:**

- `--option {A|B}` — A = testpoint only; B = testpoint + Let&#39;s Encrypt

- `--fqdn NAME` — primary FQDN for certificates (Option B)

- `--email ADDRESS` — email for Let&#39;s Encrypt (Option B)

- `--non-interactive` — skip pauses, auto-confirm

- `--yes` — auto-confirm internal script prompts

- `--dry-run` — preview steps without executing


- `--auto-update` — install and enable a systemd timer that pulls container images daily and restarts containers only if updated (creates `/usr/local/bin/perfsonar-auto-update.sh`, a systemd service and timer)

**If you choose this path, skip to Step 7** (the orchestrator completes Steps 2–6 for you).

---


### Path B: Manual Step-by-Step

For users who prefer granular control or need to customize each stage, continue with manual package installation,
bootstrap, and configuration.

#### Step 2.1 – Install Base Packages

On minimal hosts several required tools (e.g. `dig`, `nft`, `podman-compose`) are missing. Install all recommended
prerequisites in one command:
</code></pre></div>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>podman<span class="w"> </span>podman-docker<span class="w"> </span>podman-compose<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>jq<span class="w"> </span>curl<span class="w"> </span>tar<span class="w"> </span>gzip<span class="w"> </span>rsync<span class="w"> </span>bind-utils<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>nftables<span class="w"> </span>fail2ban<span class="w"> </span>policycoreutils-python-utils<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python3<span class="w"> </span>iproute<span class="w"> </span>iputils<span class="w"> </span>procps-ng<span class="w"> </span>sed<span class="w"> </span>grep<span class="w"> </span>gawk
</code></pre></div>
<div class="highlight"><pre><span></span><code>This ensures all subsequent steps (PBR generation, DNS checks, firewall hardening, container deployment) have their

dependencies available.

#### Step 2.2 – Bootstrap Helper Scripts

Use the bootstrap script to install helper scripts under `/opt/perfsonar-tp/tools_scripts`:
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>

<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install_tools_scripts.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install_tools_scripts.sh
/tmp/install_tools_scripts.sh<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<div class="highlight"><pre><span></span><code>**Verify bootstrap completed successfully:**
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Check that all helper scripts were downloaded</span>

ls<span class="w"> </span>-1<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/*.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
<span class="c1"># Should show 11 shell scripts</span>

<span class="c1"># Verify key scripts are present and executable</span>

ls<span class="w"> </span>-l<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/<span class="o">{</span>perfSONAR-pbr-nm.sh,perfSONAR-install-nftables.sh,perfSONAR-orchestrator.sh<span class="o">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>---

## Step 3 – Configure Policy-Based Routing (PBR)

!!! note &quot;Skip this step if you used the orchestrator (Path A)&quot;

The orchestrator automates PBR configuration. If you ran it in Step 2, skip to [Step 4](#step-4-configure-nftables-
selinux-and-fail2ban).

The script `/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh` automates NetworkManager profiles and routing rule
setup. It fills out and consumes the network configuration in `/etc/perfSONAR-multi-nic-config.conf`.

### Modes

By default the script now performs an **in-place apply** that adjusts routes, rules, and NetworkManager connection
properties **without deleting existing connections or flushing all system routes**. This minimizes disruption and
usually avoids the need for a reboot.

An optional destructive mode `--rebuild-all` performs the original full workflow: backup existing profiles, flush all
routes and rules, remove every NetworkManager connection, then recreate connections from scratch. Use this only for
initial deployments or when you must completely reset inconsistent legacy state.

| Mode | Flag | Disruption | When to use | |------|------|------------|-------------| | In-place (default) | (none) or
`--apply-inplace` | Low (interfaces stay up; rules adjusted) | Routine updates, gateway changes, add routes | | Full
rebuild | `--rebuild-all` | High (connections removed; brief connectivity drop) | First-time setup, severe
misconfiguration |

### Safety Enhancements

- Detects active SSH session interface and avoids extra disruption to that NIC in in-place mode.


- Prompts are still skipped with `--yes`.

- Dry-run preview supported via `--dry-run` (combine with `--debug` for verbose output).


- Reboot is **no longer generally required**; only consider one if NetworkManager fails to apply the new rules cleanly.

1. **Generate config file automatically (or preview):**

    !!! warning &quot;Gateways required for addresses&quot;

Any NIC with an IPv4 address must also have an IPv4 gateway, and any NIC with an IPv6 address must have an IPv6 gateway.
If the generator cannot detect a gateway, it adds a WARNING block to the generated file listing affected NICs. Edit
`NIC_IPV4_GWS`/`NIC_IPV6_GWS` accordingly before applying changes.

    !!! note &quot;Gateway prompts&quot;

During generation, the script attempts to detect gateways per-NIC. If a NIC has an IP address but no gateway could be
determined, it will prompt you interactively to enter an IPv4 and/or IPv6 gateway (or `-` to skip). Prompts are skipped
in non-interactive sessions or when you use `--yes`.

    Preview generation (no changes):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">debug</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Generate and write the config file:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">auto</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>The script writes the config file to `/etc/perfSONAR-multi-nic-config.conf`. Edit to adjust site-specific values (e.g.,
confirm `DEFAULT_ROUTE_NIC`, add `NIC_IPV4_ADDROUTE` entries) and verify the entries.  Next step is to apply the network
changes...


1. **Apply changes (in-place default):**

    !!! warning &quot;Connect via console for network changes&quot;

When applying network changes across an ssh connection, your session may be interrupted.   Please try to run the

perfSONAR-pbr-nm.sh script when connected either directly to the console or by using &#39;nohup&#39; in front of the script
invocation.

        **If SSH connection drops during network reconfiguration:**

1. Access via BMC/iLO/iDRAC console or physical console

1. Review `/var/log/perfSONAR-multi-nic-config.log` for errors

1. Check network state with `nmcli connection show` and `ip addr`


1. Restore from backup if needed: backups are in `/var/backups/nm-connections-&lt;timestamp&gt;/`

1. Reapply config after corrections: `/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes`


    In-place apply (recommended):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">yes</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Full rebuild (destructive – removes all NM connections first):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">rebuild</span><span class="o">-</span><span class="n">all</span><span class="w"> </span><span class="o">--</span><span class="n">yes</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>The script logs to `/var/log/perfSONAR-multi-nic-config.log`. After an in-place apply, a reboot is typically
unnecessary. If connectivity or rules appear inconsistent (`ip rule show` / `ip route` mismatch), consider a manual
NetworkManager restart:
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```bash
systemctl restart NetworkManager

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. **DNS: forward and reverse entries (required):**

All IP addresses that will be used for perfSONAR testing MUST have DNS entries: a forward (A/AAAA) record and a matching
reverse (PTR) record. This is required so remote test tools and site operators can reliably reach and identify your
host, and because some measurement infrastructure and registration systems perform forward/reverse consistency checks.


- For single-stack IPv4-only hosts: ensure A and PTR are present and consistent.

- For single-stack IPv6-only hosts: ensure AAAA and PTR are present and consistent.

- For dual-stack hosts: both IPv4 and IPv6 addresses used for testing must have matching forward and reverse records (A+PTR and AAAA+PTR).


??? example &quot;Run the DNS checker&quot; Validate forward/reverse DNS for addresses in `/etc/perfSONAR-multi-nic-config.conf`.
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">check</span><span class="o">-</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">dns</span><span class="o">.</span><span class="n">sh</span>

<span class="w">    </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Notes and automation tips:**

- The script above uses `dig` (bind-utils package) which is commonly available; you can adapt it
      to use `host` if preferred.

- Run the check as part of your provisioning CI or as a pre-flight check before enabling measurement registration.

- For large sites or many addresses, parallelize the checks (xargs -P) or use a small Python
      script that leverages `dns.resolver` for async checks.

- If your PTR returns a hostname with a trailing dot, the script strips it before the forward check.

If any addresses fail these checks, correct the DNS zone (forward and/or reverse) and allow DNS propagation before
proceeding with registration and testing.

1. **Verify the routing policy:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
<span class="nv">nmcli</span><span class="w"> </span><span class="nv">connection</span><span class="w"> </span><span class="k">show</span>
<span class="nv">ip</span><span class="w"> </span><span class="nv">rule</span><span class="w"> </span><span class="k">show</span>
<span class="nv">ip</span><span class="w"> </span><span class="nv">route</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="nv">table</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">table</span><span class="o">-</span><span class="nv">id</span><span class="o">&gt;</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>Confirm that non-default interfaces have their own routing tables and that the default interface owns the system default
route.

---

## Step 4 – Configure nftables, SELinux, and Fail2Ban

!!! note &quot;Skip this step if you used the orchestrator (Path A)&quot;

The orchestrator automates security hardening. If you ran it in Step 2, skip to [Step 5](#step-5-deploy-the-
containerized-perfsonar-testpoint).

Use `/opt/perfsonar-tp/tools_scripts/perfSONAR-install-nftables.sh` to configure a hardened nftables profile with
optional SELinux and Fail2Ban support. No staging or copy step is required.

Prerequisites (not installed by the script and should have been installed when check-deps.sh was run above):


- `nftables` must already be installed and available (`nft` binary) for firewall configuration.

- `fail2ban` must be installed if you want the optional jail configuration.


- SELinux tools (e.g., `getenforce`, `policycoreutils`) must be present to attempt SELinux configuration.

If any prerequisite is missing, the script skips that component and continues.

1. **Install/configure the desired options:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">nftables</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">selinux</span><span class="w"> </span><span class="o">--</span><span class="n">fail2ban</span><span class="w"> </span><span class="o">--</span><span class="n">yes</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>- Use `--yes` to skip the interactive confirmation prompt (omit it if you prefer to review the
      summary and answer manually).

- Add `--dry-run` for a rehearsal that only prints the planned actions.

The script writes nftables rules for perfSONAR services, derives SSH allow-lists from `/etc/perfSONAR-multi-nic-
config.conf`, optionally adjusts SELinux, and enables Fail2ban jails—only if those components are already installed.

    ??? info &quot;SSH allow-lists and validation&quot;

- Derives SSH allow-lists from `/etc/perfSONAR-multi-nic-config.conf` (CIDR prefixes and addresses).

- Validates nftables rules before writing.

- Outputs: rules to `/etc/nftables.d/perfsonar.nft`, log to `/var/log/perfSONAR-install-nftables.log`, backups to `/var/backups/`.

??? tip &quot;Preview nftables rules before applying&quot; You can preview the fully rendered nftables rules (no changes are

made):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>

<span class="w">    </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">nftables</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">rules</span>

<span class="w">    </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    ??? tip &quot;Manually add extra management hosts/subnets&quot;

If you need to allow additional SSH sources not represented by your NIC-derived prefixes, edit
`/etc/nftables.d/perfsonar.nft` and add entries to the appropriate sets. Example:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="nx">nft</span>
<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip4_subnets</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv4_addr</span>
<span class="w">        </span><span class="nx">flags</span><span class="w"> </span><span class="nx">interval</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="m m-Double">192.0.2.0</span><span class="o">/</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">198.51.100.0</span><span class="o">/</span><span class="mi">25</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip4_hosts</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv4_addr</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="m m-Double">203.0.113.10</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">203.0.113.11</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip6_subnets</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv6_addr</span>
<span class="w">        </span><span class="nx">flags</span><span class="w"> </span><span class="nx">interval</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2001</span><span class="p">:</span><span class="nx">db8</span><span class="p">:</span><span class="mi">1</span><span class="o">::/</span><span class="mi">64</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip6_hosts</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv6_addr</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2001</span><span class="p">:</span><span class="nx">db8</span><span class="o">::</span><span class="mi">10</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Then validate and reload (root shell):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="n">nft</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nftables</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">.</span><span class="n">nft</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="n">nftables</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">nftables</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. **Confirm nftables state and security services:**

    ??? info &quot;Verification commands&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code>    ```bash
    nft list ruleset
    sestatus
    systemctl status fail2ban

    ```
</code></pre></div>

<div class="highlight"><pre><span></span><code>You may want to document any site-specific exceptions (e.g., additional allowed management hosts) in your change log.

---

## Step 5 – Deploy the Containerized perfSONAR Testpoint


!!! note &quot;Skip this step if you used the orchestrator (Path A)&quot;

The orchestrator automates container deployment and certificate issuance. If you ran it in Step 2, skip to [Step

6](#step-6-configure-and-enroll-in-psconfig).

Run the official testpoint image using Podman (or Docker). Choose one of the two deployment modes:

- Option A: Testpoint only (simplest) — only bind-mount `/opt/perfsonar-tp/psconfig` for pSConfig.

- Option B: Testpoint + Let’s Encrypt — two containers that share Apache files and certs via host bind mounts.

Use `podman-compose` (or `docker-compose`) in the examples below.

### Option A — Testpoint only (simplest)

Prepare the pSConfig directory and a minimal compose file. No other host bind-mounts are required.
</code></pre></div>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/perfsonar-tp/psconfig
</code></pre></div>
<div class="highlight"><pre><span></span><code>Download a ready-made compose file (or copy it manually): Browse: [repo
view](https://github.com/osghtc/networking/blob/master/docs/perfsonar/tools_scripts/docker-compose.testpoint.yml)
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/docker-compose.testpoint.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<div class="highlight"><pre><span></span><code>Edit the `docker-compose.yml` as desired.

Bring it up:
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">(</span><span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp<span class="p">;</span><span class="w"> </span>podman-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="o">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Verify the container is running and healthy:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>ps
</code></pre></div>
<div class="highlight"><pre><span></span><code>The container should show `healthy` status. The healthcheck monitors Apache HTTPS availability.

That&#39;s it for the testpoint-only mode. Manage pSConfig files under `/opt/perfsonar-tp/psconfig` on the host; they are
consumed by the container at `/etc/perfsonar/psconfig`. Jump to Step 6 below.

#### Ensure containers restart automatically on reboot (systemd unit for testpoint - REQUIRED)

!!! warning &quot;podman-compose limitation with systemd containers&quot;

The perfSONAR testpoint image runs **systemd internally** and requires the `--systemd=always` flag to function
correctly. **podman-compose does not support this flag**, which causes containers to crash-loop after reboot with exit
code 255.

    You **must** use the systemd unit approach below instead of relying on compose alone.

Install the provided systemd units to manage containers with proper systemd support:
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install testpoint-only systemd unit</span>

/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp

<span class="c1"># Enable and start now</span>

systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service


<span class="c1"># Verify service and containers</span>

systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>--no-pager
podman<span class="w"> </span>ps
</code></pre></div>
<div class="highlight"><pre><span></span><code>Notes:

- The service uses `podman run --systemd=always` to enable proper systemd operation inside the container

- The compose file is kept for reference but not used by the systemd units

- If you need to update container configuration, edit the systemd unit file directly: `/etc/systemd/system/perfsonar-testpoint.service`

- After editing the unit file, reload and restart: `systemctl daemon-reload &amp;&amp; systemctl restart perfsonar-testpoint.service`

---

### Option B — Testpoint + Let&#39;s Encrypt (shared Apache and certs)

This mode runs two containers (`perfsonar-testpoint` and `certbot`) and bind-mounts the following host paths so Apache
content and certificates persist on the host and are shared between containers:

- `/opt/perfsonar-tp/psconfig` → `/etc/perfsonar/psconfig` — perfSONAR configuration

- `/var/www/html` → `/var/www/html` — Apache webroot (shared for HTTP-01 challenges)

- `/etc/apache2` → `/etc/apache2` — Apache configuration (for SSL certificate patching)

- `/etc/letsencrypt` → `/etc/letsencrypt` — Let&#39;s Encrypt certificates and state

#### 1) Seed required host directories (REQUIRED before first compose up)

**Why seed?** The perfsonar-testpoint container requires baseline configuration files from the image to be present on
the host filesystem. Without seeding, the bind-mounted directories would be empty, causing Apache and perfSONAR services
to fail.

**What&#39;s seeded:**

- `/opt/perfsonar-tp/psconfig` — perfSONAR pSConfig files (baseline remotes and archives)

- `/var/www/html` — Apache webroot with index.html (required for healthcheck)

- `/etc/apache2` — Apache config including `sites-available/default-ssl.conf` (patched by entrypoint wrapper)

**What&#39;s NOT seeded:**

- `/etc/letsencrypt` — Certbot creates this automatically; no pre-seeding needed

Run the bundled seeding helper script (automatically installed in Step 2):
</code></pre></div>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/seed_testpoint_host_dirs.sh
</code></pre></div>
<div class="highlight"><pre><span></span><code>This script:

- Pulls the latest perfSONAR testpoint image

- Creates temporary containers to extract baseline files

- Copies content to host directories


- Verifies seeding was successful

- Skips seeding if directories already have content (idempotent)

Verify seeding succeeded:
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Should show config files</span>

ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/psconfig


<span class="c1"># Should show index.html and perfsonar/ directory</span>

ls<span class="w"> </span>-la<span class="w"> </span>/var/www/html

<span class="c1"># Should show sites-available/, sites-enabled/, etc.</span>

ls<span class="w"> </span>-la<span class="w"> </span>/etc/apache2
</code></pre></div>
<div class="highlight"><pre><span></span><code>??? tip &quot;SELinux labeling handled automatically&quot;

If SELinux is enforcing, the `:Z` and `:z` options in the compose files will cause Podman to relabel the host paths when

containers start. No manual `chcon` commands are required.

    **SELinux Volume Labels:**

- `:Z` (uppercase) - Exclusive access. Podman creates a unique SELinux label for this volume that only this specific container can access. Use for volumes that should not be shared between containers.

- `:z` (lowercase) - Shared access. Podman uses a shared SELinux label that multiple containers can access. Use for volumes that need to be accessed by multiple containers.

    In our compose files:

- `/etc/letsencrypt:/etc/letsencrypt:Z` - Exclusive to testpoint container

- `/var/www/html:/var/www/html:z` - Shared between testpoint and certbot containers

- `/etc/apache2:/etc/apache2:Z` - Exclusive to testpoint container

#### 2) Deploy the testpoint with automatic SSL patching (recommended)

**Prerequisites:** Ensure `/opt/perfsonar-tp/tools_scripts` exists from Step 2 (bootstrap):
</code></pre></div>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh
</code></pre></div>
<div class="highlight"><pre><span></span><code>If the file is missing, run the Step 2 bootstrap first:
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>bash<span class="w"> </span>-s<span class="w"> </span>--<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<div class="highlight"><pre><span></span><code>Deploy using the compose file with automatic Apache SSL certificate patching. This approach uses an entrypoint wrapper
that auto-discovers Let&#39;s Encrypt certificates on container startup and automatically patches the Apache configuration.

Download the auto-patching compose file:
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/docker-compose.testpoint-le-auto.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<div class="highlight"><pre><span></span><code>**Note:** The `SERVER_FQDN` environment variable is **optional**. The entrypoint wrapper will auto-discover certificates

in `/etc/letsencrypt/live` and use the first one found. Only set `SERVER_FQDN` if you have multiple certificates and
need to specify which one to use.


If you want to explicitly set the FQDN (optional):
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Optional: only needed if you have multiple certificates</span>

sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/# - SERVER_FQDN=.*/- SERVER_FQDN=&lt;YOUR_FQDN&gt;/&#39;</span><span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<div class="highlight"><pre><span></span><code>Start the containers:
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp
podman-compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>
<div class="highlight"><pre><span></span><code>At this point, the testpoint is running with self-signed certificates. The certbot container is also running but won&#39;t
renew anything until you obtain the initial certificates.

#### Ensure containers restart automatically on reboot (systemd units for testpoint &amp; certbot - REQUIRED)

!!! warning &quot;podman-compose limitation with systemd containers&quot;

The perfSONAR testpoint image runs **systemd internally** and requires the `--systemd=always` flag to function
correctly. **podman-compose does not support this flag**, which causes containers to crash-loop after reboot with exit
code 255.

    You **must** use the systemd unit approach below instead of relying on compose alone.

Install and enable the systemd units so containers start on boot with proper systemd support:
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install both testpoint and certbot systemd units</span>

/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span>--with-certbot

<span class="c1"># Enable and start services</span>

systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># Verify services</span>


systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>perfsonar-certbot.service<span class="w"> </span>--no-pager
podman<span class="w"> </span>ps
</code></pre></div>
<div class="highlight"><pre><span></span><code>#### 3) Obtain your first Let&#39;s Encrypt certificate (one-time)


Use Certbot in standalone mode to obtain the initial certificates. The perfsonar-testpoint image is patched to NOT
listen on port 80, so port 80 is available for Certbot&#39;s HTTP-01 challenge.

**Important:** Stop the certbot sidecar temporarily to free port 80:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>stop<span class="w"> </span>certbot
</code></pre></div>
<div class="highlight"><pre><span></span><code>Now run Certbot standalone with host networking to bind port 80:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/etc/letsencrypt:/etc/letsencrypt:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/var/www/html:/var/www/html:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>docker.io/certbot/certbot:latest<span class="w"> </span>certonly<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--standalone<span class="w"> </span>--agree-tos<span class="w"> </span>--non-interactive<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span>&lt;SERVER_FQDN&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;ALT_FQDN&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-m<span class="w"> </span>&lt;LETSENCRYPT_EMAIL&gt;
</code></pre></div>
<div class="highlight"><pre><span></span><code>??? info &quot;Certbot command explained&quot;


    **Podman options:**

- `--rm` - Remove container after it exits

- `--net=host` - Use host network (allows binding port 80)


- `-v /etc/letsencrypt:/etc/letsencrypt:Z` - Mount certificate storage with exclusive SELinux label

- `-v /var/www/html:/var/www/html:Z` - Mount webroot for HTTP-01 challenge

    **Certbot options:**

- `certonly` - Obtain certificate only, don&#39;t install it

- `--standalone` - Run standalone HTTP server on port 80 for ACME HTTP-01 challenge

- `--agree-tos` - Agree to Let&#39;s Encrypt Terms of Service

- `--non-interactive` - Don&#39;t prompt for input (required for automation)

- `-d &lt;FQDN&gt;` - Domain name(s) for the certificate (repeat for each domain/SAN)

- `-m &lt;EMAIL&gt;` - Email for renewal notifications and account recovery

Replace:

- `&lt;SERVER_FQDN&gt;` with your primary hostname (e.g., `psum05.aglt2.org`)

- `&lt;ALT_FQDN&gt;` with additional FQDNs if needed (one `-d` flag per FQDN)

- `&lt;LETSENCRYPT_EMAIL&gt;` with your email for certificate notifications


After successful issuance, restart the perfsonar-testpoint container to trigger the automatic patching:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>restart<span class="w"> </span>perfsonar-testpoint
</code></pre></div>
<div class="highlight"><pre><span></span><code>Check the logs to verify the SSL config was patched:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;Patching Apache&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>You should see output confirming the certificate paths were updated.

#### 4) Restart the certbot sidecar for automatic renewals

Now that certificates are in place, restart the certbot sidecar to enable automatic renewals:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>start<span class="w"> </span>certbot
</code></pre></div>
<div class="highlight"><pre><span></span><code>The certbot container runs a renewal loop that checks for expiring certificates every 12 hours.

**Automatic Container Restart:** After each successful certificate renewal, certbot automatically runs a deploy hook
script (`certbot-deploy-hook.sh`) that gracefully restarts the `perfsonar-testpoint` container. This ensures the new
certificates are loaded without manual intervention. The deploy hook uses the mounted Podman socket

(`/run/podman/podman.sock`) to communicate with the host&#39;s container runtime.

**Note:** The certbot container in this setup uses **host networking mode** (via `network_mode: host` in the compose
file) so it can bind directly to port 80 for HTTP-01 challenges during renewals. This works because the perfsonar-
testpoint Apache is patched to NOT listen on port 80. Both containers share the host network namespace without conflict.

Test renewal with a dry-run:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>certbot<span class="w"> </span>certbot<span class="w"> </span>renew<span class="w"> </span>--dry-run
</code></pre></div>
<div class="highlight"><pre><span></span><code>If successful, certificates will auto-renew before expiry, and the testpoint will be automatically restarted to load the
new certificates. You can verify this behavior by checking the certbot logs after a renewal:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>logs<span class="w"> </span>certbot<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;deploy hook&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>---

??? info &quot;Alternative: Manual SSL Patching (without automatic entrypoint wrapper)&quot;


If you prefer not to use the automatic patching entrypoint wrapper, you can use the standard compose file and manually
patch the Apache SSL configuration after obtaining certificates.

1. Use `docker-compose.testpoint-le.yml` instead of `docker-compose.testpoint-le-auto.yml`


1. After obtaining Let&#39;s Encrypt certificates, run:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">patch_apache_ssl_for_letsencrypt</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">&lt;</span><span class="n">SERVER_FQDN</span><span class="o">&gt;</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Reload Apache in the running container:
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">apachectl</span><span class="w"> </span><span class="o">-</span><span class="nv">k</span><span class="w"> </span><span class="nv">graceful</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>This approach requires manual intervention after initial certificate issuance and any time the container is recreated.
The automatic approach (using the entrypoint wrapper) eliminates this manual step.

??? warning &quot;Troubleshooting: Container fails with &#39;executable file not found&#39; error&quot;

**Error:** `Error: unable to start container: crun: executable file /opt/perfsonar-tp/tools_scripts/testpoint-
entrypoint-wrapper.sh not found`

**Cause:** The `/opt/perfsonar-tp/tools_scripts` directory doesn&#39;t exist or the entrypoint wrapper wasn&#39;t downloaded.

    **Fix:** Run the Step 2 bootstrap script to fetch all helper scripts:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span>\
<span class="w">    </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">osg</span><span class="o">-</span><span class="n">htc</span><span class="o">/</span><span class="n">networking</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">install_tools_scripts</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span>\
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">bash</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Then verify the entrypoint wrapper exists:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">testpoint</span><span class="o">-</span><span class="n">entrypoint</span><span class="o">-</span><span class="n">wrapper</span><span class="o">.</span><span class="n">sh</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    If you&#39;ve already started the container and it failed, remove it before retrying:
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```bash

podman-compose down
podman-compose up -d

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>---

## Step 6 – Configure and Enroll in pSConfig

!!! note &quot;Skip this step if you used the orchestrator (Path A)&quot;

The orchestrator automates pSConfig enrollment. If you ran it in Step 2, skip to [Step 7](#step-7-register-and-
configure-with-wlcgosg).

We need to enroll your testpoint with the OSG/WLCG pSConfig service so tests are auto-configured. Use the &quot;auto URL&quot; for

each FQDN you expose for perfSONAR (one or two depending on whether you split latency/throughput by hostname).

Basic enroll (interactive root on the host; runs inside the container) if you have only one entry to make (automation
alternative below):
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Add auto URLs (configures archives too) and show configured remotes</span>

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>--configure-archives<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;https://psconfig.opensciencegrid.org/pub/auto/ps-lat-example.my.edu&quot;</span>

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>list
</code></pre></div>
<div class="highlight"><pre><span></span><code>If there are any stale/old/incorrect entries, you can remove them:
</code></pre></div>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>delete<span class="w"> </span><span class="s2">&quot;&lt;old-url&gt;&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Automation tip: derive FQDNs from your configured IPs (PTR lookup) and enroll automatically. Review the list before
applying.
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Dry run only (show planned URLs):</span>

/opt/perfsonar-tp/tools_scripts/perfSONAR-auto-enroll-psconfig.sh<span class="w"> </span>-n

<span class="c1"># Typical usage (podman):</span>

/opt/perfsonar-tp/tools_scripts/perfSONAR-auto-enroll-psconfig.sh<span class="w"> </span>-v

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>list
</code></pre></div>
<div class="highlight"><pre><span></span><code>??? note &quot;The auto enroll script details&quot;

- Parses IP lists from `/etc/perfSONAR-multi-nic-config.conf`  (`NIC_IPV4_ADDRS` / `NIC_IPV6_ADDRS`).


- Performs reverse DNS lookups (getent/dig) to derive FQDNs.

- Deduplicates while preserving discovery order.

- Adds each `https://psconfig.opensciencegrid.org/pub/auto/&lt;FQDN&gt;` with `--configure-archives`.

- Lists configured remotes and returns non-zero if any enrollment fails.

Integrate into provisioning CI by running with `-n` (dry-run) for approval and then `-y` once approved.

---

## Step 7 – Register and Configure with WLCG/OSG

1. **OSG/WLCG registration workflow:**

    ??? info &quot;Registration steps and portals&quot;

- Register the host in [OSG topology](https://topology.opensciencegrid.org/host).


- Create or update a [GGUS](https://ggus.eu/) ticket announcing the new measurement point.

- In [GOCDB](https://goc.egi.eu/portal/), add the service endpoint
                `org.opensciencegrid.crc.perfsonar-testpoint` bound to this host.

1. **Document memberships:** update your site wiki or change log with assigned mesh names, feed  URLs, and support contacts.

1. **Update Lookup Service registration inside the container**

Use the helper script to edit `/etc/perfsonar/lsregistrationdaemon.conf` inside the running `perfsonar-testpoint`
container and restart the daemon only if needed.

    Install and run examples below, pick which type you want (root shell):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Preview changes only (uses the copy from /opt/perfsonar-tp/tools_scripts)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">lsregistration</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">update</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">site</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;Acme Co.&quot;</span><span class="w"> </span><span class="o">--</span><span class="n">project</span><span class="w"> </span><span class="n">WLCG</span><span class="w"> </span>\

<span class="w">    </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">email</span><span class="w"> </span><span class="n">admin</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="w"> </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;pS Admin&quot;</span>

<span class="c1"># Restore previously saved settings from the Prerequisites extract (if you saved a restore script earlier)</span>
<span class="n">bash</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">restore</span><span class="o">-</span><span class="n">lsreg</span><span class="o">.</span><span class="n">sh</span>


<span class="c1"># Apply new settings and restart the daemon inside the container</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">lsregistration</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">create</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">site</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;Acme Co.&quot;</span><span class="w"> </span><span class="o">--</span><span class="n">domain</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="w"> </span><span class="o">--</span><span class="n">project</span><span class="w"> </span><span class="n">WLCG</span><span class="w"> </span><span class="o">--</span><span class="n">project</span><span class="w"> </span><span class="n">OSG</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">city</span><span class="w"> </span><span class="n">Berkeley</span><span class="w"> </span><span class="o">--</span><span class="n">region</span><span class="w"> </span><span class="n">CA</span><span class="w"> </span><span class="o">--</span><span class="n">country</span><span class="w"> </span><span class="n">US</span><span class="w"> </span><span class="o">--</span><span class="n">zip</span><span class="w"> </span><span class="mi">94720</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">latitude</span><span class="w"> </span><span class="mf">37.5</span><span class="w"> </span><span class="o">--</span><span class="n">longitude</span><span class="w"> </span><span class="o">-</span><span class="mf">121.7469</span><span class="w"> </span>\

<span class="w">    </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;pS Admin&quot;</span><span class="w"> </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">email</span><span class="w"> </span><span class="n">admin</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">org</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. **Automatic image updates and safe restarts**

    Keep containers current and only restart them when their image actually changes.

    ??? info &quot;Auto-update for compose-managed containers&quot;

Since these containers are managed by `podman-compose`, we use a different approach than systemd-managed containers.
Create a simple script and systemd timer to periodically pull new images and restart containers if updates are

available.

1. Create an update script:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="err">```</span><span class="n">bash</span>
<span class="w">        </span><span class="n">cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">&#39;EOF&#39;</span>
<span class="w">        </span><span class="c1">#!/bin/bash</span>

<span class="w">        </span><span class="c1"># perfsonar-auto-update.sh - Check for and apply container image updates</span>

<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">-</span><span class="n">e</span>

<span class="w">        </span><span class="n">COMPOSE_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/perfsonar-tp&quot;</span>
<span class="w">        </span><span class="n">LOGFILE</span><span class="o">=</span><span class="s2">&quot;/var/log/perfsonar-auto-update.log&quot;</span>

<span class="w">        </span><span class="nb">log</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;$(date -Iseconds) $*&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="s2">&quot;$LOGFILE&quot;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">cd</span><span class="w"> </span><span class="s2">&quot;$COMPOSE_DIR&quot;</span>

<span class="w">        </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;Checking for image updates...&quot;</span>

<span class="w">        </span><span class="c1"># Pull latest images</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">podman</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="s2">&quot;$LOGFILE&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="s2">&quot;Downloaded newer image&quot;</span><span class="p">;</span><span class="w"> </span><span class="n">then</span>
<span class="w">            </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;New images found - recreating containers...&quot;</span>
<span class="w">            </span><span class="n">podman</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">-</span><span class="n">d</span>
<span class="w">            </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;Containers updated successfully&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;No updates available&quot;</span>
<span class="w">        </span><span class="n">fi</span>
<span class="w">        </span><span class="n">EOF</span>

<span class="w">        </span><span class="n">chmod</span><span class="w"> </span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">sh</span>


<span class="w">        </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Create a systemd service:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="err">```</span><span class="n">bash</span>

<span class="w">        </span><span class="n">cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="k">update</span><span class="p">.</span><span class="n">service</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">&#39;EOF&#39;</span>
<span class="w">        </span><span class="o">[</span><span class="n">Unit</span><span class="o">]</span>
<span class="w">        </span><span class="n">Description</span><span class="o">=</span><span class="n">perfSONAR</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="k">Update</span>
<span class="w">        </span><span class="k">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="p">.</span><span class="n">target</span>

<span class="w">        </span><span class="o">[</span><span class="n">Service</span><span class="o">]</span>
<span class="w">        </span><span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="w">        </span><span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="k">update</span><span class="p">.</span><span class="n">sh</span>

<span class="w">        </span><span class="o">[</span><span class="n">Install</span><span class="o">]</span>
<span class="w">        </span><span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="k">user</span><span class="p">.</span><span class="n">target</span>
<span class="w">        </span><span class="n">EOF</span>

<span class="w">        </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Create a systemd timer (runs daily at 3 AM):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="err">```</span><span class="n">bash</span>
<span class="w">        </span><span class="n">cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="k">update</span><span class="p">.</span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">&#39;EOF&#39;</span>

<span class="w">        </span><span class="o">[</span><span class="n">Unit</span><span class="o">]</span>
<span class="w">        </span><span class="n">Description</span><span class="o">=</span><span class="n">perfSONAR</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="k">Update</span><span class="w"> </span><span class="n">Timer</span>

<span class="w">        </span><span class="o">[</span><span class="n">Timer</span><span class="o">]</span>

<span class="w">        </span><span class="n">OnCalendar</span><span class="o">=</span><span class="n">daily</span>
<span class="w">        </span><span class="n">RandomizedDelaySec</span><span class="o">=</span><span class="mi">1</span><span class="n">h</span>
<span class="w">        </span><span class="n">Persistent</span><span class="o">=</span><span class="k">true</span>

<span class="w">        </span><span class="o">[</span><span class="n">Install</span><span class="o">]</span>

<span class="w">        </span><span class="n">WantedBy</span><span class="o">=</span><span class="n">timers</span><span class="p">.</span><span class="n">target</span>
<span class="w">        </span><span class="n">EOF</span>

<span class="w">        </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Enable and start the timer:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="err">```</span><span class="n">bash</span>
<span class="w">        </span><span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="w">        </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">--</span><span class="n">now</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">timer</span>

<span class="w">        </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Verify the timer is active:
</code></pre></div>
<div class="codehilite"><pre><span></span><code>        ```bash
        systemctl list-timers perfsonar-auto-update.timer

        ```
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Test manually (optional):
</code></pre></div>
<div class="codehilite"><pre><span></span><code>        ```bash

        systemctl start perfsonar-auto-update.service
        journalctl -u perfsonar-auto-update.service -n 50

        ```
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. Monitor the update log:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="err">```</span><span class="n">bash</span>
<span class="w">        </span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">log</span>

<span class="w">        </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>This approach ensures containers are updated only when new images are available, minimizing unnecessary restarts while
keeping your deployment current.

---

## Step 8 – Post-Install Validation

Perform these checks before handing the host over to operations:

1. **System services:**

    ??? info &quot;Verify Podman runtime and containers&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code>    ```bash
    # Check Podman service is available
    systemctl status podman

    # Verify containers are managed by compose
    cd /opt/perfsonar-tp &amp;&amp; podman-compose ps

    # Alternative: check containers directly
    podman ps --filter name=perfsonar

    ```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Ensure Podman is active and containers are running.

1. **Container health:**

    ??? info &quot;Check container status and logs&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="x">    ```bash</span>
<span class="x">    # Check all containers are running and healthy</span>
<span class="x">    podman ps --format &#39;table </span><span class="cp">{{</span><span class="nv">.Names</span><span class="cp">}}</span><span class="x">\t</span><span class="cp">{{</span><span class="nv">.Status</span><span class="cp">}}</span><span class="x">\t</span><span class="cp">{{</span><span class="nv">.Ports</span><span class="cp">}}</span><span class="x">&#39;</span>

<span class="x">    # Check perfsonar-testpoint logs for errors</span>
<span class="x">    podman logs perfsonar-testpoint --tail 50</span>

<span class="x">    # If using Let&#39;s Encrypt, check certbot logs</span>

<span class="x">    podman logs certbot --tail 20 2&gt;/dev/null || echo &quot;Certbot container not present (testpoint-only mode)&quot;</span>

<span class="x">    # Verify services inside container are running</span>
<span class="x">    podman exec perfsonar-testpoint systemctl status apache2 psconfig-pscheduler-agent --no-pager</span>

<span class="x">    ```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>1. **Network path validation:**

    ??? info &quot;Test network connectivity and routing&quot;

        Test throughput to a remote testpoint (run from inside the container):
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">    </span>```<span class="nv">bash</span>
<span class="w">    </span><span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="o">-</span><span class="nv">it</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">pscheduler</span><span class="w"> </span><span class="nv">task</span><span class="w"> </span><span class="nv">throughput</span><span class="w"> </span><span class="o">--</span><span class="nv">dest</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">remote</span><span class="o">-</span><span class="nv">testpoint</span><span class="o">&gt;</span>

<span class="w">    </span>```
</code></pre></div>

<div class="highlight"><pre><span></span><code>        Check routing from the host:
</code></pre></div>
<div class="codehilite"><pre><span></span><code>    ```bash
    tracepath -n &lt;remote-testpoint&gt;
    ip route get &lt;remote-testpoint-ip&gt;

    ```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Confirm traffic uses the intended policy-based routes (check `ip route get &lt;dest&gt;`).

1. **Security posture:**

    ??? info &quot;Check firewall, fail2ban, and SELinux&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="c1"># Check nftables firewall rules</span>
<span class="w">    </span><span class="n">nft</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">ruleset</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">perfsonar</span>

<span class="w">    </span><span class="c1"># Check fail2ban status (if installed in Step 4)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span><span class="w"> </span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="nb nb-Type">null</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">then</span>
<span class="w">        </span><span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span><span class="w"> </span><span class="n">status</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;fail2ban not installed (optional)&quot;</span>
<span class="w">    </span><span class="n">fi</span>

<span class="w">    </span><span class="c1"># Check for recent SELinux denials</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">ausearch</span><span class="w"> </span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="nb nb-Type">null</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">then</span>
<span class="w">        </span><span class="n">ausearch</span><span class="w"> </span><span class="o">--</span><span class="n">message</span><span class="w"> </span><span class="n">AVC</span><span class="w"> </span><span class="o">--</span><span class="n">just</span><span class="o">-</span><span class="n">one</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">audit</span><span class="o">/</span><span class="n">audit</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="p">];</span><span class="w"> </span><span class="n">then</span>
<span class="w">        </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="s2">&quot;avc.*denied&quot;</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">audit</span><span class="o">/</span><span class="n">audit</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;SELinux audit tools not available&quot;</span>
<span class="w">    </span><span class="n">fi</span>

<span class="w">    </span><span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    Investigate any SELinux denials or repeated Fail2Ban bans.

1. **LetsEncrypt certificate check:**

    ??? info &quot;Verify certificate validity&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code>    ```bash
    # Check certificate via HTTPS connection
    echo | openssl s_client -connect &lt;SERVER_FQDN&gt;:443 -servername &lt;SERVER_FQDN&gt; 2&gt;/dev/null | openssl x509 -noout -dates -issuer


    # Alternative: Check certificate files directly
    sudo openssl x509 -in /etc/letsencrypt/live/&lt;SERVER_FQDN&gt;/cert.pem -noout -dates -issuer

    ```
</code></pre></div>

<div class="highlight"><pre><span></span><code>Ensure the issuer is Let&#39;s Encrypt and the validity period is acceptable. This check only applies if you configured
Let&#39;s Encrypt in Step 3.

1. **Reporting:**

??? info &quot;Run perfSONAR diagnostic reports&quot; Run the perfSONAR troubleshoot command from inside the container and send
outputs to operations:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="w">    </span>```<span class="nv">bash</span>
<span class="w">    </span><span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="o">-</span><span class="nv">it</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">pscheduler</span><span class="w"> </span><span class="nv">troubleshoot</span>

<span class="w">    </span>```
</code></pre></div>

<div class="highlight"><pre><span></span><code>---

## Ongoing Maintenance

- **Quarterly or as-needed:** Re-validate routing policy and nftables rules after network changes or security audits.

- **Monthly or during maintenance windows:** Apply OS updates (`dnf update`) and reboot during scheduled downtime.

- Monitor psconfig feeds for changes in mesh participation and test configuration.

- Track certificate expiry with `certbot renew --dry-run` if you rely on Let&#39;s Encrypt (automatic renewal is configured but monitoring is recommended).

- Review container logs periodically for errors: `podman logs perfsonar-testpoint` and `podman logs certbot`.

- Verify auto-update timer is active: `systemctl list-timers perfsonar-auto-update.timer`.

---

## Troubleshooting

### Container Issues

??? failure &quot;Container won&#39;t start or exits immediately&quot;

    **Symptoms:** `podman ps` shows no running containers, or container exits shortly after starting.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="nv">logs</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">systemd</span><span class="w"> </span><span class="nv">initialization</span><span class="w"> </span><span class="nv">errors</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">grep</span><span class="w"> </span><span class="o">-</span><span class="nv">i</span><span class="w"> </span><span class="s2">&quot;failed\|error&quot;</span>

#<span class="w"> </span><span class="nv">Verify</span><span class="w"> </span><span class="nv">compose</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">syntax</span>
<span class="nv">cd</span><span class="w"> </span><span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">tp</span>
<span class="nv">podman</span><span class="o">-</span><span class="nv">compose</span><span class="w"> </span><span class="nv">config</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Common causes:**

- Missing entrypoint wrapper: Ensure `/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh` exists

- SELinux denials: Check `ausearch -m avc -ts recent` and consider temporarily setting to permissive mode for testing

- Incorrect bind-mount paths: Verify all host directories exist and have correct permissions

- Cgroup issues: Ensure `cgroupns: private` is set and no manual cgroup bind-mounts exist

??? failure &quot;Container won&#39;t start or exits immediately&quot;

    **Symptoms:** `podman ps` shows no running containers, or container exits shortly after starting.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="nv">logs</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">systemd</span><span class="w"> </span><span class="nv">initialization</span><span class="w"> </span><span class="nv">errors</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">grep</span><span class="w"> </span><span class="o">-</span><span class="nv">i</span><span class="w"> </span><span class="s2">&quot;failed\|error&quot;</span>

#<span class="w"> </span><span class="nv">Verify</span><span class="w"> </span><span class="nv">compose</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">syntax</span>
<span class="nv">cd</span><span class="w"> </span><span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">tp</span>
<span class="nv">podman</span><span class="o">-</span><span class="nv">compose</span><span class="w"> </span><span class="nv">config</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Common causes:**

- Missing entrypoint wrapper: Ensure `/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh` exists

- SELinux denials: Check `ausearch -m avc -ts recent` and consider temporarily setting to permissive mode for testing

- Incorrect bind-mount paths: Verify all host directories exist and have correct permissions

- Cgroup issues: Ensure `cgroupns: private` is set and no manual cgroup bind-mounts exist

??? failure &quot;Container crashes after reboot with exit code 255&quot;

**Symptoms:** Containers run fine when started manually but crash-loop after host reboot. Logs show repeated restarts
with exit code 255.

**Cause:** The perfSONAR testpoint image runs systemd internally but podman-compose doesn&#39;t support the
`--systemd=always` flag required for proper systemd operation in containers.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="nv">status</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">ps</span><span class="w"> </span><span class="o">-</span><span class="nv">a</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">systemd</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">status</span>
<span class="nv">systemctl</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span>.<span class="nv">service</span>

#<span class="w"> </span><span class="nv">View</span><span class="w"> </span><span class="nv">recent</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="nv">logs</span>

<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="o">--</span><span class="nv">tail</span><span class="w"> </span><span class="mi">100</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">compose</span><span class="o">-</span><span class="nv">based</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="ss">(</span><span class="nv">BAD</span><span class="ss">)</span>
<span class="nv">grep</span><span class="w"> </span><span class="o">-</span><span class="nv">A5</span><span class="w"> </span><span class="s2">&quot;ExecStart&quot;</span><span class="w"> </span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">systemd</span><span class="o">/</span><span class="nv">system</span><span class="o">/</span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span>.<span class="nv">service</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solution:**

    Replace the compose-based systemd service with proper systemd units that use `podman run --systemd=always`:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Stop and disable old service</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">disable</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># Install new systemd units</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span>\
<span class="w">    </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">osg</span><span class="o">-</span><span class="n">htc</span><span class="o">/</span><span class="n">networking</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span>\
<span class="w">    </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span><span class="w"> </span><span class="mi">0755</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span>

<span class="c1"># For testpoint only:</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span>

<span class="c1"># For testpoint + certbot:</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">certbot</span>

<span class="c1"># Enable and start</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">--</span><span class="n">now</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># If using certbot:</span>

<span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">--</span><span class="n">now</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">certbot</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># Verify containers are running</span>
<span class="n">podman</span><span class="w"> </span><span class="n">ps</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">kI</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Verification:**

    After installing the new units, the testpoint should:

- Start successfully on boot

- Run systemd properly inside the container

- Maintain state across reboots

- Show &quot;Up&quot; status in `podman ps` (not &quot;Exited&quot; or crash-looping)

??? failure &quot;Certbot service fails with &#39;Unable to open config file&#39; error&quot;

**Symptoms:** `perfsonar-certbot.service` fails immediately after starting with exit code 2. Logs show: `certbot: error:
Unable to open config file: trap exit TERM; while...`

**Cause:** The certbot container image has a built-in entrypoint that expects certbot commands directly. When using a
shell loop for renewal, the entrypoint tries to parse the shell command as a certbot config file, causing this error.


    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">certbot</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">status</span>
<span class="nv">systemctl</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">certbot</span>.<span class="nv">service</span>

#<span class="w"> </span><span class="nv">View</span><span class="w"> </span><span class="nv">detailed</span><span class="w"> </span><span class="nv">logs</span>
<span class="nv">journalctl</span><span class="w"> </span><span class="o">-</span><span class="nv">u</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">certbot</span>.<span class="nv">service</span><span class="w"> </span><span class="o">-</span><span class="nv">n</span><span class="w"> </span><span class="mi">50</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">logs</span>
<span class="nv">journalctl</span><span class="w"> </span><span class="o">-</span><span class="nv">u</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">certbot</span>.<span class="nv">service</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">grep</span><span class="w"> </span><span class="s2">&quot;Unable to open config file&quot;</span>

#<span class="w"> </span><span class="nv">Verify</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">configuration</span>
<span class="nv">grep</span><span class="w"> </span><span class="o">-</span><span class="nv">A5</span><span class="w"> </span><span class="s2">&quot;ExecStart&quot;</span><span class="w"> </span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">systemd</span><span class="o">/</span><span class="nv">system</span><span class="o">/</span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">certbot</span>.<span class="nv">service</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solution:**

    The certbot service needs two flags:

- `--systemd=always` for proper systemd integration and reboot persistence

- `--entrypoint=/bin/sh` to override the built-in entrypoint

    Re-run the installation script to get the fixed version:
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Stop current service</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">certbot</span><span class="o">.</span><span class="n">service</span>


<span class="c1"># Download and install updated systemd units</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span>\
<span class="w">    </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">osg</span><span class="o">-</span><span class="n">htc</span><span class="o">/</span><span class="n">networking</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span>\
<span class="w">    </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span><span class="w"> </span><span class="mi">0755</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span>

<span class="c1"># Install with certbot support</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">certbot</span>

<span class="c1"># Start the fixed service</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">certbot</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># Verify it&#39;s running</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">certbot</span><span class="o">.</span><span class="n">service</span>
<span class="n">podman</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">certbot</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>**Expected result:** The certbot container should be running (not exiting) and the service should be in &quot;active
(running)&quot; state.

??? failure &quot;SELinux denials blocking container operations&quot;

    **Symptoms:** Container starts but services fail, permission denied errors in logs.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">recent</span><span class="w"> </span><span class="nv">SELinux</span><span class="w"> </span><span class="nv">denials</span>
<span class="nv">ausearch</span><span class="w"> </span><span class="o">-</span><span class="nv">m</span><span class="w"> </span><span class="nv">avc</span><span class="w"> </span><span class="o">-</span><span class="nv">ts</span><span class="w"> </span><span class="nv">recent</span>

#<span class="w"> </span><span class="nv">Temporarily</span><span class="w"> </span><span class="nv">set</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">permissive</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">testing</span>
<span class="nv">setenforce</span><span class="w"> </span><span class="mi">0</span>

#<span class="w"> </span><span class="nv">Test</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">issue</span><span class="w"> </span><span class="nv">resolves</span>,<span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">check</span><span class="w"> </span><span class="nv">audit</span><span class="w"> </span><span class="nv">log</span>
<span class="nv">ausearch</span><span class="w"> </span><span class="o">-</span><span class="nv">m</span><span class="w"> </span><span class="nv">avc</span><span class="w"> </span><span class="o">-</span><span class="nv">ts</span><span class="w"> </span><span class="nv">recent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">selinux</span><span class="o">-</span><span class="nv">denials</span>.<span class="nv">txt</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solutions:**

    - Verify volume labels are correct (`:Z` for exclusive, `:z` for shared)

- Recreate containers to reapply SELinux labels: `podman-compose down &amp;&amp; podman-compose up -d`

- If persistent issues, consider creating custom SELinux policy or running in permissive mode

### Networking Issues

??? failure &quot;Policy-based routing not working correctly&quot;

    **Symptoms:** Traffic not using expected interfaces, routing to wrong gateway.


    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Check routing rules</span>
<span class="n">ip</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="n">show</span>

<span class="c1"># Check routing tables</span>
<span class="n">ip</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">all</span>


<span class="c1"># Test specific route lookup</span>
<span class="n">ip</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="o">&lt;</span><span class="n">destination</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span>

<span class="c1"># Check NetworkManager connections</span>
<span class="n">nmcli</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">show</span>

<span class="c1"># Review PBR script log</span>
<span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">multi</span><span class="o">-</span><span class="n">nic</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">log</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solutions:**

    - Verify `/etc/perfSONAR-multi-nic-config.conf` has correct IPs and gateways

- Reapply configuration: `/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes`

- Reboot if rules are not being applied correctly


- Check for conflicting NetworkManager or systemd-networkd rules

??? failure &quot;DNS resolution failing for test endpoints&quot;

    **Symptoms:** perfSONAR tests fail with &quot;unknown host&quot; or DNS errors.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Test DNS resolution from container</span>
<span class="n">podman</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="w"> </span><span class="n">dig</span><span class="w"> </span><span class="o">&lt;</span><span class="k">remote</span><span class="o">-</span><span class="n">testpoint</span><span class="o">&gt;</span>

<span class="c1"># Check container&#39;s resolv.conf</span>

<span class="n">podman</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>

<span class="c1"># Verify forward and reverse DNS</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">check</span><span class="o">-</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">dns</span><span class="o">.</span><span class="n">sh</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solutions:**

    - Ensure DNS servers are correctly configured on host

- Fix missing PTR records in DNS zones

- Verify forward A/AAAA records match reverse PTR records

### Certificate Issues


??? failure &quot;Let&#39;s Encrypt certificate issuance fails&quot;

    **Symptoms:** Certbot fails with &quot;Failed to authenticate&quot; or &quot;Connection refused&quot; errors.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Check if port 80 is open</span>
<span class="n">nft</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">ruleset</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s2">&quot;80&quot;</span>

<span class="c1"># Verify Apache is NOT listening on port 80 in container</span>
<span class="n">podman</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="w"> </span><span class="n">netstat</span><span class="w"> </span><span class="o">-</span><span class="n">tlnp</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="p">:</span><span class="mi">80</span>

<span class="c1"># Test port 80 accessibility from external host</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">your</span><span class="o">-</span><span class="n">fqdn</span><span class="o">&gt;/</span>

<span class="c1"># Run certbot in verbose mode</span>

<span class="n">podman</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">--</span><span class="n">net</span><span class="o">=</span><span class="n">host</span><span class="w"> </span>\
<span class="w">    </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="p">:</span><span class="n">Z</span><span class="w"> </span>\
<span class="w">    </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">:</span><span class="n">Z</span><span class="w"> </span>\
<span class="w">    </span><span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">certbot</span><span class="o">/</span><span class="n">certbot</span><span class="p">:</span><span class="n">latest</span><span class="w"> </span><span class="n">certonly</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">standalone</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="n">SERVER_FQDN</span><span class="o">&gt;</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="n">EMAIL</span><span class="o">&gt;</span><span class="w"> </span><span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">vvv</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Common causes:**


- Port 80 blocked by firewall: Add with `perfSONAR-install-nftables.sh --ports=80,443`

- Apache listening on port 80: Verify testpoint-entrypoint-wrapper.sh patched Apache correctly

- DNS not propagated: Wait for DNS changes to propagate globally

- Rate limiting: Let&#39;s Encrypt has rate limits; wait if you&#39;ve hit them

??? failure &quot;Certificate not loaded after renewal&quot;

    **Symptoms:** Old certificate still in use after automatic renewal.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="x">```bash</span>
<span class="x"># Check certificate files</span>
<span class="x">ls -la /etc/letsencrypt/live/&lt;fqdn&gt;/</span>

<span class="x"># Verify deploy hook is configured</span>
<span class="x">podman logs certbot 2&gt;&amp;1 | grep &quot;deploy hook&quot;</span>

<span class="x"># Check if container restarted</span>
<span class="x">podman ps --format &#39;table </span><span class="cp">{{</span><span class="nv">.Names</span><span class="cp">}}</span><span class="x">\t</span><span class="cp">{{</span><span class="nv">.Status</span><span class="cp">}}</span><span class="x">&#39;</span>

<span class="x"># Manually restart testpoint</span>
<span class="x">podman restart perfsonar-testpoint</span>

<span class="x">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solutions:**

    - Verify deploy hook script exists and is executable: `/opt/perfsonar-tp/tools_scripts/certbot-deploy-hook.sh`

- Ensure deploy hook is mounted in container at: `/etc/letsencrypt/renewal-hooks/deploy/certbot-deploy-hook.sh`

- Verify Podman socket is mounted in certbot container: `/run/podman/podman.sock`

- Check deploy hook logs: `journalctl -u perfsonar-certbot.service | grep deploy`

- Manually restart testpoint after renewals if deploy hook fails: `podman restart perfsonar-testpoint`

**Note:** Certbot automatically executes scripts in `/etc/letsencrypt/renewal-hooks/deploy/` when certificates are
renewed. Do not use `--deploy-hook` parameter with full paths ending in `.sh` as certbot will append `-hook` to the
filename.

### perfSONAR Service Issues

??? failure &quot;perfSONAR services not running&quot;

    **Symptoms:** Web interface not accessible, tests not running.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">inside</span><span class="w"> </span><span class="nv">container</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">systemctl</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">apache2</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">systemctl</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">pscheduler</span><span class="o">-</span><span class="nv">ticker</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">systemctl</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">owamp</span><span class="o">-</span><span class="nv">server</span>

#<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">errors</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">logs</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">journalctl</span><span class="w"> </span><span class="o">-</span><span class="nv">u</span><span class="w"> </span><span class="nv">apache2</span><span class="w"> </span><span class="o">-</span><span class="nv">n</span><span class="w"> </span><span class="mi">50</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">journalctl</span><span class="w"> </span><span class="o">-</span><span class="nv">u</span><span class="w"> </span><span class="nv">pscheduler</span><span class="o">-</span><span class="nv">ticker</span><span class="w"> </span><span class="o">-</span><span class="nv">n</span><span class="w"> </span><span class="mi">50</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solutions:**

    - Restart services inside container: `podman exec perfsonar-testpoint systemctl restart apache2`

- Check Apache SSL configuration was patched correctly

- Verify certificates are in place: `ls -la /etc/letsencrypt/live/`

- Restart container: `podman restart perfsonar-testpoint`

### Auto-Update Issues

??? failure &quot;Auto-update not working&quot;

    **Symptoms:** Containers not updating despite new images available.

    **Diagnostic steps:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err">```</span><span class="n">bash</span>
<span class="c1"># Check timer status</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">timer</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">list</span><span class="o">-</span><span class="n">timers</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">timer</span>

<span class="c1"># Check service logs</span>
<span class="n">journalctl</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">service</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="mi">100</span>

<span class="c1"># Check update log</span>
<span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="mi">50</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">log</span>

<span class="c1"># Manually test update</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">service</span>

<span class="err">```</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Solutions:**

    - Enable timer if not active: `systemctl enable --now perfsonar-auto-update.timer`

- Verify script exists and is executable: `ls -la /usr/local/bin/perfsonar-auto-update.sh`

- Check podman-compose is installed and working

- Review script for errors and update if needed

### General Debugging Tips

??? tip &quot;Useful debugging commands&quot;

    **Container management:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">View</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">containers</span><span class="w"> </span><span class="ss">(</span><span class="nv">running</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">stopped</span><span class="ss">)</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">ps</span><span class="w"> </span><span class="o">-</span><span class="nv">a</span>

#<span class="w"> </span><span class="nv">View</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="nv">resource</span><span class="w"> </span><span class="nv">usage</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">stats</span>

#<span class="w"> </span><span class="nv">Enter</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">interactive</span><span class="w"> </span><span class="nv">debugging</span>
<span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="o">-</span><span class="nv">it</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>

#<span class="w"> </span><span class="nv">View</span><span class="w"> </span><span class="nv">compose</span><span class="w"> </span><span class="nv">configuration</span>
<span class="nv">cd</span><span class="w"> </span><span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">tp</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">podman</span><span class="o">-</span><span class="nv">compose</span><span class="w"> </span><span class="nv">config</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Networking:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```bash
# Check which process is listening on a port
ss -tlnp | grep &lt;port&gt;

# Test connectivity to remote testpoint
ping &lt;remote-ip&gt;
traceroute &lt;remote-ip&gt;

# Check nftables rules
nft list ruleset

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>    **Logs:**
</code></pre></div>
<div class="codehilite"><pre><span></span><code>```<span class="nv">bash</span>
#<span class="w"> </span><span class="nv">System</span><span class="w"> </span><span class="nv">journal</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">container</span><span class="w"> </span><span class="nv">runtime</span>
<span class="nv">journalctl</span><span class="w"> </span><span class="o">-</span><span class="nv">u</span><span class="w"> </span><span class="nv">podman</span><span class="w"> </span><span class="o">-</span><span class="nv">n</span><span class="w"> </span><span class="mi">100</span>

#<span class="w"> </span><span class="nv">All</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">container</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="o">--</span><span class="nv">tail</span><span class="o">=</span><span class="mi">100</span>

#<span class="w"> </span><span class="nv">Follow</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">real</span><span class="o">-</span><span class="nv">time</span>
<span class="nv">podman</span><span class="w"> </span><span class="nv">logs</span><span class="w"> </span><span class="o">-</span><span class="nv">f</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span>

```
</code></pre></div>

<div class="highlight"><pre><span></span><code>---
</code></pre></div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "toc.follow", "toc.integrate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>