version: "3.9"
services:
  testpoint:
    container_name: perfsonar-testpoint
    image: hub.opensciencegrid.org/osg-htc/perfsonar-testpoint:production
    labels:
      - io.containers.autoupdate=registry
    network_mode: "host"
    privileged: true
    cgroupns: private
    environment:
      - TZ=UTC
    restart: unless-stopped
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    volumes:
      # D-Bus socket: needed by node_exporter --collector.systemd on systemd hosts
      - /run/dbus:/run/dbus:ro
      # node_exporter options (adds --no-collector.cpufreq workaround for procfs v0.10.0 panic)
      - /opt/perfsonar-tp/conf/node_exporter.defaults:/etc/default/node_exporter:z
      - /opt/perfsonar-tp/psconfig:/etc/perfsonar/psconfig:Z
      - /var/www/html:/var/www/html:z
      - /etc/apache2:/etc/apache2:z
    pids_limit: 8192
    cap_add:
      - CAP_NET_RAW
      - CAP_SYS_ADMIN
      - CAP_SYS_PTRACE
    healthcheck:
      test: ["CMD-SHELL", "curl -kSfS https://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
