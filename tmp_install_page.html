<p>﻿# Installing a perfSONAR Testpoint for WLCG/OSG</p>
<!-- markdownlint-disable MD040 -->

<p>This guide walks WLCG/OSG site administrators through end-to-end installation, configuration, and validation of a
perfSONAR testpoint on Enterprise Linux 9 (EL9). It uses automated tooling from this repository to streamline the
process while accommodating site-specific requirements.</p>
<hr />
<h2 id="prerequisites-and-planning">Prerequisites and Planning</h2>
<p>Before you begin, it may be helpful to gather the following information:</p>
<ul>
<li>
<p><strong>Hardware details:</strong> hostname, BMC/iLO/iDRAC credentials (if used), interface names, available storage locations.</p>
</li>
<li>
<p><strong>Network data:</strong> IPv4/IPv6 assignments for each NIC, default gateway, internal/external VLAN
  information.</p>
</li>
<li>
<p><strong>Operational contacts:</strong> site admin email, OSG facility/site name, latitude/longitude.</p>
</li>
</ul>
<h2 id="existing-perfsonar-configuration">Existing perfSONAR configuration</h2>
<p>If replacing an existing instance, you may want to back up <code>/etc/perfsonar/</code> files, especially
<code>lsregistrationdaemon.conf</code>, and any container volumes. We have a script named<code>perfSONAR-update-lsregistration.sh</code> to
extract/save/restore registration config that you may want to use.</p>
<details class="info">
<summary>Quick capture of existing lsregistration config (if you have a src)</summary>
<p>Download temporarily:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/perfSONAR-update-lsregistration.sh<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span>/tmp/update-lsreg.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/update-lsreg.sh
</code></pre></div>
</details>
<!-- markdownlint-enable MD040 -->

<div class="codehilite"><pre><span></span><code><span class="n">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">downloaded</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">script</span><span class="p">:</span>

<span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">update</span><span class="o">-</span><span class="n">lsreg</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="o">--</span><span class="n">output</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">restore</span><span class="o">-</span><span class="n">lsreg</span><span class="o">.</span><span class="n">sh</span>
</code></pre></div>

<p>```</p>
<p>Note: Repository clone instructions are in Step 2.</p>
<blockquote>
<p><strong>Note:</strong> All shell commands assume an interactive root shell.</p>
</blockquote>
<hr />
<h2 id="step-1-install-and-harden-el9">Step 1 – Install and Harden EL9</h2>
<ol>
<li>
<p><strong>Provision EL9:</strong> Install AlmaLinux, Rocky Linux, or RHEL 9 with the <em>Minimal</em> profile.</p>
</li>
<li>
<p><strong>Set the hostname and time sync:</strong> Pick the NIC that will own the default route for the hostname.</p>
<p>```bash
hostnamectl set-hostname <testpoint-hostname>
systemctl enable --now chronyd
timedatectl set-timezone <Region/City></p>
</li>
</ol>
<p>```</p>
<ol>
<li>
<p><strong>Disable unused services:</strong></p>
<p><code>bash
systemctl disable --now firewalld NetworkManager-wait-online
dnf remove -y rsyslog</code></p>
<details class="info">
<summary>Why disable unused services?</summary>
</details>
</li>
</ol>
<p>We recommend disabling unused services during initial provisioning to reduce complexity and avoid unexpected
interference with network and container setup. Services such as <code>firewalld</code>, <code>NetworkManager-wait-online</code>, and <code>rsyslog</code>
can alter networking state, hold boot or network events, or conflict with the automated nftables/NetworkManager changes
performed by the helper scripts. Disabling non-essential services makes the install deterministic, reduces the host
attack surface, and avoids delays or race conditions while configuring policy-based routing, nftables rules, and
container networking.</p>
<ol>
<li>
<p><strong>Update the system:</strong></p>
<p>```bash
dnf -y update</p>
</li>
</ol>
<p>```</p>
<ol>
<li>
<p><strong>Record NIC names:</strong> Document interface mappings for later PBR configuration.</p>
<p><code>bash
nmcli device status
ip -br addr</code></p>
</li>
</ol>
<hr />
<h2 id="step-2-choose-your-deployment-path">Step 2 – Choose Your Deployment Path</h2>
<p>After completing Step 1 (minimal OS hardening), you can proceed in one of two ways:</p>
<h3 id="path-a-orchestrated-guided-install-recommended-for-new-deployments">Path A: Orchestrated Guided Install (Recommended for New Deployments)</h3>
<p>The orchestrator automates package installation, bootstrap, PBR configuration, security hardening, container deployment,
certificate issuance, and pSConfig enrollment with interactive pauses (or non-interactive batch mode).</p>
<p><strong>Download and run the orchestrator:</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/perfSONAR-orchestrator.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/perfSONAR-orchestrator.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/perfSONAR-orchestrator.sh
/tmp/perfSONAR-orchestrator.sh
</code></pre></div>
<p><strong>Interactive mode</strong> (pause at each step, confirm/skip/quit):</p>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh
</code></pre></div>
<p><strong>Non-interactive mode</strong> (auto-confirm all steps):</p>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh<span class="w"> </span>--non-interactive<span class="w"> </span>--option<span class="w"> </span>A
</code></pre></div>
<p><strong>With Let's Encrypt (Option B):</strong></p>
<div class="highlight"><pre><span></span><code>/tmp/perfSONAR-orchestrator.sh<span class="w"> </span>--option<span class="w"> </span>B<span class="w"> </span>--fqdn<span class="w"> </span>&lt;FQDN&gt;<span class="w"> </span>--email<span class="w"> </span>&lt;EMAIL&gt;
</code></pre></div>
<p><strong>Flags:</strong></p>
<ul>
<li>
<p><code>--option {A|B}</code> — A = testpoint only; B = testpoint + Let's Encrypt</p>
</li>
<li>
<p><code>--fqdn NAME</code> — primary FQDN for certificates (Option B)</p>
</li>
<li>
<p><code>--email ADDRESS</code> — email for Let's Encrypt (Option B)</p>
</li>
<li>
<p><code>--non-interactive</code> — skip pauses, auto-confirm</p>
</li>
<li>
<p><code>--yes</code> — auto-confirm internal script prompts</p>
</li>
<li>
<p><code>--dry-run</code> — preview steps without executing</p>
</li>
<li>
<p><code>--auto-update</code> — install and enable a systemd timer that pulls container images daily and restarts containers only if updated (creates <code>/usr/local/bin/perfsonar-auto-update.sh</code>, a systemd service and timer)</p>
</li>
</ul>
<p><strong>If you choose this path, skip to Step 7</strong> (the orchestrator completes Steps 2–6 for you).</p>
<hr />
<h3 id="path-b-manual-step-by-step">Path B: Manual Step-by-Step</h3>
<p>For users who prefer granular control or need to customize each stage, continue with manual package installation,
bootstrap, and configuration.</p>
<h4 id="step-21-install-base-packages">Step 2.1 – Install Base Packages</h4>
<p>On minimal hosts several required tools (e.g. <code>dig</code>, <code>nft</code>, <code>podman-compose</code>) are missing. Install all recommended
prerequisites in one command:</p>
<div class="highlight"><pre><span></span><code>dnf<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>podman<span class="w"> </span>podman-docker<span class="w"> </span>podman-compose<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>jq<span class="w"> </span>curl<span class="w"> </span>tar<span class="w"> </span>gzip<span class="w"> </span>rsync<span class="w"> </span>bind-utils<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>nftables<span class="w"> </span>fail2ban<span class="w"> </span>policycoreutils-python-utils<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python3<span class="w"> </span>iproute<span class="w"> </span>iputils<span class="w"> </span>procps-ng<span class="w"> </span>sed<span class="w"> </span>grep<span class="w"> </span>gawk
</code></pre></div>
<p>This ensures all subsequent steps (PBR generation, DNS checks, firewall hardening, container deployment) have their
dependencies available.</p>
<h4 id="step-22-bootstrap-helper-scripts">Step 2.2 – Bootstrap Helper Scripts</h4>
<p>Use the bootstrap script to install helper scripts under <code>/opt/perfsonar-tp/tools_scripts</code>:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install_tools_scripts.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install_tools_scripts.sh
/tmp/install_tools_scripts.sh<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<p><strong>Verify bootstrap completed successfully:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Check that all helper scripts were downloaded</span>

ls<span class="w"> </span>-1<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/*.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
<span class="c1"># Should show 11 shell scripts</span>

<span class="c1"># Verify key scripts are present and executable</span>

ls<span class="w"> </span>-l<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/<span class="o">{</span>perfSONAR-pbr-nm.sh,perfSONAR-install-nftables.sh,perfSONAR-orchestrator.sh<span class="o">}</span>
</code></pre></div>
<hr />
<h2 id="step-3-configure-policy-based-routing-pbr">Step 3 – Configure Policy-Based Routing (PBR)</h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
</div>
<p>The orchestrator automates PBR configuration. If you ran it in Step 2, skip to <a href="#step-4-configure-nftables-
selinux-and-fail2ban">Step 4</a>.</p>
<p>The script <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh</code> automates NetworkManager profiles and routing rule
setup. It fills out and consumes the network configuration in <code>/etc/perfSONAR-multi-nic-config.conf</code>.</p>
<h3 id="modes">Modes</h3>
<p>By default the script now performs an <strong>in-place apply</strong> that adjusts routes, rules, and NetworkManager connection
properties <strong>without deleting existing connections or flushing all system routes</strong>. This minimizes disruption and
usually avoids the need for a reboot.</p>
<p>An optional destructive mode <code>--rebuild-all</code> performs the original full workflow: backup existing profiles, flush all
routes and rules, remove every NetworkManager connection, then recreate connections from scratch. Use this only for
initial deployments or when you must completely reset inconsistent legacy state.</p>
<p>| Mode | Flag | Disruption | When to use | |------|------|------------|-------------| | In-place (default) | (none) or
<code>--apply-inplace</code> | Low (interfaces stay up; rules adjusted) | Routine updates, gateway changes, add routes | | Full
rebuild | <code>--rebuild-all</code> | High (connections removed; brief connectivity drop) | First-time setup, severe
misconfiguration |</p>
<h3 id="safety-enhancements">Safety Enhancements</h3>
<ul>
<li>
<p>Detects active SSH session interface and avoids extra disruption to that NIC in in-place mode.</p>
</li>
<li>
<p>Prompts are still skipped with <code>--yes</code>.</p>
</li>
<li>
<p>Dry-run preview supported via <code>--dry-run</code> (combine with <code>--debug</code> for verbose output).</p>
</li>
<li>
<p>Reboot is <strong>no longer generally required</strong>; only consider one if NetworkManager fails to apply the new rules cleanly.</p>
</li>
<li>
<p><strong>Generate config file automatically (or preview):</strong></p>
<div class="admonition warning">
<p class="admonition-title">Gateways required for addresses</p>
</div>
</li>
</ul>
<p>Any NIC with an IPv4 address must also have an IPv4 gateway, and any NIC with an IPv6 address must have an IPv6 gateway.
If the generator cannot detect a gateway, it adds a WARNING block to the generated file listing affected NICs. Edit
<code>NIC_IPV4_GWS</code>/<code>NIC_IPV6_GWS</code> accordingly before applying changes.</p>
<div class="codehilite"><pre><span></span><code>!!! note &quot;Gateway prompts&quot;
</code></pre></div>

<p>During generation, the script attempts to detect gateways per-NIC. If a NIC has an IP address but no gateway could be
determined, it will prompt you interactively to enter an IPv4 and/or IPv6 gateway (or <code>-</code> to skip). Prompts are skipped
in non-interactive sessions or when you use <code>--yes</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="n">Preview</span><span class="w"> </span><span class="n">generation</span><span class="w"> </span><span class="p">(</span><span class="n">no</span><span class="w"> </span><span class="n">changes</span><span class="p">):</span>

<span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">debug</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code><span class="n">Generate</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="n">file</span><span class="p">:</span>

<span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">auto</span>
</code></pre></div>

<p>```</p>
<p>The script writes the config file to <code>/etc/perfSONAR-multi-nic-config.conf</code>. Edit to adjust site-specific values (e.g.,
confirm <code>DEFAULT_ROUTE_NIC</code>, add <code>NIC_IPV4_ADDROUTE</code> entries) and verify the entries.  Next step is to apply the network
changes...</p>
<ol>
<li>
<p><strong>Apply changes (in-place default):</strong></p>
<div class="admonition warning">
<p class="admonition-title">Connect via console for network changes</p>
</div>
</li>
</ol>
<p>When applying network changes across an ssh connection, your session may be interrupted.   Please try to run the
perfSONAR-pbr-nm.sh script when connected either directly to the console or by using 'nohup' in front of the script
invocation.</p>
<div class="codehilite"><pre><span></span><code>    **If SSH connection drops during network reconfiguration:**
</code></pre></div>

<ol>
<li>
<p>Access via BMC/iLO/iDRAC console or physical console</p>
</li>
<li>
<p>Review <code>/var/log/perfSONAR-multi-nic-config.log</code> for errors</p>
</li>
<li>
<p>Check network state with <code>nmcli connection show</code> and <code>ip addr</code></p>
</li>
<li>
<p>Restore from backup if needed: backups are in <code>/var/backups/nm-connections-&lt;timestamp&gt;/</code></p>
</li>
<li>
<p>Reapply config after corrections: <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes</code></p>
<p>In-place apply (recommended):</p>
<p>```bash
/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes</p>
</li>
</ol>
<p>```</p>
<div class="codehilite"><pre><span></span><code><span class="n">Full</span><span class="w"> </span><span class="n">rebuild</span><span class="w"> </span><span class="p">(</span><span class="n">destructive</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="n">removes</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">NM</span><span class="w"> </span><span class="n">connections</span><span class="w"> </span><span class="n">first</span><span class="p">):</span>

<span class="err">```</span><span class="n">bash</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">pbr</span><span class="o">-</span><span class="n">nm</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">rebuild</span><span class="o">-</span><span class="n">all</span><span class="w"> </span><span class="o">--</span><span class="n">yes</span>
</code></pre></div>

<p>```</p>
<p>The script logs to <code>/var/log/perfSONAR-multi-nic-config.log</code>. After an in-place apply, a reboot is typically
unnecessary. If connectivity or rules appear inconsistent (<code>ip rule show</code> / <code>ip route</code> mismatch), consider a manual
NetworkManager restart:</p>
<div class="codehilite"><pre><span></span><code>```bash
systemctl restart NetworkManager
</code></pre></div>

<p>```</p>
<ol>
<li><strong>DNS: forward and reverse entries (required):</strong></li>
</ol>
<p>All IP addresses that will be used for perfSONAR testing MUST have DNS entries: a forward (A/AAAA) record and a matching
reverse (PTR) record. This is required so remote test tools and site operators can reliably reach and identify your
host, and because some measurement infrastructure and registration systems perform forward/reverse consistency checks.</p>
<ul>
<li>
<p>For single-stack IPv4-only hosts: ensure A and PTR are present and consistent.</p>
</li>
<li>
<p>For single-stack IPv6-only hosts: ensure AAAA and PTR are present and consistent.</p>
</li>
<li>
<p>For dual-stack hosts: both IPv4 and IPv6 addresses used for testing must have matching forward and reverse records (A+PTR and AAAA+PTR).</p>
</li>
</ul>
<p>??? example "Run the DNS checker" Validate forward/reverse DNS for addresses in <code>/etc/perfSONAR-multi-nic-config.conf</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">check</span><span class="o">-</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">dns</span><span class="o">.</span><span class="n">sh</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code>**Notes and automation tips:**
</code></pre></div>

<ul>
<li>
<p>The script above uses <code>dig</code> (bind-utils package) which is commonly available; you can adapt it
      to use <code>host</code> if preferred.</p>
</li>
<li>
<p>Run the check as part of your provisioning CI or as a pre-flight check before enabling measurement registration.</p>
</li>
<li>
<p>For large sites or many addresses, parallelize the checks (xargs -P) or use a small Python
      script that leverages <code>dns.resolver</code> for async checks.</p>
</li>
<li>
<p>If your PTR returns a hostname with a trailing dot, the script strips it before the forward check.</p>
</li>
</ul>
<p>If any addresses fail these checks, correct the DNS zone (forward and/or reverse) and allow DNS propagation before
proceeding with registration and testing.</p>
<ol>
<li>
<p><strong>Verify the routing policy:</strong></p>
<p>```bash
nmcli connection show
ip rule show
ip route show table <table-id></p>
</li>
</ol>
<p>```</p>
<p>Confirm that non-default interfaces have their own routing tables and that the default interface owns the system default
route.</p>
<hr />
<h2 id="step-4-configure-nftables-selinux-and-fail2ban">Step 4 – Configure nftables, SELinux, and Fail2Ban</h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
</div>
<p>The orchestrator automates security hardening. If you ran it in Step 2, skip to <a href="#step-5-deploy-the-
containerized-perfsonar-testpoint">Step 5</a>.</p>
<p>Use <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-install-nftables.sh</code> to configure a hardened nftables profile with
optional SELinux and Fail2Ban support. No staging or copy step is required.</p>
<p>Prerequisites (not installed by the script and should have been installed when check-deps.sh was run above):</p>
<ul>
<li>
<p><code>nftables</code> must already be installed and available (<code>nft</code> binary) for firewall configuration.</p>
</li>
<li>
<p><code>fail2ban</code> must be installed if you want the optional jail configuration.</p>
</li>
<li>
<p>SELinux tools (e.g., <code>getenforce</code>, <code>policycoreutils</code>) must be present to attempt SELinux configuration.</p>
</li>
</ul>
<p>If any prerequisite is missing, the script skips that component and continues.</p>
<ol>
<li>
<p><strong>Install/configure the desired options:</strong></p>
<p>```bash
/opt/perfsonar-tp/tools_scripts/perfSONAR-install-nftables.sh --selinux --fail2ban --yes</p>
</li>
</ol>
<p>```</p>
<ul>
<li>
<p>Use <code>--yes</code> to skip the interactive confirmation prompt (omit it if you prefer to review the
      summary and answer manually).</p>
</li>
<li>
<p>Add <code>--dry-run</code> for a rehearsal that only prints the planned actions.</p>
</li>
</ul>
<p>The script writes nftables rules for perfSONAR services, derives SSH allow-lists from <code>/etc/perfSONAR-multi-nic-
config.conf</code>, optionally adjusts SELinux, and enables Fail2ban jails—only if those components are already installed.</p>
<div class="codehilite"><pre><span></span><code>??? info &quot;SSH allow-lists and validation&quot;
</code></pre></div>

<ul>
<li>
<p>Derives SSH allow-lists from <code>/etc/perfSONAR-multi-nic-config.conf</code> (CIDR prefixes and addresses).</p>
</li>
<li>
<p>Validates nftables rules before writing.</p>
</li>
<li>
<p>Outputs: rules to <code>/etc/nftables.d/perfsonar.nft</code>, log to <code>/var/log/perfSONAR-install-nftables.log</code>, backups to <code>/var/backups/</code>.</p>
</li>
</ul>
<p>??? tip "Preview nftables rules before applying" You can preview the fully rendered nftables rules (no changes are
made):</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">nftables</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">rules</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code>??? tip &quot;Manually add extra management hosts/subnets&quot;
</code></pre></div>

<p>If you need to allow additional SSH sources not represented by your NIC-derived prefixes, edit
<code>/etc/nftables.d/perfsonar.nft</code> and add entries to the appropriate sets. Example:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="nx">nft</span>
<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip4_subnets</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv4_addr</span>
<span class="w">        </span><span class="nx">flags</span><span class="w"> </span><span class="nx">interval</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="m m-Double">192.0.2.0</span><span class="o">/</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">198.51.100.0</span><span class="o">/</span><span class="mi">25</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip4_hosts</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv4_addr</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="m m-Double">203.0.113.10</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">203.0.113.11</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip6_subnets</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv6_addr</span>
<span class="w">        </span><span class="nx">flags</span><span class="w"> </span><span class="nx">interval</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2001</span><span class="p">:</span><span class="nx">db8</span><span class="p">:</span><span class="mi">1</span><span class="o">::/</span><span class="mi">64</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">set</span><span class="w"> </span><span class="nx">ssh_access_ip6_hosts</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">type</span><span class="w"> </span><span class="nx">ipv6_addr</span>
<span class="w">        </span><span class="nx">elements</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2001</span><span class="p">:</span><span class="nx">db8</span><span class="o">::</span><span class="mi">10</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code><span class="n">Then</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="w"> </span><span class="n">shell</span><span class="p">):</span>

<span class="err">```</span><span class="n">bash</span>
<span class="n">nft</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nftables</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">.</span><span class="n">nft</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="n">nftables</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">nftables</span>
</code></pre></div>

<p>```</p>
<ol>
<li>
<p><strong>Confirm nftables state and security services:</strong></p>
<details class="info">
<summary>Verification commands</summary>
<p>```bash
nft list ruleset
sestatus
systemctl status fail2ban</p>
</details>
</li>
</ol>
<p>```</p>
<p>You may want to document any site-specific exceptions (e.g., additional allowed management hosts) in your change log.</p>
<hr />
<h2 id="step-5-deploy-the-containerized-perfsonar-testpoint">Step 5 – Deploy the Containerized perfSONAR Testpoint</h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
</div>
<p>The orchestrator automates container deployment and certificate issuance. If you ran it in Step 2, skip to <a href="#step-6-configure-and-enroll-in-psconfig">Step
6</a>.</p>
<p>Run the official testpoint image using Podman (or Docker). Choose one of the two deployment modes:</p>
<ul>
<li>
<p>Option A: Testpoint only (simplest) — only bind-mount <code>/opt/perfsonar-tp/psconfig</code> for pSConfig.</p>
</li>
<li>
<p>Option B: Testpoint + Let’s Encrypt — two containers that share Apache files and certs via host bind mounts.</p>
</li>
</ul>
<p>Use <code>podman-compose</code> (or <code>docker-compose</code>) in the examples below.</p>
<h3 id="option-a-testpoint-only-simplest">Option A — Testpoint only (simplest)</h3>
<p>Prepare the pSConfig directory and a minimal compose file. No other host bind-mounts are required.</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/perfsonar-tp/psconfig
</code></pre></div>
<p>Download a ready-made compose file (or copy it manually): Browse: <a href="https://github.com/osghtc/networking/blob/master/docs/perfsonar/tools_scripts/docker-compose.testpoint.yml">repo
view</a></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/docker-compose.testpoint.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<p>Edit the <code>docker-compose.yml</code> as desired.</p>
<p>Bring it up:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span><span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp<span class="p">;</span><span class="w"> </span>podman-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="o">)</span>
</code></pre></div>
<p>Verify the container is running and healthy:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>ps
</code></pre></div>
<p>The container should show <code>healthy</code> status. The healthcheck monitors Apache HTTPS availability.</p>
<p>That's it for the testpoint-only mode. Manage pSConfig files under <code>/opt/perfsonar-tp/psconfig</code> on the host; they are
consumed by the container at <code>/etc/perfsonar/psconfig</code>. Jump to Step 6 below.</p>
<h4 id="ensure-containers-restart-automatically-on-reboot-systemd-unit-for-testpoint-required">Ensure containers restart automatically on reboot (systemd unit for testpoint - REQUIRED)</h4>
<div class="admonition warning">
<p class="admonition-title">podman-compose limitation with systemd containers</p>
</div>
<p>The perfSONAR testpoint image runs <strong>systemd internally</strong> and requires the <code>--systemd=always</code> flag to function
correctly. <strong>podman-compose does not support this flag</strong>, which causes containers to crash-loop after reboot with exit
code 255.</p>
<div class="codehilite"><pre><span></span><code>You **must** use the systemd unit approach below instead of relying on compose alone.
</code></pre></div>

<p>Install the provided systemd units to manage containers with proper systemd support:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install testpoint-only systemd unit</span>

/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp

<span class="c1"># Enable and start now</span>

systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service

<span class="c1"># Verify service and containers</span>

systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>--no-pager
podman<span class="w"> </span>ps
</code></pre></div>
<p>Notes:</p>
<ul>
<li>
<p>The service uses <code>podman run --systemd=always</code> to enable proper systemd operation inside the container</p>
</li>
<li>
<p>The compose file is kept for reference but not used by the systemd units</p>
</li>
<li>
<p>If you need to update container configuration, edit the systemd unit file directly: <code>/etc/systemd/system/perfsonar-testpoint.service</code></p>
</li>
<li>
<p>After editing the unit file, reload and restart: <code>systemctl daemon-reload &amp;&amp; systemctl restart perfsonar-testpoint.service</code></p>
</li>
</ul>
<hr />
<h3 id="option-b-testpoint-lets-encrypt-shared-apache-and-certs">Option B — Testpoint + Let's Encrypt (shared Apache and certs)</h3>
<p>This mode runs two containers (<code>perfsonar-testpoint</code> and <code>certbot</code>) and bind-mounts the following host paths so Apache
content and certificates persist on the host and are shared between containers:</p>
<ul>
<li>
<p><code>/opt/perfsonar-tp/psconfig</code> → <code>/etc/perfsonar/psconfig</code> — perfSONAR configuration</p>
</li>
<li>
<p><code>/var/www/html</code> → <code>/var/www/html</code> — Apache webroot (shared for HTTP-01 challenges)</p>
</li>
<li>
<p><code>/etc/apache2</code> → <code>/etc/apache2</code> — Apache configuration (for SSL certificate patching)</p>
</li>
<li>
<p><code>/etc/letsencrypt</code> → <code>/etc/letsencrypt</code> — Let's Encrypt certificates and state</p>
</li>
</ul>
<h4 id="1-seed-required-host-directories-required-before-first-compose-up">1) Seed required host directories (REQUIRED before first compose up)</h4>
<p><strong>Why seed?</strong> The perfsonar-testpoint container requires baseline configuration files from the image to be present on
the host filesystem. Without seeding, the bind-mounted directories would be empty, causing Apache and perfSONAR services
to fail.</p>
<p><strong>What's seeded:</strong></p>
<ul>
<li>
<p><code>/opt/perfsonar-tp/psconfig</code> — perfSONAR pSConfig files (baseline remotes and archives)</p>
</li>
<li>
<p><code>/var/www/html</code> — Apache webroot with index.html (required for healthcheck)</p>
</li>
<li>
<p><code>/etc/apache2</code> — Apache config including <code>sites-available/default-ssl.conf</code> (patched by entrypoint wrapper)</p>
</li>
</ul>
<p><strong>What's NOT seeded:</strong></p>
<ul>
<li><code>/etc/letsencrypt</code> — Certbot creates this automatically; no pre-seeding needed</li>
</ul>
<p>Run the bundled seeding helper script (automatically installed in Step 2):</p>
<div class="highlight"><pre><span></span><code>/opt/perfsonar-tp/tools_scripts/seed_testpoint_host_dirs.sh
</code></pre></div>
<p>This script:</p>
<ul>
<li>
<p>Pulls the latest perfSONAR testpoint image</p>
</li>
<li>
<p>Creates temporary containers to extract baseline files</p>
</li>
<li>
<p>Copies content to host directories</p>
</li>
<li>
<p>Verifies seeding was successful</p>
</li>
<li>
<p>Skips seeding if directories already have content (idempotent)</p>
</li>
</ul>
<p>Verify seeding succeeded:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Should show config files</span>

ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/psconfig

<span class="c1"># Should show index.html and perfsonar/ directory</span>

ls<span class="w"> </span>-la<span class="w"> </span>/var/www/html

<span class="c1"># Should show sites-available/, sites-enabled/, etc.</span>

ls<span class="w"> </span>-la<span class="w"> </span>/etc/apache2
</code></pre></div>
<details class="tip">
<summary>SELinux labeling handled automatically</summary>
</details>
<p>If SELinux is enforcing, the <code>:Z</code> and <code>:z</code> options in the compose files will cause Podman to relabel the host paths when
containers start. No manual <code>chcon</code> commands are required.</p>
<div class="codehilite"><pre><span></span><code>**SELinux Volume Labels:**
</code></pre></div>

<ul>
<li>
<p><code>:Z</code> (uppercase) - Exclusive access. Podman creates a unique SELinux label for this volume that only this specific container can access. Use for volumes that should not be shared between containers.</p>
</li>
<li>
<p><code>:z</code> (lowercase) - Shared access. Podman uses a shared SELinux label that multiple containers can access. Use for volumes that need to be accessed by multiple containers.</p>
<p>In our compose files:</p>
</li>
<li>
<p><code>/etc/letsencrypt:/etc/letsencrypt:Z</code> - Exclusive to testpoint container</p>
</li>
<li>
<p><code>/var/www/html:/var/www/html:z</code> - Shared between testpoint and certbot containers</p>
</li>
<li>
<p><code>/etc/apache2:/etc/apache2:Z</code> - Exclusive to testpoint container</p>
</li>
</ul>
<h4 id="2-deploy-the-testpoint-with-automatic-ssl-patching-recommended">2) Deploy the testpoint with automatic SSL patching (recommended)</h4>
<p><strong>Prerequisites:</strong> Ensure <code>/opt/perfsonar-tp/tools_scripts</code> exists from Step 2 (bootstrap):</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh
</code></pre></div>
<p>If the file is missing, run the Step 2 bootstrap first:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install_tools_scripts.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="p">|</span><span class="w"> </span>bash<span class="w"> </span>-s<span class="w"> </span>--<span class="w"> </span>/opt/perfsonar-tp
</code></pre></div>
<p>Deploy using the compose file with automatic Apache SSL certificate patching. This approach uses an entrypoint wrapper
that auto-discovers Let's Encrypt certificates on container startup and automatically patches the Apache configuration.</p>
<p>Download the auto-patching compose file:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/docker-compose.testpoint-le-auto.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<p><strong>Note:</strong> The <code>SERVER_FQDN</code> environment variable is <strong>optional</strong>. The entrypoint wrapper will auto-discover certificates
in <code>/etc/letsencrypt/live</code> and use the first one found. Only set <code>SERVER_FQDN</code> if you have multiple certificates and
need to specify which one to use.</p>
<p>If you want to explicitly set the FQDN (optional):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Optional: only needed if you have multiple certificates</span>

sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/# - SERVER_FQDN=.*/- SERVER_FQDN=&lt;YOUR_FQDN&gt;/&#39;</span><span class="w"> </span>/opt/perfsonar-tp/docker-compose.yml
</code></pre></div>
<p>Start the containers:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt/perfsonar-tp
podman-compose<span class="w"> </span>up<span class="w"> </span>-d
</code></pre></div>
<p>At this point, the testpoint is running with self-signed certificates. The certbot container is also running but won't
renew anything until you obtain the initial certificates.</p>
<h4 id="ensure-containers-restart-automatically-on-reboot-systemd-units-for-testpoint-certbot-required">Ensure containers restart automatically on reboot (systemd units for testpoint &amp; certbot - REQUIRED)</h4>
<div class="admonition warning">
<p class="admonition-title">podman-compose limitation with systemd containers</p>
</div>
<p>The perfSONAR testpoint image runs <strong>systemd internally</strong> and requires the <code>--systemd=always</code> flag to function
correctly. <strong>podman-compose does not support this flag</strong>, which causes containers to crash-loop after reboot with exit
code 255.</p>
<div class="codehilite"><pre><span></span><code>You **must** use the systemd unit approach below instead of relying on compose alone.
</code></pre></div>

<p>Install and enable the systemd units so containers start on boot with proper systemd support:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>/tmp/install-systemd-units.sh
chmod<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/tmp/install-systemd-units.sh

<span class="c1"># Install both testpoint and certbot systemd units</span>

/tmp/install-systemd-units.sh<span class="w"> </span>--install-dir<span class="w"> </span>/opt/perfsonar-tp<span class="w"> </span>--with-certbot

<span class="c1"># Enable and start services</span>

systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>perfsonar-certbot.service

<span class="c1"># Verify services</span>

systemctl<span class="w"> </span>status<span class="w"> </span>perfsonar-testpoint.service<span class="w"> </span>perfsonar-certbot.service<span class="w"> </span>--no-pager
podman<span class="w"> </span>ps
</code></pre></div>
<h4 id="3-obtain-your-first-lets-encrypt-certificate-one-time">3) Obtain your first Let's Encrypt certificate (one-time)</h4>
<p>Use Certbot in standalone mode to obtain the initial certificates. The perfsonar-testpoint image is patched to NOT
listen on port 80, so port 80 is available for Certbot's HTTP-01 challenge.</p>
<p><strong>Important:</strong> Stop the certbot sidecar temporarily to free port 80:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>stop<span class="w"> </span>certbot
</code></pre></div>
<p>Now run Certbot standalone with host networking to bind port 80:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--net<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/etc/letsencrypt:/etc/letsencrypt:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-v<span class="w"> </span>/var/www/html:/var/www/html:Z<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>docker.io/certbot/certbot:latest<span class="w"> </span>certonly<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--standalone<span class="w"> </span>--agree-tos<span class="w"> </span>--non-interactive<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span>&lt;SERVER_FQDN&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;ALT_FQDN&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-m<span class="w"> </span>&lt;LETSENCRYPT_EMAIL&gt;
</code></pre></div>
<details class="info">
<summary>Certbot command explained</summary>
<p><strong>Podman options:</strong></p>
</details>
<ul>
<li>
<p><code>--rm</code> - Remove container after it exits</p>
</li>
<li>
<p><code>--net=host</code> - Use host network (allows binding port 80)</p>
</li>
<li>
<p><code>-v /etc/letsencrypt:/etc/letsencrypt:Z</code> - Mount certificate storage with exclusive SELinux label</p>
</li>
<li>
<p><code>-v /var/www/html:/var/www/html:Z</code> - Mount webroot for HTTP-01 challenge</p>
<p><strong>Certbot options:</strong></p>
</li>
<li>
<p><code>certonly</code> - Obtain certificate only, don't install it</p>
</li>
<li>
<p><code>--standalone</code> - Run standalone HTTP server on port 80 for ACME HTTP-01 challenge</p>
</li>
<li>
<p><code>--agree-tos</code> - Agree to Let's Encrypt Terms of Service</p>
</li>
<li>
<p><code>--non-interactive</code> - Don't prompt for input (required for automation)</p>
</li>
<li>
<p><code>-d &lt;FQDN&gt;</code> - Domain name(s) for the certificate (repeat for each domain/SAN)</p>
</li>
<li>
<p><code>-m &lt;EMAIL&gt;</code> - Email for renewal notifications and account recovery</p>
</li>
</ul>
<p>Replace:</p>
<ul>
<li>
<p><code>&lt;SERVER_FQDN&gt;</code> with your primary hostname (e.g., <code>psum05.aglt2.org</code>)</p>
</li>
<li>
<p><code>&lt;ALT_FQDN&gt;</code> with additional FQDNs if needed (one <code>-d</code> flag per FQDN)</p>
</li>
<li>
<p><code>&lt;LETSENCRYPT_EMAIL&gt;</code> with your email for certificate notifications</p>
</li>
</ul>
<p>After successful issuance, restart the perfsonar-testpoint container to trigger the automatic patching:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>restart<span class="w"> </span>perfsonar-testpoint
</code></pre></div>
<p>Check the logs to verify the SSL config was patched:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>logs<span class="w"> </span>perfsonar-testpoint<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;Patching Apache&quot;</span>
</code></pre></div>
<p>You should see output confirming the certificate paths were updated.</p>
<h4 id="4-restart-the-certbot-sidecar-for-automatic-renewals">4) Restart the certbot sidecar for automatic renewals</h4>
<p>Now that certificates are in place, restart the certbot sidecar to enable automatic renewals:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>start<span class="w"> </span>certbot
</code></pre></div>
<p>The certbot container runs a renewal loop that checks for expiring certificates every 12 hours.</p>
<p><strong>Automatic Container Restart:</strong> After each successful certificate renewal, certbot automatically runs a deploy hook
script (<code>certbot-deploy-hook.sh</code>) that gracefully restarts the <code>perfsonar-testpoint</code> container. This ensures the new
certificates are loaded without manual intervention. The deploy hook uses the mounted Podman socket
(<code>/run/podman/podman.sock</code>) to communicate with the host's container runtime.</p>
<p><strong>Note:</strong> The certbot container in this setup uses <strong>host networking mode</strong> (via <code>network_mode: host</code> in the compose
file) so it can bind directly to port 80 for HTTP-01 challenges during renewals. This works because the perfsonar-
testpoint Apache is patched to NOT listen on port 80. Both containers share the host network namespace without conflict.</p>
<p>Test renewal with a dry-run:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>certbot<span class="w"> </span>certbot<span class="w"> </span>renew<span class="w"> </span>--dry-run
</code></pre></div>
<p>If successful, certificates will auto-renew before expiry, and the testpoint will be automatically restarted to load the
new certificates. You can verify this behavior by checking the certbot logs after a renewal:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span>logs<span class="w"> </span>certbot<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A5<span class="w"> </span><span class="s2">&quot;deploy hook&quot;</span>
</code></pre></div>
<hr />
<details class="info">
<summary>Alternative: Manual SSL Patching (without automatic entrypoint wrapper)</summary>
</details>
<p>If you prefer not to use the automatic patching entrypoint wrapper, you can use the standard compose file and manually
patch the Apache SSL configuration after obtaining certificates.</p>
<ol>
<li>
<p>Use <code>docker-compose.testpoint-le.yml</code> instead of <code>docker-compose.testpoint-le-auto.yml</code></p>
</li>
<li>
<p>After obtaining Let's Encrypt certificates, run:</p>
<p>```bash
/opt/perfsonar-tp/tools_scripts/patch_apache_ssl_for_letsencrypt.sh <SERVER_FQDN></p>
</li>
</ol>
<p>```</p>
<ol>
<li>
<p>Reload Apache in the running container:</p>
<p>```bash
podman exec perfsonar-testpoint apachectl -k graceful</p>
</li>
</ol>
<p>```</p>
<p>This approach requires manual intervention after initial certificate issuance and any time the container is recreated.
The automatic approach (using the entrypoint wrapper) eliminates this manual step.</p>
<details class="warning">
<summary>Troubleshooting: Container fails with 'executable file not found' error</summary>
</details>
<p><strong>Error:</strong> <code>Error: unable to start container: crun: executable file /opt/perfsonar-tp/tools_scripts/testpoint-
entrypoint-wrapper.sh not found</code></p>
<p><strong>Cause:</strong> The <code>/opt/perfsonar-tp/tools_scripts</code> directory doesn't exist or the entrypoint wrapper wasn't downloaded.</p>
<div class="codehilite"><pre><span></span><code><span class="o">**</span><span class="n">Fix</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">bootstrap</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">helper</span><span class="w"> </span><span class="n">scripts</span><span class="p">:</span>

<span class="err">```</span><span class="n">bash</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span>\
<span class="w">    </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">osg</span><span class="o">-</span><span class="n">htc</span><span class="o">/</span><span class="n">networking</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">install_tools_scripts</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span>\
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">bash</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code><span class="n">Then</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">entrypoint</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="n">exists</span><span class="p">:</span>

<span class="err">```</span><span class="n">bash</span>
<span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">testpoint</span><span class="o">-</span><span class="n">entrypoint</span><span class="o">-</span><span class="n">wrapper</span><span class="o">.</span><span class="n">sh</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code><span class="k">If</span><span class="w"> </span><span class="nv">you</span><span class="err">&#39;ve already started the container and it failed, remove it before retrying:</span>

<span class="err">```bash</span>
<span class="err">podman-compose down</span>
<span class="err">podman-compose up -d</span>
</code></pre></div>

<p>```</p>
<hr />
<h2 id="step-6-configure-and-enroll-in-psconfig">Step 6 – Configure and Enroll in pSConfig</h2>
<div class="admonition note">
<p class="admonition-title">Skip this step if you used the orchestrator (Path A)</p>
</div>
<p>The orchestrator automates pSConfig enrollment. If you ran it in Step 2, skip to <a href="#step-7-register-and-
configure-with-wlcgosg">Step 7</a>.</p>
<p>We need to enroll your testpoint with the OSG/WLCG pSConfig service so tests are auto-configured. Use the "auto URL" for
each FQDN you expose for perfSONAR (one or two depending on whether you split latency/throughput by hostname).</p>
<p>Basic enroll (interactive root on the host; runs inside the container) if you have only one entry to make (automation
alternative below):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Add auto URLs (configures archives too) and show configured remotes</span>

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>--configure-archives<span class="w"> </span>add<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;https://psconfig.opensciencegrid.org/pub/auto/ps-lat-example.my.edu&quot;</span>

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>list
</code></pre></div>
<p>If there are any stale/old/incorrect entries, you can remove them:</p>
<div class="highlight"><pre><span></span><code>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>delete<span class="w"> </span><span class="s2">&quot;&lt;old-url&gt;&quot;</span>
</code></pre></div>
<p>Automation tip: derive FQDNs from your configured IPs (PTR lookup) and enroll automatically. Review the list before
applying.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Dry run only (show planned URLs):</span>

/opt/perfsonar-tp/tools_scripts/perfSONAR-auto-enroll-psconfig.sh<span class="w"> </span>-n

<span class="c1"># Typical usage (podman):</span>

/opt/perfsonar-tp/tools_scripts/perfSONAR-auto-enroll-psconfig.sh<span class="w"> </span>-v

podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>perfsonar-testpoint<span class="w"> </span>psconfig<span class="w"> </span>remote<span class="w"> </span>list
</code></pre></div>
<details class="note">
<summary>The auto enroll script details</summary>
</details>
<ul>
<li>
<p>Parses IP lists from <code>/etc/perfSONAR-multi-nic-config.conf</code>  (<code>NIC_IPV4_ADDRS</code> / <code>NIC_IPV6_ADDRS</code>).</p>
</li>
<li>
<p>Performs reverse DNS lookups (getent/dig) to derive FQDNs.</p>
</li>
<li>
<p>Deduplicates while preserving discovery order.</p>
</li>
<li>
<p>Adds each <code>https://psconfig.opensciencegrid.org/pub/auto/&lt;FQDN&gt;</code> with <code>--configure-archives</code>.</p>
</li>
<li>
<p>Lists configured remotes and returns non-zero if any enrollment fails.</p>
</li>
</ul>
<p>Integrate into provisioning CI by running with <code>-n</code> (dry-run) for approval and then <code>-y</code> once approved.</p>
<hr />
<h2 id="step-7-register-and-configure-with-wlcgosg">Step 7 – Register and Configure with WLCG/OSG</h2>
<ol>
<li>
<p><strong>OSG/WLCG registration workflow:</strong></p>
<details class="info">
<summary>Registration steps and portals</summary>
</details>
</li>
<li>
<p>Register the host in <a href="https://topology.opensciencegrid.org/host">OSG topology</a>.</p>
</li>
<li>
<p>Create or update a <a href="https://ggus.eu/">GGUS</a> ticket announcing the new measurement point.</p>
</li>
<li>
<p>In <a href="https://goc.egi.eu/portal/">GOCDB</a>, add the service endpoint
                <code>org.opensciencegrid.crc.perfsonar-testpoint</code> bound to this host.</p>
</li>
<li>
<p><strong>Document memberships:</strong> update your site wiki or change log with assigned mesh names, feed  URLs, and support contacts.</p>
</li>
<li>
<p><strong>Update Lookup Service registration inside the container</strong></p>
</li>
</ol>
<p>Use the helper script to edit <code>/etc/perfsonar/lsregistrationdaemon.conf</code> inside the running <code>perfsonar-testpoint</code>
container and restart the daemon only if needed.</p>
<div class="codehilite"><pre><span></span><code><span class="n">Install</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">examples</span><span class="w"> </span><span class="n">below</span><span class="p">,</span><span class="w"> </span><span class="n">pick</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="w"> </span><span class="n">shell</span><span class="p">):</span>

<span class="err">```</span><span class="n">bash</span>
<span class="c1"># Preview changes only (uses the copy from /opt/perfsonar-tp/tools_scripts)</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">lsregistration</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">update</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">site</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;Acme Co.&quot;</span><span class="w"> </span><span class="o">--</span><span class="n">project</span><span class="w"> </span><span class="n">WLCG</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">email</span><span class="w"> </span><span class="n">admin</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="w"> </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;pS Admin&quot;</span>

<span class="c1"># Restore previously saved settings from the Prerequisites extract (if you saved a restore script earlier)</span>
<span class="n">bash</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">restore</span><span class="o">-</span><span class="n">lsreg</span><span class="o">.</span><span class="n">sh</span>

<span class="c1"># Apply new settings and restart the daemon inside the container</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">perfSONAR</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">lsregistration</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">create</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">site</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;Acme Co.&quot;</span><span class="w"> </span><span class="o">--</span><span class="n">domain</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="w"> </span><span class="o">--</span><span class="n">project</span><span class="w"> </span><span class="n">WLCG</span><span class="w"> </span><span class="o">--</span><span class="n">project</span><span class="w"> </span><span class="n">OSG</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">city</span><span class="w"> </span><span class="n">Berkeley</span><span class="w"> </span><span class="o">--</span><span class="n">region</span><span class="w"> </span><span class="n">CA</span><span class="w"> </span><span class="o">--</span><span class="n">country</span><span class="w"> </span><span class="n">US</span><span class="w"> </span><span class="o">--</span><span class="n">zip</span><span class="w"> </span><span class="mi">94720</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">latitude</span><span class="w"> </span><span class="mf">37.5</span><span class="w"> </span><span class="o">--</span><span class="n">longitude</span><span class="w"> </span><span class="o">-</span><span class="mf">121.7469</span><span class="w"> </span>\
<span class="w">    </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="s2">&quot;pS Admin&quot;</span><span class="w"> </span><span class="o">--</span><span class="n">admin</span><span class="o">-</span><span class="n">email</span><span class="w"> </span><span class="n">admin</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">org</span>
</code></pre></div>

<p>```</p>
<ol>
<li>
<p><strong>Automatic image updates and safe restarts</strong></p>
<p>Keep containers current and only restart them when their image actually changes.</p>
<details class="info">
<summary>Auto-update for compose-managed containers</summary>
</details>
</li>
</ol>
<p>Since these containers are managed by <code>podman-compose</code>, we use a different approach than systemd-managed containers.
Create a simple script and systemd timer to periodically pull new images and restart containers if updates are
available.</p>
<ol>
<li>Create an update script:<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="n">cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">&#39;EOF&#39;</span>
<span class="w">    </span><span class="c1">#!/bin/bash</span>
<span class="w">    </span><span class="c1"># perfsonar-auto-update.sh - Check for and apply container image updates</span>

<span class="w">    </span><span class="n">set</span><span class="w"> </span><span class="o">-</span><span class="n">e</span>

<span class="w">    </span><span class="n">COMPOSE_DIR</span><span class="o">=</span><span class="s2">&quot;/opt/perfsonar-tp&quot;</span>
<span class="w">    </span><span class="n">LOGFILE</span><span class="o">=</span><span class="s2">&quot;/var/log/perfsonar-auto-update.log&quot;</span>

<span class="w">    </span><span class="nb">log</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">echo</span><span class="w"> </span><span class="s2">&quot;$(date -Iseconds) $*&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="s2">&quot;$LOGFILE&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cd</span><span class="w"> </span><span class="s2">&quot;$COMPOSE_DIR&quot;</span>

<span class="w">    </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;Checking for image updates...&quot;</span>

<span class="w">    </span><span class="c1"># Pull latest images</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">podman</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="s2">&quot;$LOGFILE&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="s2">&quot;Downloaded newer image&quot;</span><span class="p">;</span><span class="w"> </span><span class="n">then</span>
<span class="w">        </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;New images found - recreating containers...&quot;</span>
<span class="w">        </span><span class="n">podman</span><span class="o">-</span><span class="n">compose</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">-</span><span class="n">d</span>
<span class="w">        </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;Containers updated successfully&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">log</span><span class="w"> </span><span class="s2">&quot;No updates available&quot;</span>
<span class="w">    </span><span class="n">fi</span>
<span class="w">    </span><span class="n">EOF</span>

<span class="w">    </span><span class="n">chmod</span><span class="w"> </span><span class="o">+</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">sh</span>
</code></pre></div>

</li>
</ol>
<p>```</p>
<ol>
<li>Create a systemd service:<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="n">cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="k">update</span><span class="p">.</span><span class="n">service</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">&#39;EOF&#39;</span>
<span class="w">    </span><span class="o">[</span><span class="n">Unit</span><span class="o">]</span>
<span class="w">    </span><span class="n">Description</span><span class="o">=</span><span class="n">perfSONAR</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="k">Update</span>
<span class="w">    </span><span class="k">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="p">.</span><span class="n">target</span>

<span class="w">    </span><span class="o">[</span><span class="n">Service</span><span class="o">]</span>
<span class="w">    </span><span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="w">    </span><span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="k">update</span><span class="p">.</span><span class="n">sh</span>

<span class="w">    </span><span class="o">[</span><span class="n">Install</span><span class="o">]</span>
<span class="w">    </span><span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="k">user</span><span class="p">.</span><span class="n">target</span>
<span class="w">    </span><span class="n">EOF</span>
</code></pre></div>

</li>
</ol>
<p>```</p>
<ol>
<li>Create a systemd timer (runs daily at 3 AM):<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="n">cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="k">update</span><span class="p">.</span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s1">&#39;EOF&#39;</span>
<span class="w">    </span><span class="o">[</span><span class="n">Unit</span><span class="o">]</span>
<span class="w">    </span><span class="n">Description</span><span class="o">=</span><span class="n">perfSONAR</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Auto</span><span class="o">-</span><span class="k">Update</span><span class="w"> </span><span class="n">Timer</span>

<span class="w">    </span><span class="o">[</span><span class="n">Timer</span><span class="o">]</span>
<span class="w">    </span><span class="n">OnCalendar</span><span class="o">=</span><span class="n">daily</span>
<span class="w">    </span><span class="n">RandomizedDelaySec</span><span class="o">=</span><span class="mi">1</span><span class="n">h</span>
<span class="w">    </span><span class="n">Persistent</span><span class="o">=</span><span class="k">true</span>

<span class="w">    </span><span class="o">[</span><span class="n">Install</span><span class="o">]</span>
<span class="w">    </span><span class="n">WantedBy</span><span class="o">=</span><span class="n">timers</span><span class="p">.</span><span class="n">target</span>
<span class="w">    </span><span class="n">EOF</span>
</code></pre></div>

</li>
</ol>
<p>```</p>
<ol>
<li>Enable and start the timer:<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="w">    </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">--</span><span class="n">now</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">timer</span>
</code></pre></div>

</li>
</ol>
<p>```</p>
<ol>
<li>Verify the timer is active:<div class="codehilite"><pre><span></span><code>    ```bash
    systemctl list-timers perfsonar-auto-update.timer
</code></pre></div>

</li>
</ol>
<p>```</p>
<ol>
<li>Test manually (optional):<div class="codehilite"><pre><span></span><code>    ```bash
    systemctl start perfsonar-auto-update.service
    journalctl -u perfsonar-auto-update.service -n 50
</code></pre></div>

</li>
</ol>
<p>```</p>
<ol>
<li>Monitor the update log:<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="err">```</span><span class="n">bash</span>
<span class="w">    </span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">log</span>
</code></pre></div>

</li>
</ol>
<p>```</p>
<p>This approach ensures containers are updated only when new images are available, minimizing unnecessary restarts while
keeping your deployment current.</p>
<hr />
<h2 id="step-8-post-install-validation">Step 8 – Post-Install Validation</h2>
<p>Perform these checks before handing the host over to operations:</p>
<ol>
<li>
<p><strong>System services:</strong></p>
<details class="info">
<summary>Verify Podman runtime and containers</summary>
<p>```bash</p>
<h1 id="check-podman-service-is-available">Check Podman service is available</h1>
<p>systemctl status podman</p>
<h1 id="verify-containers-are-managed-by-compose">Verify containers are managed by compose</h1>
<p>cd /opt/perfsonar-tp &amp;&amp; podman-compose ps</p>
<h1 id="alternative-check-containers-directly">Alternative: check containers directly</h1>
<p>podman ps --filter name=perfsonar</p>
</details>
</li>
</ol>
<p>```</p>
<div class="codehilite"><pre><span></span><code>Ensure Podman is active and containers are running.
</code></pre></div>

<ol>
<li>
<p><strong>Container health:</strong></p>
<details class="info">
<summary>Check container status and logs</summary>
<p>```bash</p>
<h1 id="check-all-containers-are-running-and-healthy">Check all containers are running and healthy</h1>
<p>podman ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'</p>
<h1 id="check-perfsonar-testpoint-logs-for-errors">Check perfsonar-testpoint logs for errors</h1>
<p>podman logs perfsonar-testpoint --tail 50</p>
<h1 id="if-using-lets-encrypt-check-certbot-logs">If using Let's Encrypt, check certbot logs</h1>
<p>podman logs certbot --tail 20 2&gt;/dev/null || echo "Certbot container not present (testpoint-only mode)"</p>
<h1 id="verify-services-inside-container-are-running">Verify services inside container are running</h1>
<p>podman exec perfsonar-testpoint systemctl status apache2 psconfig-pscheduler-agent --no-pager</p>
</details>
</li>
</ol>
<p>```</p>
<ol>
<li>
<p><strong>Network path validation:</strong></p>
<details class="info">
<summary>Test network connectivity and routing</summary>
<p>Test throughput to a remote testpoint (run from inside the container):</p>
<p>```bash
podman exec -it perfsonar-testpoint pscheduler task throughput --dest <remote-testpoint></p>
</details>
</li>
</ol>
<p>```</p>
<div class="codehilite"><pre><span></span><code>    Check routing from the host:

    ```bash
    tracepath -n &lt;remote-testpoint&gt;
    ip route get &lt;remote-testpoint-ip&gt;
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code>Confirm traffic uses the intended policy-based routes (check `ip route get &lt;dest&gt;`).
</code></pre></div>

<ol>
<li>
<p><strong>Security posture:</strong></p>
<details class="info">
<summary>Check firewall, fail2ban, and SELinux</summary>
<p>```bash</p>
<h1 id="check-nftables-firewall-rules">Check nftables firewall rules</h1>
<p>nft list ruleset | grep perfsonar</p>
<h1 id="check-fail2ban-status-if-installed-in-step-4">Check fail2ban status (if installed in Step 4)</h1>
<p>if command -v fail2ban-client &gt;/dev/null 2&gt;&1; then
    fail2ban-client status
else
    echo "fail2ban not installed (optional)"
fi</p>
<h1 id="check-for-recent-selinux-denials">Check for recent SELinux denials</h1>
<p>if command -v ausearch &gt;/dev/null 2&gt;&1; then
    ausearch --message AVC --just-one
elif [ -f /var/log/audit/audit.log ]; then
    grep -i "avc.*denied" /var/log/audit/audit.log | tail -5
else
    echo "SELinux audit tools not available"
fi</p>
</details>
</li>
</ol>
<p>```</p>
<div class="codehilite"><pre><span></span><code>Investigate any SELinux denials or repeated Fail2Ban bans.
</code></pre></div>

<ol>
<li>
<p><strong>LetsEncrypt certificate check:</strong></p>
<details class="info">
<summary>Verify certificate validity</summary>
<p>```bash</p>
<h1 id="check-certificate-via-https-connection">Check certificate via HTTPS connection</h1>
<p>echo | openssl s_client -connect <SERVER_FQDN>:443 -servername <SERVER_FQDN> 2&gt;/dev/null | openssl x509 -noout -dates -issuer</p>
<h1 id="alternative-check-certificate-files-directly">Alternative: Check certificate files directly</h1>
<p>sudo openssl x509 -in /etc/letsencrypt/live/<SERVER_FQDN>/cert.pem -noout -dates -issuer</p>
</details>
</li>
</ol>
<p>```</p>
<p>Ensure the issuer is Let's Encrypt and the validity period is acceptable. This check only applies if you configured
Let's Encrypt in Step 3.</p>
<ol>
<li><strong>Reporting:</strong></li>
</ol>
<p>??? info "Run perfSONAR diagnostic reports" Run the perfSONAR troubleshoot command from inside the container and send
outputs to operations:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span>```<span class="nv">bash</span>
<span class="w">    </span><span class="nv">podman</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="o">-</span><span class="nv">it</span><span class="w"> </span><span class="nv">perfsonar</span><span class="o">-</span><span class="nv">testpoint</span><span class="w"> </span><span class="nv">pscheduler</span><span class="w"> </span><span class="nv">troubleshoot</span>
</code></pre></div>

<p>```</p>
<hr />
<h2 id="ongoing-maintenance">Ongoing Maintenance</h2>
<ul>
<li>
<p><strong>Quarterly or as-needed:</strong> Re-validate routing policy and nftables rules after network changes or security audits.</p>
</li>
<li>
<p><strong>Monthly or during maintenance windows:</strong> Apply OS updates (<code>dnf update</code>) and reboot during scheduled downtime.</p>
</li>
<li>
<p>Monitor psconfig feeds for changes in mesh participation and test configuration.</p>
</li>
<li>
<p>Track certificate expiry with <code>certbot renew --dry-run</code> if you rely on Let's Encrypt (automatic renewal is configured but monitoring is recommended).</p>
</li>
<li>
<p>Review container logs periodically for errors: <code>podman logs perfsonar-testpoint</code> and <code>podman logs certbot</code>.</p>
</li>
<li>
<p>Verify auto-update timer is active: <code>systemctl list-timers perfsonar-auto-update.timer</code>.</p>
</li>
</ul>
<hr />
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="container-issues">Container Issues</h3>
<details class="failure">
<summary>Container won't start or exits immediately</summary>
<p><strong>Symptoms:</strong> <code>podman ps</code> shows no running containers, or container exits shortly after starting.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-container-logs">Check container logs</h1>
<p>podman logs perfsonar-testpoint</p>
<h1 id="check-for-systemd-initialization-errors">Check for systemd initialization errors</h1>
<p>podman logs perfsonar-testpoint 2&gt;&amp;1 | grep -i "failed|error"</p>
<h1 id="verify-compose-file-syntax">Verify compose file syntax</h1>
<p>cd /opt/perfsonar-tp
podman-compose config</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Common causes:**
</code></pre></div>

<ul>
<li>
<p>Missing entrypoint wrapper: Ensure <code>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh</code> exists</p>
</li>
<li>
<p>SELinux denials: Check <code>ausearch -m avc -ts recent</code> and consider temporarily setting to permissive mode for testing</p>
</li>
<li>
<p>Incorrect bind-mount paths: Verify all host directories exist and have correct permissions</p>
</li>
<li>
<p>Cgroup issues: Ensure <code>cgroupns: private</code> is set and no manual cgroup bind-mounts exist</p>
</li>
</ul>
<details class="failure">
<summary>Container won't start or exits immediately</summary>
<p><strong>Symptoms:</strong> <code>podman ps</code> shows no running containers, or container exits shortly after starting.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-container-logs_1">Check container logs</h1>
<p>podman logs perfsonar-testpoint</p>
<h1 id="check-for-systemd-initialization-errors_1">Check for systemd initialization errors</h1>
<p>podman logs perfsonar-testpoint 2&gt;&amp;1 | grep -i "failed|error"</p>
<h1 id="verify-compose-file-syntax_1">Verify compose file syntax</h1>
<p>cd /opt/perfsonar-tp
podman-compose config</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Common causes:**
</code></pre></div>

<ul>
<li>
<p>Missing entrypoint wrapper: Ensure <code>/opt/perfsonar-tp/tools_scripts/testpoint-entrypoint-wrapper.sh</code> exists</p>
</li>
<li>
<p>SELinux denials: Check <code>ausearch -m avc -ts recent</code> and consider temporarily setting to permissive mode for testing</p>
</li>
<li>
<p>Incorrect bind-mount paths: Verify all host directories exist and have correct permissions</p>
</li>
<li>
<p>Cgroup issues: Ensure <code>cgroupns: private</code> is set and no manual cgroup bind-mounts exist</p>
</li>
</ul>
<details class="failure">
<summary>Container crashes after reboot with exit code 255</summary>
</details>
<p><strong>Symptoms:</strong> Containers run fine when started manually but crash-loop after host reboot. Logs show repeated restarts
with exit code 255.</p>
<p><strong>Cause:</strong> The perfSONAR testpoint image runs systemd internally but podman-compose doesn't support the
<code>--systemd=always</code> flag required for proper systemd operation in containers.</p>
<div class="codehilite"><pre><span></span><code>**Diagnostic steps:**

```bash
<span class="gh">#</span> Check container status
podman ps -a

<span class="gh">#</span> Check systemd service status
systemctl status perfsonar-testpoint.service

<span class="gh">#</span> View recent container logs
podman logs perfsonar-testpoint --tail 100

<span class="gh">#</span> Check if using compose-based service (BAD)
grep -A5 &quot;ExecStart&quot; /etc/systemd/system/perfsonar-testpoint.service
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code><span class="o">**</span><span class="n">Solution</span><span class="p">:</span><span class="o">**</span>

<span class="n">Replace</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">compose</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">systemd</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">proper</span><span class="w"> </span><span class="n">systemd</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="err">`</span><span class="n">podman</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">systemd</span><span class="o">=</span><span class="n">always</span><span class="err">`</span><span class="p">:</span>

<span class="err">```</span><span class="n">bash</span>
<span class="c1"># Stop and disable old service</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">disable</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># Install new systemd units</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span>\
<span class="w">    </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">osg</span><span class="o">-</span><span class="n">htc</span><span class="o">/</span><span class="n">networking</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">/</span><span class="n">tools_scripts</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span>\
<span class="w">    </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span><span class="w"> </span><span class="mi">0755</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span>

<span class="c1"># For testpoint only:</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span>

<span class="c1"># For testpoint + certbot:</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">systemd</span><span class="o">-</span><span class="n">units</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">perfsonar</span><span class="o">-</span><span class="n">tp</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">certbot</span>

<span class="c1"># Enable and start</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">--</span><span class="n">now</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">testpoint</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># If using certbot:</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">--</span><span class="n">now</span><span class="w"> </span><span class="n">perfsonar</span><span class="o">-</span><span class="n">certbot</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># Verify containers are running</span>
<span class="n">podman</span><span class="w"> </span><span class="n">ps</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">kI</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span>
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code>**Verification:**

After installing the new units, the testpoint should:
</code></pre></div>

<ul>
<li>
<p>Start successfully on boot</p>
</li>
<li>
<p>Run systemd properly inside the container</p>
</li>
<li>
<p>Maintain state across reboots</p>
</li>
<li>
<p>Show "Up" status in <code>podman ps</code> (not "Exited" or crash-looping)</p>
</li>
</ul>
<details class="failure">
<summary>Certbot service fails with 'Unable to open config file' error</summary>
</details>
<p><strong>Symptoms:</strong> <code>perfsonar-certbot.service</code> fails immediately after starting with exit code 2. Logs show: <code>certbot: error:
Unable to open config file: trap exit TERM; while...</code></p>
<p><strong>Cause:</strong> The certbot container image has a built-in entrypoint that expects certbot commands directly. When using a
shell loop for renewal, the entrypoint tries to parse the shell command as a certbot config file, causing this error.</p>
<div class="codehilite"><pre><span></span><code>**Diagnostic steps:**

```bash
<span class="gh">#</span> Check certbot service status
systemctl status perfsonar-certbot.service

<span class="gh">#</span> View detailed logs
journalctl -u perfsonar-certbot.service -n 50

<span class="gh">#</span> Check for the error in logs
journalctl -u perfsonar-certbot.service | grep &quot;Unable to open config file&quot;

<span class="gh">#</span> Verify service file configuration
grep -A5 &quot;ExecStart&quot; /etc/systemd/system/perfsonar-certbot.service
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solution:**

The certbot service needs two flags:
</code></pre></div>

<ul>
<li>
<p><code>--systemd=always</code> for proper systemd integration and reboot persistence</p>
</li>
<li>
<p><code>--entrypoint=/bin/sh</code> to override the built-in entrypoint</p>
<p>Re-run the installation script to get the fixed version:</p>
<p>```bash</p>
<h1 id="stop-current-service">Stop current service</h1>
<p>systemctl stop perfsonar-certbot.service</p>
<h1 id="download-and-install-updated-systemd-units">Download and install updated systemd units</h1>
<p>curl -fsSL \
    https://raw.githubusercontent.com/osg-htc/networking/master/docs/perfsonar/tools_scripts/install-systemd-units.sh \
    -o /tmp/install-systemd-units.sh
chmod 0755 /tmp/install-systemd-units.sh</p>
<h1 id="install-with-certbot-support">Install with certbot support</h1>
<p>/tmp/install-systemd-units.sh --install-dir /opt/perfsonar-tp --with-certbot</p>
<h1 id="start-the-fixed-service">Start the fixed service</h1>
<p>systemctl daemon-reload
systemctl start perfsonar-certbot.service</p>
<h1 id="verify-its-running">Verify it's running</h1>
<p>systemctl status perfsonar-certbot.service
podman ps | grep certbot</p>
</li>
</ul>
<p>```</p>
<p><strong>Expected result:</strong> The certbot container should be running (not exiting) and the service should be in "active
(running)" state.</p>
<details class="failure">
<summary>SELinux denials blocking container operations</summary>
<p><strong>Symptoms:</strong> Container starts but services fail, permission denied errors in logs.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-for-recent-selinux-denials_1">Check for recent SELinux denials</h1>
<p>ausearch -m avc -ts recent</p>
<h1 id="temporarily-set-to-permissive-for-testing">Temporarily set to permissive for testing</h1>
<p>setenforce 0</p>
<h1 id="test-if-issue-resolves-then-check-audit-log">Test if issue resolves, then check audit log</h1>
<p>ausearch -m avc -ts recent &gt; /tmp/selinux-denials.txt</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solutions:**
</code></pre></div>

<ul>
<li>
<p>Verify volume labels are correct (<code>:Z</code> for exclusive, <code>:z</code> for shared)</p>
</li>
<li>
<p>Recreate containers to reapply SELinux labels: <code>podman-compose down &amp;&amp; podman-compose up -d</code></p>
</li>
<li>
<p>If persistent issues, consider creating custom SELinux policy or running in permissive mode</p>
</li>
</ul>
<h3 id="networking-issues">Networking Issues</h3>
<details class="failure">
<summary>Policy-based routing not working correctly</summary>
<p><strong>Symptoms:</strong> Traffic not using expected interfaces, routing to wrong gateway.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-routing-rules">Check routing rules</h1>
<p>ip rule show</p>
<h1 id="check-routing-tables">Check routing tables</h1>
<p>ip route show table all</p>
<h1 id="test-specific-route-lookup">Test specific route lookup</h1>
<p>ip route get <destination-ip></p>
<h1 id="check-networkmanager-connections">Check NetworkManager connections</h1>
<p>nmcli connection show</p>
<h1 id="review-pbr-script-log">Review PBR script log</h1>
<p>tail -100 /var/log/perfSONAR-multi-nic-config.log</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solutions:**
</code></pre></div>

<ul>
<li>
<p>Verify <code>/etc/perfSONAR-multi-nic-config.conf</code> has correct IPs and gateways</p>
</li>
<li>
<p>Reapply configuration: <code>/opt/perfsonar-tp/tools_scripts/perfSONAR-pbr-nm.sh --yes</code></p>
</li>
<li>
<p>Reboot if rules are not being applied correctly</p>
</li>
<li>
<p>Check for conflicting NetworkManager or systemd-networkd rules</p>
</li>
</ul>
<details class="failure">
<summary>DNS resolution failing for test endpoints</summary>
<p><strong>Symptoms:</strong> perfSONAR tests fail with "unknown host" or DNS errors.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="test-dns-resolution-from-container">Test DNS resolution from container</h1>
<p>podman exec -it perfsonar-testpoint dig <remote-testpoint></p>
<h1 id="check-containers-resolvconf">Check container's resolv.conf</h1>
<p>podman exec -it perfsonar-testpoint cat /etc/resolv.conf</p>
<h1 id="verify-forward-and-reverse-dns">Verify forward and reverse DNS</h1>
<p>/opt/perfsonar-tp/tools_scripts/check-perfsonar-dns.sh</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solutions:**
</code></pre></div>

<ul>
<li>
<p>Ensure DNS servers are correctly configured on host</p>
</li>
<li>
<p>Fix missing PTR records in DNS zones</p>
</li>
<li>
<p>Verify forward A/AAAA records match reverse PTR records</p>
</li>
</ul>
<h3 id="certificate-issues">Certificate Issues</h3>
<details class="failure">
<summary>Let's Encrypt certificate issuance fails</summary>
<p><strong>Symptoms:</strong> Certbot fails with "Failed to authenticate" or "Connection refused" errors.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-if-port-80-is-open">Check if port 80 is open</h1>
<p>nft list ruleset | grep "80"</p>
<h1 id="verify-apache-is-not-listening-on-port-80-in-container">Verify Apache is NOT listening on port 80 in container</h1>
<p>podman exec perfsonar-testpoint netstat -tlnp | grep :80</p>
<h1 id="test-port-80-accessibility-from-external-host">Test port 80 accessibility from external host</h1>
<p>curl -v http://<your-fqdn>/</p>
<h1 id="run-certbot-in-verbose-mode">Run certbot in verbose mode</h1>
<p>podman run --rm --net=host \
    -v /etc/letsencrypt:/etc/letsencrypt:Z \
    -v /var/www/html:/var/www/html:Z \
    docker.io/certbot/certbot:latest certonly \
    --standalone -d <SERVER_FQDN> -m <EMAIL> --dry-run -vvv</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Common causes:**
</code></pre></div>

<ul>
<li>
<p>Port 80 blocked by firewall: Add with <code>perfSONAR-install-nftables.sh --ports=80,443</code></p>
</li>
<li>
<p>Apache listening on port 80: Verify testpoint-entrypoint-wrapper.sh patched Apache correctly</p>
</li>
<li>
<p>DNS not propagated: Wait for DNS changes to propagate globally</p>
</li>
<li>
<p>Rate limiting: Let's Encrypt has rate limits; wait if you've hit them</p>
</li>
</ul>
<details class="failure">
<summary>Certificate not loaded after renewal</summary>
<p><strong>Symptoms:</strong> Old certificate still in use after automatic renewal.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-certificate-files">Check certificate files</h1>
<p>ls -la /etc/letsencrypt/live/<fqdn>/</p>
<h1 id="verify-deploy-hook-is-configured">Verify deploy hook is configured</h1>
<p>podman logs certbot 2&gt;&amp;1 | grep "deploy hook"</p>
<h1 id="check-if-container-restarted">Check if container restarted</h1>
<p>podman ps --format 'table {{.Names}}\t{{.Status}}'</p>
<h1 id="manually-restart-testpoint">Manually restart testpoint</h1>
<p>podman restart perfsonar-testpoint</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solutions:**
</code></pre></div>

<ul>
<li>
<p>Verify deploy hook script exists and is executable: <code>/opt/perfsonar-tp/tools_scripts/certbot-deploy-hook.sh</code></p>
</li>
<li>
<p>Ensure deploy hook is mounted in container at: <code>/etc/letsencrypt/renewal-hooks/deploy/certbot-deploy-hook.sh</code></p>
</li>
<li>
<p>Verify Podman socket is mounted in certbot container: <code>/run/podman/podman.sock</code></p>
</li>
<li>
<p>Check deploy hook logs: <code>journalctl -u perfsonar-certbot.service | grep deploy</code></p>
</li>
<li>
<p>Manually restart testpoint after renewals if deploy hook fails: <code>podman restart perfsonar-testpoint</code></p>
</li>
</ul>
<p><strong>Note:</strong> Certbot automatically executes scripts in <code>/etc/letsencrypt/renewal-hooks/deploy/</code> when certificates are
renewed. Do not use <code>--deploy-hook</code> parameter with full paths ending in <code>.sh</code> as certbot will append <code>-hook</code> to the
filename.</p>
<h3 id="perfsonar-service-issues">perfSONAR Service Issues</h3>
<details class="failure">
<summary>perfSONAR services not running</summary>
<p><strong>Symptoms:</strong> Web interface not accessible, tests not running.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-service-status-inside-container">Check service status inside container</h1>
<p>podman exec perfsonar-testpoint systemctl status apache2
podman exec perfsonar-testpoint systemctl status pscheduler-ticker
podman exec perfsonar-testpoint systemctl status owamp-server</p>
<h1 id="check-for-errors-in-service-logs">Check for errors in service logs</h1>
<p>podman exec perfsonar-testpoint journalctl -u apache2 -n 50
podman exec perfsonar-testpoint journalctl -u pscheduler-ticker -n 50</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solutions:**
</code></pre></div>

<ul>
<li>
<p>Restart services inside container: <code>podman exec perfsonar-testpoint systemctl restart apache2</code></p>
</li>
<li>
<p>Check Apache SSL configuration was patched correctly</p>
</li>
<li>
<p>Verify certificates are in place: <code>ls -la /etc/letsencrypt/live/</code></p>
</li>
<li>
<p>Restart container: <code>podman restart perfsonar-testpoint</code></p>
</li>
</ul>
<h3 id="auto-update-issues">Auto-Update Issues</h3>
<details class="failure">
<summary>Auto-update not working</summary>
<p><strong>Symptoms:</strong> Containers not updating despite new images available.</p>
<p><strong>Diagnostic steps:</strong></p>
<p>```bash</p>
<h1 id="check-timer-status">Check timer status</h1>
<p>systemctl status perfsonar-auto-update.timer
systemctl list-timers perfsonar-auto-update.timer</p>
<h1 id="check-service-logs">Check service logs</h1>
<p>journalctl -u perfsonar-auto-update.service -n 100</p>
<h1 id="check-update-log">Check update log</h1>
<p>tail -50 /var/log/perfsonar-auto-update.log</p>
<h1 id="manually-test-update">Manually test update</h1>
<p>systemctl start perfsonar-auto-update.service</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Solutions:**
</code></pre></div>

<ul>
<li>
<p>Enable timer if not active: <code>systemctl enable --now perfsonar-auto-update.timer</code></p>
</li>
<li>
<p>Verify script exists and is executable: <code>ls -la /usr/local/bin/perfsonar-auto-update.sh</code></p>
</li>
<li>
<p>Check podman-compose is installed and working</p>
</li>
<li>
<p>Review script for errors and update if needed</p>
</li>
</ul>
<h3 id="general-debugging-tips">General Debugging Tips</h3>
<details class="tip">
<summary>Useful debugging commands</summary>
<p><strong>Container management:</strong></p>
<p>```bash</p>
<h1 id="view-all-containers-running-and-stopped">View all containers (running and stopped)</h1>
<p>podman ps -a</p>
<h1 id="view-container-resource-usage">View container resource usage</h1>
<p>podman stats</p>
<h1 id="enter-container-for-interactive-debugging">Enter container for interactive debugging</h1>
<p>podman exec -it perfsonar-testpoint /bin/bash</p>
<h1 id="view-compose-configuration">View compose configuration</h1>
<p>cd /opt/perfsonar-tp &amp;&amp; podman-compose config</p>
</details>
<p>```</p>
<div class="codehilite"><pre><span></span><code>**Networking:**

```bash
<span class="gh">#</span> Check which process is listening on a port
ss -tlnp | grep &lt;port&gt;

<span class="gh">#</span> Test connectivity to remote testpoint
ping &lt;remote-ip&gt;
traceroute &lt;remote-ip&gt;

<span class="gh">#</span> Check nftables rules
nft list ruleset
</code></pre></div>

<p>```</p>
<div class="codehilite"><pre><span></span><code>**Logs:**

```bash
<span class="gh">#</span> System journal for container runtime
journalctl -u podman -n 100

<span class="gh">#</span> All logs from a container
podman logs perfsonar-testpoint --tail=100

<span class="gh">#</span> Follow logs in real-time
podman logs -f perfsonar-testpoint
</code></pre></div>

<p>```</p>
<hr />