version: "3.9"

services:
  # perfSONAR testpoint container
  testpoint:
    container_name: perfsonar-testpoint
    image: ghcr.io/perfsonar/testpoint:5.2.4-systemd
    network_mode: "host"
    cgroup: host
    environment:
      - TZ=UTC
    restart: unless-stopped
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      # Persist perfSONAR psconfig on the host
      - /opt/testpoint/psconfig:/etc/perfsonar/psconfig:Z
      # Share Apache configuration and webroot with the host
      - /etc/apache2:/etc/apache2:z
      - /var/www/html:/var/www/html:z
      # Share Let's Encrypt certs (optional; required if using certbot)
      - /etc/letsencrypt:/etc/letsencrypt:z
    tty: true
    pids_limit: 8192
    cap_add:
      - CAP_NET_RAW
    labels:
      - io.containers.autoupdate=registry

  # Optional: Letâ€™s Encrypt renewer sharing HTML and certs with testpoint
  certbot:
    image: certbot/certbot
    container_name: certbot
    network_mode: "host"
    restart: unless-stopped
    # Renew loop; for initial issuance, run a one-shot certbot command (see docs)
    entrypoint: ["/bin/sh","-c","trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;"]
    depends_on:
      - testpoint
    volumes:
      - /var/www/html:/var/www/html:z
      - /etc/letsencrypt:/etc/letsencrypt:z
    labels:
      - io.containers.autoupdate=registry
