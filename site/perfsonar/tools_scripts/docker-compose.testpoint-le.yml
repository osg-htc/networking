version: "3.9"

services:
  testpoint:
    container_name: perfsonar-testpoint
    image: hub.opensciencegrid.org/osg-htc/perfsonar-testpoint:production
    labels:
      - io.containers.autoupdate=registry
    network_mode: "host"
    cgroup: host
    environment:
      - TZ=UTC
    restart: unless-stopped
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /opt/perfsonar-tp/psconfig:/etc/perfsonar/psconfig:Z
      - /var/www/html:/var/www/html:z
      - /etc/apache2:/etc/apache2:z
      - /etc/letsencrypt:/etc/letsencrypt:z
    tty: true
    pids_limit: 8192
    cap_add:
      - CAP_NET_RAW
    healthcheck:
      test: ["CMD-SHELL", "curl -sfS http://localhost/ || curl -kSfS https://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  certbot:
    image: docker.io/certbot/certbot:latest
    container_name: certbot
    labels:
      - io.containers.autoupdate=registry
    # Use explicit port publishing to avoid host-network conflicts with the
    # testpoint container (which uses host networking). Bind host:container
    # ports so certbot can answer HTTP-01 challenges without sharing host
    # network namespace with the testpoint service.
    # Note: podman-compose will publish these ports on the host when using
    # the default network mode. Keep testpoint as host-networked as required
    # by that image.
    ports:
      - "80:80"
      - "8443:443"
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[c]ertbot' || exit 1"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 1m
    restart: unless-stopped
    entrypoint: ["/bin/sh","-c","trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;"]
    depends_on:
      - testpoint
    volumes:
      - /var/www/html:/var/www/html:Z
      - /etc/letsencrypt:/etc/letsencrypt:Z
