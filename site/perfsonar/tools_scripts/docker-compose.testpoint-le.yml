version: "3.9"

services:
  testpoint:
    container_name: perfsonar-testpoint
    image: hub.opensciencegrid.org/osg-htc/perfsonar-testpoint:production
    labels:
      - io.containers.autoupdate=registry
    network_mode: "host"
    privileged: true
    cgroupns: private
    environment:
      - TZ=UTC
    restart: unless-stopped
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    volumes:
      - /opt/perfsonar-tp/psconfig:/etc/perfsonar/psconfig:Z
      - /var/www/html:/var/www/html:z
      - /etc/apache2:/etc/apache2:z
      - /etc/letsencrypt:/etc/letsencrypt:z
    pids_limit: 8192
    cap_add:
      - CAP_NET_RAW
      - CAP_SYS_ADMIN
      - CAP_SYS_PTRACE
    healthcheck:
      test: ["CMD-SHELL", "curl -kSfS https://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  certbot:
    image: docker.io/certbot/certbot:latest
    container_name: certbot
    labels:
      - io.containers.autoupdate=registry
    # Use host networking so certbot can bind to port 80 for HTTP-01 challenges.
    # This works because the perfsonar-testpoint Apache is patched to NOT listen
    # on port 80, avoiding conflicts. Both containers share the host network
    # namespace without collision.
    network_mode: "host"
    # Mount the host's Podman socket to allow the deploy hook to restart containers
    volumes:
      - /run/podman/podman.sock:/run/podman/podman.sock:ro
      - /var/www/html:/var/www/html:Z
      - /etc/letsencrypt:/etc/letsencrypt:Z
      # Mount the deploy hook script into the container
      - ./tools_scripts/certbot-deploy-hook.sh:/etc/letsencrypt/renewal-hooks/deploy/certbot-deploy-hook.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[c]ertbot' || exit 1"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 1m
    restart: unless-stopped
    # The entrypoint now just runs 'certbot renew' in a loop.
    # The --deploy-hook will automatically run our script after successful renewals.
    entrypoint: >
      /bin/sh -c "
        trap exit TERM;
        while :; do
          certbot renew --deploy-hook /etc/letsencrypt/renewal-hooks/deploy/certbot-deploy-hook.sh;
          sleep 12h & wait $${!};
        done;
      "
    depends_on:
      - testpoint
